TODO: ファイル名を変更 SecurityGuideline4WebApplication

# 1. 入力検証及び不正入力時の無効化

悪意のあるユーザが不正な文字列を組み込むことで、本来アクセス権限のないデータを入手、改竄、破壊などユーザからの入力を出力画面に含む前に、適切なエスケー プや入力検証での確認をしない場合、脆弱になります。

## 1.1. インジェクション

SQLとOS、LDAPなどのインジェクション欠陥は、信頼されていないデータがコマンド又はクエリの一部として インタプリタに送信される際に発生します。攻撃者の悪意のあるデータは、意図しないコマンドの実行や適 切な権限のないデータアクセスをさせるように、インタプリタを騙すことができます。

### 1.1.1. SQLインジェクション
#### 脆弱性概要
SQLインジェクションは、データベースに渡され実行が行われる文字列に有害なコードを挿入する攻撃手法、またはその脆弱性の事を呼びます。
Webコンテンツ(Webサーバー)から接続しているデータベースに、管理者・開発者の意図しないSQL文を処理させる事でデータベースから情報の抜き取り、改ざんを行い、
コンテンツの改ざんやユーザー情報の漏洩を引き起こします。
アプリケーション側にて考慮すべき脆弱性です。

#### 例と対策
パラメータで渡される文字列に対してエスケープ処理を行わないまま、SQL文に連結しデータベースへアクセスする事で引き起こされます。
パラメータ中にSQL構文やSQL文で特殊な意味を持つ文字が含まれていないか調べ、含まれていた場合はこれを削除したり別の文字列に変換（エスケープ）するといった処理を組み込む必要があります。

##### 例
**脆弱性のあるコード例(PHP)**
```
$dbh = new PDO('mysql:host=127.0.0.1;dbname=test', 'username', 'password');

$userId = $_POST['userId'];
$password = $_POST['password'];
// ユーザー入力情報を利用して SQL文を作成
$sql = "SELECT * FROM ユーザマスタ WHERE ユーザID = '{$userId}' AND パスワード = '{$password}'";

$sth = $dbh->query($sql);
// ...
```

**引き起こされる例**
入力値が以下の場合
>$userId →
「 (何も入力しない) 」  
$password →
「'; DELETE FROM ユーザマスタ WHERE 'A' = 'A」

**実行されるSQL**
1. SELECT * FROM ユーザマスタ WHERE ユーザID = '' AND パスワード = '';
1. DELETE FROM ユーザマスタ WHERE 'A' = 'A'

##### 対策
###### 特殊文字のエスケープ
危険性のある文字列を検出し、適切に置換・削除を行うエスケープ処理(サニタイジング)を考慮する。

|特殊文字|エスケープ処理|
|:---:|:---:|
|'|"|
|;|受け付けない|
|その他の特殊文字	|エスケープ文字(\)を前に付加する|

###### バインド機構の使用
SQL文の組み立てにバインド機構(プレースホルダ)を使用する事により、入力データは数値定数や文字列定数として組み込まれるため、特殊文字は強制的にただのパラメータ文字として認識され、SQL文が改変される危険性がなくなる。  
また、入力前にコンパイルされているので、SQLインジェクションによってSQL文を変更することが不可能になる。

**プレースホルダを利用したコード例(PHP)**

```
// プリペアドステートメントのエミュレーションを無効する
$dbh->setAttribute(PDO::ATTR_EMULATE_PREPARES, false);

// MySQL ネイティブの静的プレースホルダを使用する
$sql = "SELECT * FROM ユーザマスタ WHERE ユーザID = ? AND パスワード = ?";
$sth = $dbh->prepare($sql); // プリペアドステートメントを準備
// ...
```

### 1.1.2. OSコマンドインジェクションの防御
#### 脆弱性概要
SQLインジェクションのOSコマント版とも言える脆弱性です。
Webサイトが閲覧者からのデータの入力受け付け、かつその情報をパラメータとしてOSをに対する命令文を実行する挙動を取っていた場合、
プログラムに与えるパラメータにOSに対する命令文を紛れ込ませて不正に操作する攻撃を指します。  
全ての閲覧者からの入力をエスケープする事は必須です。

#### 例
**脆弱性の原因となる関数例(PHP)**

``
exec(), passthru(), proc_open(), shell_exec(), system()
``

#### 対策
1. 外部プログラムを呼びださない設計を考慮しましょう
アプリケーションを設計する際に、外部プログラムを呼び出す事を避けた設計をしましょう。  
内部で外部プログラムを実施する事はリスクがある事を認識し、ライブラリ等を利用して解決する手法を模索しましょう。
1. サニタイジングを実施する。  
どうしても外部プログラムを使用する必要となった場合は、特殊文字をエスケープしましょう。  
bashの場合、以下の特殊記号は別のコマンドの実行に繋がる可能性が高いため、特に注意をしましょう。  
``
「;」「|」「&」「`」「(」「)」「$」「<」「>」「*」「?」「{」「}」「[」「]」「!」
``

### 1.1.3. ディレクトリトラバーサル
#### 脆弱性概要
webサイトがサーバ内のファイルを表示する際に、管理者が意図していないパスが指定されることによって、想定外のファイルが閲覧できてしまう状態を指します。  
ファイル名としてユーザーが任意に変更する事ができる値( GET/POSTパラメータやcookie値など )を利用する箇所で発生する可能性があります。

#### 例
**脆弱性のあるコード例(PHP)**  
- 日本語/英語/中国語の３ヶ国語に対応したwebサイト
    - 全てのページは３ヶ国語のテンプレート(JAPANESE.html, ENGLISH.html, FRANCH.html )が予め準備されている
    - 選択された言語のテンプレートファイル名をcookie["TEMPLATE"]に保持する
    - コンテンツ内では選択された言語にテンプレートファイルを表示する

```
<?php
$template = 'JAPANESE.html';
if ( is_set( $_COOKIE['TEMPLATE'] ) )
   $template = $_COOKIE['TEMPLATE'];
include ( "/var/www/templates/" . $template );
?>
```

**このシステムに対する攻撃例**  
```
GET /xxx.php HTTP/1.0
Cookie: TEMPLATE=../../../../../../../../../etc/passwd
```

**生成されるサーバのレスポンス**
```
HTTP/1.0 200 OK
Content-Type: text/html
Server: Apache

// 以下 /etc/passwd が応答結果に出力される
root:x:0:0:root:/root:/bin/bash
bin:x:1:1:bin:/bin:/sbin/nologin
daemon:x:2:2:daemon:/sbin:/sbin/nologin
// …
```

#### 対策
1. 外部からファイル名を要求する仕様を避けましょう。
1. 避けられない場合は、パラメータからディレクトリ名を取り除きファイル名のみを抽出する考慮をしましょう。
1. includeするファイルはプログラム内で、許可してないところにアクセスしてないかチェックしましょう。
1. アクセス権限は公開用ディレクトリとそれ以外で分け、公開するディレクトリ以外の箇所はアクセス権限を強固にしましょう。

### 1.1.4. HTTPレスポンス分割の防御

### 1.1.5. メールヘッダインジェクションの防御

### 1.1.6. 不正ファイルアップロードの防御

### 1.1.7. 改竄防御

## 1.2. クロスサイトスクリプト(XSS)

XSS欠陥は、アプリケーションが信頼されていないデータを受け取る時、適切な検証やエスケープをせずに、 ウェブブラウザに送信する際に発生します。XSSにより、攻撃者は被害者のブラウザでスクリプトを実行で き、ユーザセッションのハイジャックやウェブサイトの改竄、またユーザを悪意のあるサイトにリダイレクトす ることが可能です。

# 2. セッション管理と認証の不備

認証とセッション管理に関連するアプリケーション機能は、しばしば正しく実装されていません。そのため、 攻撃者はパスワード又は鍵、セッショントークンを漏洩させたり、他の実装の不備を悪用してなりすますこ とができます。

## 2.1. セッション管理

セッション管理にあたってはセッションハイジャック対策を実施すること

## 2.2. 認証と承認

なりすましや管理者権限の不正取得などができないよう、適切な措置を講ずること。

# 3. クロスサイトフォージェリー(CSRF)

CSRF攻撃は、脆弱性のあるWebアプリケーションに対し、ログオンしている被害者のブラウザから、偽造さ れたHTTPリクエストを送信させます。そのリクエストには、被害者のセッションクッキーや他の自動的に組 み込まれた認証情報が含まれています。これにより、攻撃者は脆弱性のあるアプリケーションに、ユーザ からの正当なリクエストとして認識されるリクエス トを被害者のブラウザに生成させることができます。

# 4. 安全でないオブジェクト 直接参照

オブジェクトの直接参照は、開発者がファイル又はディレクトリ、データベースのキーなど、内部に実装され ているオブジェクトへの参照を公開する際に発生します。アクセス制御チェックや他の保護が無ければ、攻 撃者はこれらの参照を用い、アクセス権限のないデータへアクセスすることができます。

# 5. セキュリティ 設定のミス

適切なセキュリティには、アプリケーション、フレームワーク、アプリケーションサーバ、Webサーバ、データ ベースサーバ、およびプラットフォームに対して、セキュアな設定を定義して反映させる事が必要です。製 品のデフォルト設定は安全ではない場合が多いため、セキュアな設定が定義・実装・維持されないといけ ません。また、ソフトウェアを最新の状態に保つ必要があり ます。

# 6. 機密データの露出

## 6.1 脆弱性概要

機密データを暗号化していないこと、また弱いアルゴリズムによるパスワードハッシュなどで発生する脆弱性となります。
攻撃者は通常暗号化を直接破ることはせず、サーバやユーザのブラウザから転送中の平文を盗みます。万一のデータ流出時にもデータ内容を解読、悪用されないよう対策を講じ、また、機密データの誤った公開や意図しないファイルの流出を抑止するための対策が必要となります。

## 6.2 対策

## 6.2.1. サイトのSSL化

ログインやお客様情報といった認証を必要とする画面は、SSLを使用すること。

## 6.2.2. 機密データの暗号化

機密データを盗聴や盗難から守り、万一のデータ流出時にもデータ内容を解読、悪用されないよう以下の対策を実施すること

* パスワードや個人情報を暗号化すること
 * 暗号化のアルゴリズムはどうするか

## 6.2.3. 公開ディレクトリへの配置

ログファイル、バックアップファイル、設定ファイルなど公開を前提としたファイルは、公開ディレクトリ上に配置しない。また、HTTPサーバーのディレクトリスティングは無効にする。

## 6.2.4. 通信時のデータ保護

機密情報をクエリストリングに含めないこと、また重要情報のURLは規則性を持たせず不規則な英数字や記号を交えた長い文字列にすることで難読化を行なう。

# 7. 機能レベル アクセス制御の欠落

ネットワークアクセス可能なシステムであれば誰でもリクエスト送信出来るため、適切な権限設定を行ないます。また、非公開機能を利用出来ないように制御を行ないます。

* 権限の適切な設定を行なう
* デフォルトはアクセス拒否し、相応なロールを要求する


# 8. 既知の脆弱性を持つコンポーネント の使用

ライブラリ、フレームワーク、および他のソフトウェアモジュールなどのコンポーネントは、ほとんど常にフル 権限で実行されます。脆弱なコンポーネントが悪用される場合、深刻なデータ損失やサーバ乗っ取りまで に至る攻撃ができます。既知の脆弱性を持つコンポーネントを使用するアプリケーションは、アプリケー ションの防御を弱体化し、様々な攻撃と影響も可能になります。

* 定期的にバージョンアップさせる
* 脆弱性情報を拾う仕組み

# 9. 未検証のリダイレクトとフォワード

# 9.1. 脆弱性概要

Webアプリケーションは、頻繁にユーザを他の画面やウェブサイトへリダイレクト・フォーワードしますが、信頼されていないデータを用いて、転送先画面を決定しています。適切な検証がないと、攻撃者は被害者を フィッシングサイトやマルウェアサイトへリダイレクトできたり、フォーワードで閲覧権限のない画面へアクセ スできます。

![未検証のリダイレクト事故例](./images/UnverifiedRedirect.png)

※過去、medibaで未検証のリダイレクトを許容するリダイレクトサーバーの脆弱性があった

# 9.2. 対策

* 単なるリダイレクトやフォワードの使用は行わない
* 遷移先をホワイトリスト化、もしくはルール化しチェックする


# 検討項目

* 管理画面の操作ログは最低半年くらい残す
* アクセスログは最低3ヶ月くらい残す
* 無駄なポートはあけるな
* 踏み台は作り直sshはしない
* 共通アカウントは使用せずに各自に発行
  * システムもCMSもサービスも
* UIDは暗号化すること
  * 生のUIDはログに落とすな
  * 暗号化方式は軍司さんに相談　可逆的なものでもいいのか
* セキュリティチェックリストを準拠せよ
* DBのrootは使うな
* ZAPをかませ
* 本番データを扱う管理システムはログイン方式にしなさい

... 続く
