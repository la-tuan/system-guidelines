#+medibaシステムガイドライン
##+β版の扱い||現バージョンは不足している内容やわかりにくい表現が含まれているためβ版としての扱いになりますが、ガイドラインとして本運用していくため原則ガイドラインに沿った開発、運用を行なって下さい。|加筆修正、追加事項、課題は、issueへ追加、または修正のpull+requestをお願いします。||本ガイドラインは全開発者を対象としているため、初歩的なレベルの内容も含みますが、開発に関わるすべての人は一読願います。||なお、本ガイドラインを基にKDDIに対してmedibaの取り組みとして展開し、KDDIからの対応を最小限にしていくためにも活用していく予定です。
##+本ガイドラインの歩き方||本ガイドラインは、IPA、OWASP、mediba品質チェックリスト、KDDI要求事項(セキュリティ関連のチェックリスト)などを参考にまとめたものとなっており、現在アプリケーション開発において開発者が考えて然るべき内容のため、開発に関わる全エンジニアは一読お願いします。|また、規定ではなくガイドラインのためガイドラインの遵守に対して罰則はありませんが、関わるシステム開発に必要な要素を参考にして適用して下さい。|個人情報の取扱などで遵守すべき事項は開発規定+_*1_+へ反映させていきます。||-+medibaでは本ガイドラインに沿った開発を前提とするため、必ず一通り読むこと|+++-+何が書かれていて、どのようなことにケアすべきかを確認する|+++-+medibaでの過去の事例から得たナレッジを把握する|+++-+IPA、OWASP、もしくはKDDIが定めている遵守すべき事項を理解する|-+新規開発、大規模改修など開発方針としてチーム内で確認する|+++-+特に個人情報の扱い、セキュリティ関連は原則ガイドラインに従う|+++-+設計前やリリース前に考慮漏れがないかチェック項目として活用する|-+本ガイドラインは適宜内容を更新していくため、更新内容は必ず確認する||_*1+開発規定とは、会社で定めている開発関する遵守すべき条項_
##+はじめに|medibaは、当社のサービスが社会に与える影響を重要視しており、そのサービスを支えるシステムは、安全で、高品質なものを提供することがシステムに携わる人の責務です。||このガイドラインでは、medibaにおいて、システム開発・運用をする上で、システムに携わる皆さんに理解していただき、守っていただきたい事項を定めます。|ここに述べられている項目以外でも、システムに携わる皆さんは、常日頃から様々な情報に触れ、技術や能力の向上と、品質の維持に努めてください。
##+開発する前に考慮するべき事項
###+品質管理プロセスの遵守||過去の障害事例から得たナレッジで品質管理プロセスが成り立っています。|各チェック項目、レビュー、承認の遵守をお願いします。
###+機能の共有||-+提供していく機能や画面が関係者間で認識齟齬が発生しないように管理すること|++-+ログイン有無、キャッシュ有無、URL、APIエンドポイントなどを明記する|++-+アドや計測タグなどの利用を明らかにする|++-+特定のユーザーのみに提供する機能や出し分けがあれば明記する|-+作成されたドキュメントは適切にアップデートを行ない、改修の際に漏れが発生しないようにすること
###+性能要件とアーキテクチャ||-+満たすべきレスポンス、パフォーマンスを事前に想定する|-+原則、DBアクセスを極力少なくするような仕組みとすること。+（キャッシュを最大限活用＆キャッシュの冗長構成）|-+今後のアクセス増、データボリューム増を考慮したスケーラビリティを検討すること。(スケールアップ、スケールアウト)|-+Disaster+Recovery(災害対策)を考慮したシステム構成を検討すること。|-+バーストした際の対応、バーストしないための予防策について検討すること。|-+DBはサービス規模や仕様などにより用途を分け、最適な構成を検討すること。|-+サービスをクローズする場合も考慮してアーキテクチャを検討しているか。
###+移行要件の可否||-+移行データの有無、移行ツールの作成要否、移行時のシステム停止、データ整備の有無など、設計・開発のスケジュール・工数にインパクトのある内容、切替時に留意しなければいけない移行要件がないかを確認しておくこと
###+取り扱うサービスの要件||-+個人情報の取り扱い有無、決済・ポイント関連機能の有無|++++``+本来はセキュリティレビュー組織体を用意して、個別にワークフローを設けるべき+``
###+ソースコードマネジメント||-+プロダクト資産は、github(Organizationで契約中)のプライベートリポジトリで管理すること|-+原則GitHub+Flowやgit-flowを利用するが、PJ規模やリリースサイクルなどによってチームで最適化していき、どういうフローで回っているかはREADMEで明文化しチーム共通認識として持つ
##+日常的に注意する事項
###+パスワードの強度||-+トークンや、公開鍵認証など、多要素認証を受け入れるシステムは、積極的に使用|-+パスワードは、「英単語」＋「記号+or+数字」＋「システム識別子」で作成すると長いものでも覚えやすい
###+利用するアプリケーション||-+ChromeやFirefoxのアプリは脆弱性を埋め込まれる可能性が高いため、利用には十分の注意を払う|-+Adobe製品やOffice製品は脆弱性を仕込まれることが多いため、アップデートは必須
###+その他注意事項||-+メールにあるリンクのクリック、添付ファイルを実行する際は極力注意すること|++++-+送られてきた人のメールアドレスを注意深く読み解く|++++-+普段のメールの文言や職務タイトルと異なる場合などは注意|-+オフィス以外で業務をする場合は、|+-+端末を外部に持ち出す場合は持ち出し用端末を利用すること|+-+端末を常に持ちあるくこと（トイレも携行）|+-+パスワード付きスクリーンセーバーにすること|+-+WiFiへの接続の際は、信頼できる業者のものを利用すること（有料がベター）
##+開発前に読むべきもの||-+[IPA+安全なウェブサイトの作り方](https://www.ipa.go.jp/security/vuln/websecurity.html)|-+[IPA+セキュリティ・プログラミング講座](https://www.ipa.go.jp/security/awareness/vendor/programmingv2/index.html)|-+[セキュリティチェックリスト](SecurityCheckList.md)
##+業務別ガイドライン||-+[アプリケーション開発ガイドライン](AppDeveloperGuideline.md)|-+[AWSインフラストラクチャーガイドライン](AWSInfraBuildGuideline.md)|-+[セキュリティガイドライン](SecurityGuideline.md)|-+[テストガイドライン](TestGuideline.md)|-+[アプリケーションログガイドライン](AppLogGuideline.md)|-+[リリースガイドライン](ReleaseGuideline.md)|-+[システム運用ガイドライン](OpsGuideline.md)|-+[外注開発ガイドライン](OutsouceDevelopmentGuideline.md)
#+アプリケーション開発ガイドライン
##+1.+はじめに|このガイドラインでは、medibaにおける、アプリケーション開発についてのガイドラインを下記の大項目に分け、それぞれ定めます。||*+一般的なアプリケーションの作り方|*+サーバサイドアプリケーション（API）|*+フロントエンドアプリケーション|*+スマートフォンアプリケーション|*+個人情報を取り扱う社内アプリケーション
#####+参考にするべきドキュメント|このガイドラインで述べることの一部、特にセキュリティに関連する事項については、以下のドキュメントを参考に作られています。|非常に有用な情報が記載されているので、開発者は自分の領域にかかわらず、必ず目を通しておいてください。||*+[OWASP+Top+10:+Ja](https://www.owasp.org/images/7/79/OWASP_Top_10_2013_JPN.pdf)|*+[OWASP+Mobile+Security+Project:+En](https://www.owasp.org/index.php/OWASP_Mobile_Security_Project)
##+2.+プログラム時の共通注意事項|-+変数の初期化漏れ、初期化タイミングの不備はないか|++>+1つ前のリクエスト内容が、変数が初期化されず、引きずられたままになっているなど||-+ループ処理で1件ずつ処理するような機能は要注意|++>+メール送信機能での宛先、件名、本文など|-+環境依存となるハードコーディングがされていないこと|++>+環境依存となるものはconfigで定義する作りにすること||-+本来の目的と違う目的で、データ項目や変数を流用していないか|-+auIDのログイン済み判定を行う場合、cookieにVTKTが存在することで判断するのではなく、cookieのVTKTの値を使ってcoDeisyに認証確認を行っていること|-+ソースコードとセットでテストコードも準備できているか|-+既存ロジックの改修や削除を実施する場合、今回の改修箇所以外の部分のデグレに注意すること|++>+ロジックが複雑で机上検証での担保が困難な場合は、既存機能の正常ケースをテストケースとして折り込むこと||-+ネストが深くなる場合は、関数化を検討すること|-+変数名には極力意味を持たせ、無意味な名称の一時的な変数は極力使用しないこと|-+空文字判定処理に注意すること|++>+PHPの場合はemptyを使用するなど||-+グローバル変数は極力使用しないこと
##+3.+一般的なアプリケーションの作り方
###+3.1+ユーザ管理||-+個人情報の取扱い、決済処理を行う場合は、必ずSSLで通信すること|-+SSLを利用する場合、アプリケーションにおけるリソースの取得に、HTTPとHTTPS両方を用いないように実装すること
####+3.1.1+登録|-+プライバシーポリシーに同意させる画面遷移を作成すること|-+DB上でユーザを一意に特定できるIDを必ず用意すること|-+パスワードは一方向ハッシュを利用する|+>+ハッシュの計算においてSaltを使用し、同一のパスワードであっても別の値になるよう実装すること|-+パスワード作成のためのハッシュ関数は、*bcrypt*+を推奨する|-+ボットなどによる、機械的なアカウント作成やアクセスに対しては、サービスの性質に応じてCAPTCHAなどによる対策を実装すること
####+3.1.2+削除|-+論理削除の場合は、プライバシーポリシーにのっとり、適切に削除すること（不要な情報のマスキング、属性情報の削除など）
####+3.1.3+ログイン|-+同一IDに対しての複数回ログイン試行に対し、原則としてアカウントロックするなどの対策を実装することを推奨する(5回以上を目安）|++>+ロック後は一定期間ロックアウトするか、システムの重要度によってパスワード再発行の処理を組み込むこと
###+3.2+個人に属する情報の取扱い|-+Geoデータ、顔写真は個人情報と同等の管理を要する
###+3.3+課金に関する取扱
####+3.3.1+決済|-+auサービスは、auかんたん決済を原則利用すること|++>+*auかんたん決済以外は必要に応じて定義していきます*
####+3.3.2+クレジットカード|-+原則としてmedibaではカード番号を保管しない|-+カード番号を平文のまま保管しないこと|-+アクセスログに記録されないよう、POSTメソッドで送信すること|-+カード番号の先頭6桁および末尾4桁については保存可とする
####+3.3.3+セキュリティ|-+セキュリティルームからのみ商用環境へ接続可能とする|++>+もしくは、許可された者が特定の端末を用いてのみ接続可能とする|-+品質管理部による承認を得てのみリリース可能とする|++>+開発に関わるすべてのレビューで承認を得ること|-+個人情報及び決済情報は、コンテンツなどと別のデータベースで管理すること
###+3.4+ポイントの取扱い|-+ポイントには仮付与、確定付与、取り消しと複数の状態があるため、状態に応じたポイント処理が実行されるよう考慮して設計を行うこと|-+ポイントには通貨価値があるため課金システムと同等のセキュリティを担保すること
###+3.5+エラーハンドリング|*+画面表示|++-+予期せぬ例外（接続エラー、データ不整合など）が起こった際にも適切なエラー画面の表示が行われるよう配慮すること|++-+条件分岐においてdefaultやelseの値を定義すること|++-+PHPの場合、try/catchを利用すること|*+タイムアウトの設定|++*+対向システムとの接続や、バッチ等のデータ処理にはタイムアウトを設定し、超えた場合はエラー処理を行うこと|++*+タイムアウト設定値は、対向システムやミドルウェアとの整合性が取れた値で設定すること|*+ログの出力|++*++ERROR/WARNING時にログが出力されるよう設定すること|++*+ログの出力項目についてはログガイドラインを参照|*+監視設定|++*+全てのサービスは原則として監視システムと連携を行うこと|++*+監視の設定には、アラートレベルを適切に設定すること
###+3.6+セッションの取扱い|-+セッション管理は原則としてDBを利用すること|-+セッションIDはフレームワークに付随している生成ロジックを利用するか、独自に実装する場合は、容易に推測できないよう実装し、利用すること
###+3.7+キャッシュの扱い|-+すべてのリクエストに対してキャッシュ有無を明確にし影響範囲を把握すること|++>+cache-controlを設定していない場合、ブラウザに依存するため意図しない挙動が起きうる|-+必ずexpireを設定すること|-+どのレイヤーで何がいつまでキャッシュされるか明確化し設計すること
###+3.8+Cookieの取扱い|サービス毎(もしくはドメイン毎)にCookie管理を行ない、下記の通り取扱いを注意すること。||-+保存に関する注意|++-+個人情報や、個人に属する情報は保存しないこと|++-+同一Cookieに、4KB以上のデータは保管しないこと|++-+expireを必ず設定すること(永続的な期間設定はしない)|-+発行に関する注意|++-+Cookie名は同じものを流用すると思わぬ弊害が出るため必ず確認すること|++-+auone.jp及びauone.jpサブドメインにおけるCookieの使用については、必要に応じてKDDIにも確認すること
###+3.9+タグの扱い||以下のようなタグは意図しない動作を引き起こす可能性があるため、管理し影響範囲を把握しておく必要があります。||-+広告タグ|-+計測タグ|-+ワンタグ
##+4.+サーバサイドアプリケーション（API）開発|API（主にRESTFul）を開発する上で留意していただきたい項目を、以下に述べます。
###+4.1+APIをコールするときの認証方法|-+APIが特定のサーバからのみリクエストを受け付けたい場合は、トークンベースでの認証を用いる|-+発行されるトークンは、サービスごとに異なるようにすること|-+トークンは、HTTPヘッダに載せ、HTTPSで通信すること
###+4.2+リクエストを正しくハンドリングする方法|-+ユーザからのリクエストは想定外なものが来る、という想定でいること|-+バリデーションは処理の前段階で行うこと|-+リクエストされたものを、そのままDBに格納せず、（加工しない）格納したくないものはエラーとして拒否すること
###+4.3+データベースとの連携|-+DBの接続パスワードはソースコードにハードコーディングしないこと|-+環境変数からコールすること|-+特別な要件がない限り、ローカルのネットワークを利用すること
####+4.3.1+RMDBを利用する場合|-+EXPLAINを利用し、パフォーマンス最適化を実施すること|-+必ずprepareステートメントを利用し、直接DBに値を渡さないこと
####+4.3.2+KVSを利用する場合|-+EXPIRE値が適切に設定されていること|-+振り分け先設定の指定とweightの設定がなされていること|++-+yiiのcacheにおけるservers設定で、weightの設定が適切になされていること|-+原則、Key値はhash化による自動生成ではなく、Prefix指定とすること|++-+hashKey+:+false|++-+keyPrefix+:+プロジェクト固定(最大文字列長の制約などhash化が必要な場合を除く(hash化のメリットとのトレードオフ))
###+4.4+安全なデバッグの方法|前提として：|-+商用環境でデバッグコードが動作しないこと|-+不要なデバック用のコードやコメントなど商用環境に相応しくないコメントは削除されていること||という約束事があります。||安全にデバッグするためには、|-+プログラム標準のログレベルを利用するか、デバッグログ専用の関数を用意し、ログレベル同様のフラグ判定関数を設ける|-+ログレベルに応じて、出力するログの内容を選択する|-+ログレベル自体は、httpdの環境変数に依存するようにする||としてください。
###+4.5+可用性の維持|-+複数台でAPIを運用することを想定した設計にすること|++-+ローカルディスクに共有データを書き込まないこと
###+4.6+APIが出力するログについて|-+AWSを想定し、ログはサーバ名、タイムスタンプなどを明記すること|-+ログレベルを運用フェーズで切り分け、デバッグログは本番環境では出力しないようにすること
###+4.7+リダイレクタ機能|-+リダイレクト先はDBで管理する、またはシグネチャを用い許可されたURLに対してのみリダイレクトすること
###+4.8+バージョン管理|-+バージョンを管理し、各バージョンへのアクセス状態を把握出来るようにしておくこと|-+バージョンによって処理を制御し、健全な状態を維持すること
##+5.+フロントエンドアプリケーション開発|HTML、Ajax、Single+Page+Applicationなどのフロントエンドを開発する上で留意していただきたい項目を、以下に述べます。
###+5.1+ユーザの入力値、DBからのレスポンス値の取扱い|-+DOM経由での値の操作は、不正な文字列が含まれることを前提に、かならずtext関数等を用いてサニタイズすること|-+APIやDBからの返り値を出力する際は、XSS対策としてかならずエスケープしサニタイズすること
###+5.2+リクエスト偽造を防ぐ|-+フロントエンドからAPIにリクエストを送信する際は、リクエストの偽造を防ぐため（CSRF対策）に、以下のいずれかの値を利用すること|++-+サーバ側で生成したトークン|++-+セッションID（最近はフレームワークが対応しているものが多い）
###+5.3+JSONPの利用について|-+原則としてJSONPは利用しないこと|++-+どうしても利用が必要な場合は、プログラムソースの安全性をレビューし確認した上で、JSONP経由でアクセスさせるファイルの中の情報に機微なものが含まれないように実装すること
###+5.4+他者の作成したJavascript|-+広告などの表示のため、他者が作成したJavascriptを読み込む必要がある場合は、信頼のおける配信元からのみJavascriptを許可すること|-+StaticなJavascriptのソース・ファイルが好ましいが、そうでない場合は当該Javascriptが把握していないサイトから読み込まれないようHTTPのトランザクション等を利用して検査すること|-+難読化された外部Javascriptはセキュリティ上の理由として拒否すること
##+6.+スマートフォンアプリケーション開発
###+6.1+認証とパスワードマネジメント|-+認証を必要とするコンテンツ（プレミアムコンテンツなど）は、PINは利用せず、パスワード（ポリシーに基づく）を認証に用いること|++-+まれにデバイス自体がパスワード生成機能を持っている場合があるが、エントロピーが怪しいので利用しないこと|++-+iOSが提供している指紋認証以外の生体認証は、まだ確かな技術となっていないので利用しないこと|-+メモリ上にパスワードを保持する場合は、利用が終わったあとに、必ずメモリ上から消去すること|-+提供するサービスが、課金に関するものなど非常に機微な情報を扱う場合は、多要素認証を導入すること|-+デバイス認証が必要な場合は、UIDやMACアドレスは利用せず、インストールやアカウント登録時にデバイストークンを生成すること|++-+生成方法は、hash(ランダムキー＋OSバージョン＋現在の日時＋パッケージファイル名）などとし、別デバイスで同様のハッシュ値が計算されないよう完全ユニーク化する|++-+このデバイストークンは、セッションIDや暗号化のキーとして利用が可能となる|-+パスワードを間違えた場合は、2秒ほどのDelayを意図して発生させ、10回程度の試行を目安にロックアウトさせること|-+ハッシュの生成は、SHA-2を用いること|-+ユーザがパスワードを作成する際に、強度を知らせることを推奨する
###+6.2+リバースエンジニアリング対策|-+静的なCのライブラリとして抽象化すること|-+有料またはオープンソースのツールを使い、コード全体を難読化すること|-+デバッガをプロセスにアタッチされないようにすること|++-+例）android:debuggable="false"|-+特にAndroidにおいてはリブート前に書き出されたログがどのアプリケーションでも読める状態なので、ロギングはオフにすること|-+iOS4.3,+Android4.0未満は、メモリの中身がダンプできるため対象外とすること
###+6.3+通信|-+ISPから提供されている回線やWiFiは安全ではないという前提のもとでアプリケーションを設計すること|-+SSL証明書が有効であることをかならずチェックすること|-+アプリケーションと通信する先のドメインをチェックすること（特にアプリケーションを内部でアップデートする場合は、トークンを確認し合い、許可されたシステムからの通信においてのみアップデートを許可すること）|-+SSLStripなどを用いてHTTPSの通信を改ざんするツールなどの対策として、HTTPの通信を拒否するような仕組みを導入すること|-+可能ならば、UI上でSSL通信していることがわかるようにすること|-+信頼されたCAで署名された証明書を利用すること
###+6.4+データの安全な保管方法|-+どのようなデータをデバイスに保存するか、区別し、そのレベルに応じてデータの保管・使用方法を分けるようにすること|-+機微な情報はデバイスに保存せず、サーバサイドに保存するように実装すること|-+キャッシュデータや一時データを共有ストレージに保存しない|-+機微な情報を保存する場合は、AESなどを利用して暗号化してから保存する（キャッシュやログに表示されないよう注意すること）|-+暗号鍵を生成する場合は、PBKDF2を利用し、ハッシュ値をストレッチする（システムのキャパシティにもよるが、1000回程度）|-+暗号鍵はメモリ上でも最低限の時間だけ保存し、利用が終わったら即時消去する|-+パスワードは絶対に平文で保存しない！|-+iOSにおいてパスワードやその他のデータサイズの小さい機密性の高いデータ片(鍵やログイントークンなど)を保存する際は、iOSキーチェーンを利用する。|-+機微な情報をUI上で表示する場合、表示が終わったら、すぐにメモリ上から消去すること|-+一般的なstringの変数に機微な情報は保存せず、配列などを利用する（メモリ上で新しい値が代入されてもまだ参照できるケースがある）|-+SDカードなどの外付けのストレージに機微な情報を保存しないこと|-+リモートワイプなどを利用して機微な情報を削除できる仕組みを取り入れておくこと|-+アカウント番号など、ユーザに直接表示する必要のないデータはトークンなどで代用し、デバイス上に不必要な機微な情報は保管にしないようにすること
###+6.5+セッションマネジメント|-+ユーザのログインステータスを、アプリケーションがアクティベートし、画面遷移時にチェックすること|-+ユーザのセッションが切れた場合は、メモリを開放すること|-+サーバサイド側でセッションIDを無効化できるよう設計すること|-+期限が切れたセッションを無効化するために、タイムアウト値は少なめに取っておくことを推奨する
###+6.6+サードパーティのライブラリやコードの使用について|-+信頼できるライブラリかどうか、利用前にチェックを行うこと|++-+社内で共有し、承認を取るように仕組み化しておくこと|-+利用するフレームワークの名称、バージョンを管理し、パッチや脆弱性情報を把握しておくこと|-+アドネットワークなど、外部からのリソース提供（Javascript等）がある場合は、特に注意をはらい安全かどうかを事前に確認すること
###+6.7+プロビジョニング・配布・テストについて|-+提供側でアプリバージョンのコントールが出来るように強制アップデートを実装しておくこと|-+セキュリティに関する問題がある古いバージョンのアプリケーションは、AppStoreなどから削除しておくこと|-+定期的にAPIの脆弱性テストを実施しておくこと|-+リリース前に、難読化処理が行われているか確認しておくこと|-+信頼されたCAから発行された証明書を利用し、アプリケーションに対して署名を行うこと
##+7.+個人情報を取り扱う社内アプリケーション||個人情報を取り扱う社内アプリケーションを開発する場合は、以下の点に注意してください。||-+全件を一括でダウンロードできる機能は原則として設けない|-+閲覧、編集、削除などはNeed-to-knowをベースに、必要な職務に対して権限を分割して付与できるアーキテクチャとして設計すること|-+操作履歴を取得できる設計としておくこと|++-+操作履歴は最低1年間は保存すること|-+アクセス元を制限すること|-+メールアドレス、住所や電話番号は、本当に必要な画面以外ではアスタリスクで一部マスキングする|-+GETリクエストに個人情報を含ませないこと
#+AWSインフラストラクチャーガイドライン
##+1.+はじめに|このガイドラインでは、medibaにおける、AWSを使用したサービス向けクラウドインフラストラクチャーを構築する際のガイドラインを下記の大項目に分け、それぞれ定めます。||-+主管部署|-+アカウント制限|-+アクセス制限|-+OSの選定|-+インフラストラクチャーの構成レビュー|-+サービスにおいて必要な監視項目|-+需要予測と拡張性の担保|-+可用性の担保|-+コスト計画|-+ドメインの管理、運用|-+SSL証明書の管理、運用
##+2.+主管部署||クラウドインフラストラクチャの主管部署は、システム本部インフラストラクチャー部とします。
##+3.+アカウント制限
###+3.1.+IAMアカウントの制限||-+IAMアカウントは各個人ごとに発行し、共通ユーザは原則として作成しません。|-+アプリケーションの仕様上、専用のユーザが必要な場合は必要に応じて発行しますが、操作出来る権限は適切な権限にするものとします。|-+各IAMアカウントにはMFA(多要素認証デバイス)を必ず紐付け、MFAを使用してログインすることとします。|-+IAMアカウントの新規作成/削除/権限変更は、依頼の元インフラストラクチャー部が実施します。|-+派遣/業務委託者に対する商用環境の操作権限付与は、システム本部長とインフラストラクチャー部部長の承認を得るものとします。
###+3.2.+OSアカウントの制限||-+OSアカウントの新規作成/削除は、依頼の元インフラストラクチャー部が実施します。|-+OSアカウントは各個人ごとに発行し、共通ユーザは原則として作成しません。|-+デプロイやプロビジョニング用のユーザに関しては、個別に検討の上作成する場合があります。|-+各ユーザにはパスワードを設定することとします。|-+サーバへのログインは鍵認証を使用し、パスワード認証のみの認証は禁止とします。|-+sudo権限に関しては、インフラストラクチャー部へ依頼された際、必要なユーザにのみ権限を付与します。|-+インフラストラクチャー部以外のアカウントに関しては、ユーザ削除/更新/追加のコマンドは実行できません。
##+4.+アクセス制限
###+4.1.+セキュリティグループの作成ポリシー||-+原則全てのトラフィックを拒否し、必要なものだけ許可をするホワイトリスト方式とします。|-+コンシューマ向けに開放する場合などを除いて、0.0.0.0/0(IP制限なし)のセキュリティグループとすることは禁止とします。
###+4.2.+SSHログイン||-+各環境にゲートウェイインスタンス(踏み台インスタンス)を構築し、各EC2へのログインはゲートウェイインスタンスを経由した場合のみSSH接続を行える設計とします。|-+ゲートウェイインスタンスへのSSHは、多要素認証を使用することを推奨します。
##+5.+OSの選定
###+5.1.+使用できるOS||-+原則的にAmazonLinuxを使用することとします。|-+**必要な場合に限り**、個別に検討の上他のOSを使用する場合があります。
##+6.+インフラストラクチャーの構成レビュー
###+6.1.+レビューの内容||レビューでは以下の内容を重点的にレビューします。||-+需要予測に沿ったインスタンスタイプ、台数か|-+冗長化は考慮されているか|-+障害時の影響は最小限に抑えられているか|-+適切にマネージドサービスを使用しているか|++++-+EC2にMySQLやRedisをインストールしていないかなど|-+CloudFormationやAnsibleなどの構成管理ツールを使用して構築を行う前提か
###+6.2.+構成レビュー実施のタイミング||-+インフラの構築開始前にレビューを行うこととします。|-+上記レビューは、インフラストラクチャー部にて構築を行うことが前提とします。
##+7.+サービスにおいて必要な監視項目とロギング
###+7.1.+最低限監視すべき項目||CloudWatchやKCCSのZabbix監視において、以下の項目を監視することとします。||-+CPU,+LoadAverage,メモリ使用率,+Disk使用率,+KVSのキャッシュヒット率の監視は必須とします。|-+ELBのUnhealthyHostCountやLatencyの監視も必須とします。|-+Webサイトの表示速度やレスポンス監視も、監視することを推奨します。|-+アプリケーションのログやプロセスに関しても監視することを推奨します。
###+7.2.+AWSインフラにおけるロギング||-+CloudFront,+ELBなどのログは必ず出力し、最低6ヶ月は保持を行うよう設定することとします。
##+8.+需要予測と拡張性の担保
###+8.1.+需要予測||-+想定される秒間リクエスト数や月間PV/UU数を元に、インフラの設計を行います。|-+急激なアクセス増(スパイクアクセス)が発生しうることが想定される場合についても、サービス特性にあわせてアクセス増を考慮して設計することとします。
###+8.2.+拡張性の担保||-+IPアドレスやサブネットなど、構築後の構成変更に柔軟に対応できるよう余裕を持った設計を行うこととします。|++++-+VPCを+/16+で設定し、各サブネットは+/24+でCIDRを切るなど|-+インスタンス数の増加に備え、必要であれば予め上限緩和申請を行うこととします。|-+インスタンスを構築する際、IAM+Roleは空のPolicyであってもアタッチすることとします。
##+9.+可用性の担保
###+9.1.+冗長化の方針||-+商用環境に関しては、必ずマルチAZを使用することとします。|-+想定されるリクエストが厳密に想定できない場合、または負荷が想定より増える可能性がある場合は、AutoScalingの使用を推奨します。
##+10.+コスト計画||-+設計時に必ずランニングコストを試算し、プロジェクトの規模にあっているかを確認することとします。|-+構築後、最低でも週1回は金額を確認し、コストバーストしていないかを確認します。|-+初期構築時において、必要であればリザーブドインスタンスの導入を検討することとします。|++++-+1年以上続くことが想定されるサービスなどは、明確な理由がない限り導入することとします。
##+11.+ドメイン管理、運用||-+ドメインを新規取得した場合、ドメイン管理担当に伝え、ドメインの管理を引き継ぎます。|-+新規事業などでドメインを取得する際、特に理由がない場合はAmazon+Route53でドメインを取得することを推奨します。
##+12.+SSL証明書の管理、運用||-+SSL証明書を購入した場合、SSL証明書管理担当者に伝えて期限の管理を引き継ぎます。|-+CSR,秘密鍵は開発担当エンジニアが厳重に保管することとします。|-+新規事業等の場合、特に理由がない場合はACMによる証明書を利用することを推奨します。
#+アプリケーション開発セキュリティガイドライン
##+はじめに|このガイドラインでは、medibaにおける、アプリケーション開発におけるセキュリティ対策についてのガイドラインを下記の大項目に分け、それぞれ定めます。
##+1+ガイドラインの基本的な考え方
###+1.1+目的||脆弱性を正しく理解し、対策を立てることで、お客様情報、コンテンツ情報を保護し、システムの不正利用を防止することで事業運営の健全化を図る。|このガイドラインはOWASP+TOP10、KDDIセキュリティガイドラインを基にした内容となっております。
###+1.2+適用範囲||システム開発に関与する業務に適用する。
##+2.+入力検証及び不正入力時の無効化||悪意のあるユーザが不正な文字列を組み込むことで、本来アクセス権限のないデータを入手、改竄、破壊などユーザからの入力を出力画面に含む前に、適切なエスケープや入力検証での確認をしない場合、脆弱になります。
###+2.1.+インジェクション||SQLとOS、LDAPなどのインジェクション脆弱性は、信頼されていないデータがコマンド又はクエリの一部として、サーバーに送信される際に発生します。++|攻撃者の悪意のあるデータは、意図しないコマンドの実行や適切な権限のないデータアクセス実行するようにインタプリタを騙し、webサイト内容を改竄される可能性が発生します。++|改竄された場合、被害（社会的信用の低下、事業活動のストップなど）に遭うだけでなく、medibaが加害者になってしまう可能性もあるため、深刻な事態であることを認識して下さい。
####+2.1.1.+SQLインジェクション
#####+脆弱性概要||データベースに渡され実行が行われる文字列に有害なコードを挿入する攻撃手法、またはその脆弱性の事を呼びます。|Webコンテンツ(Webサーバー)から接続しているデータベースに、管理者・開発者の意図しないSQL文を処理させる事でデータベースから情報の抜き取り、コンテンツの改竄やユーザー情報の漏洩を引き起こします。++|主にはパラメータで渡される文字列に対して、エスケープ処理を行わないままSQL文に連結しデータベースへアクセスする事で引き起こされます。||![SQLインジェクション](./images/IPA_Sql_Injection.png)
#####+例||**脆弱性のあるコード例(PHP+×+MySQL)**|```|$dbh+=+new+PDO('mysql:host=127.0.0.1;dbname=test',+'username',+'password');||$userId+=+$_POST['userId'];|$password+=+$_POST['password'];|//+ユーザー入力情報を利用して+SQL文を作成|$sql+=+"SELECT+*+FROM+ユーザマスタ+WHERE+ユーザID+=+'{$userId}'+AND+パスワード+=+'{$password}'";||$sth+=+$dbh->query($sql);|//+...|```||**引き起こされる例**++|入力値が以下の場合|>$userId+→|「+(何も入力しない)+」++|$password+→|「';+DELETE+FROM+ユーザマスタ+WHERE+'A'+=+'A」||**実行されるSQL**++|1.+SELECT+*+FROM+ユーザマスタ+WHERE+ユーザID+=+''+AND+パスワード+=+'';++|1.+DELETE+FROM+ユーザマスタ+WHERE+'A'+=+'A'
#####+対策||SQL文の組み立てにバインド機構(プレースホルダ)を使用する事により、入力データは数値定数や文字列定数として組み込まれるため、特殊文字は強制的にただのパラメータ文字として認識され、SQL文が改変される危険性がなくなります。+また、入力前にコンパイルされているので、SQLインジェクションによってSQL文を変更することが不可能になります。||**プレースホルダを利用したコード例(PHP+×+MySQL)**||```|//+プリペアドステートメントのエミュレーションを無効する|$dbh->setAttribute(PDO::ATTR_EMULATE_PREPARES,+false);||//+MySQL+ネイティブの静的プレースホルダを使用する|$sql+=+"SELECT+*+FROM+ユーザマスタ+WHERE+ユーザID+=+?+AND+パスワード+=+?";|$sth+=+$dbh->prepare($sql);+//+プリペアドステートメントを準備|//+...|```
####+2.1.2.+OSコマンドインジェクションの防御||SQLインジェクションのOSコマント版とも言える脆弱性です。|webサイトが閲覧者からのデータの入力受け付け、かつその情報をパラメータとしてOSをに対する命令文を実行する挙動を取っていた場合、プログラムに与えるパラメータにOSに対する命令文を紛れ込ませて不正に操作する攻撃を指します。
#####+例||**脆弱性の原因となる関数例(PHP)**||``|exec(),+passthru(),+proc_open(),+shell_exec(),+system()|``
#####+対策++||1.+アプリケーションを設計する際に、OSコマンドを呼び出す事を避けた設計にする。++|内部でOSコマンドを実施する事はリスクがある事を認識し、ライブラリ等を利用して解決する手法を模索して下さい。|1.+サニタイジングを実施する。++|どうしてもOSコマンドを使用する必要となった場合は、ユーザーからの入力をエスケープする事は必須です。++|特に特殊文字はエスケープする。++|bashの場合、以下の特殊記号は別のコマンドの実行に繋がる可能性が高いため、特に注意して下さい。++|``|「;」「|」「&」「`」「(」「)」「$」「<」「>」「*」「?」「{」「}」「[」「]」「!」|``
####+2.1.3.+ディレクトリトラバーサル||webサイトがサーバ内のファイルを表示する際に、管理者が意図していないパスが指定されることによって、想定外のファイルが閲覧できてしまう状態を突いた攻撃手法を指します。++|ファイル名としてユーザーが任意に変更する事ができる値(+GET/POSTパラメータやcookie値など+)を利用する箇所で発生する可能性があります。||![ディレクトリトラバーサル](./images/IPA_Directory_Traversal.png)
#####+例|**脆弱性のあるコード例(PHP)**++|-+日本語/英語/中国語の３ヶ国語に対応したwebサイト|++++-+全てのページは３ヶ国語のテンプレート(JAPANESE.html,+ENGLISH.html,+FRANCH.html+)が予め準備されている。|++++-+選択された言語のテンプレートファイル名をcookie["TEMPLATE"]に保持する。|++++-+コンテンツ内では選択された言語のテンプレートファイルを表示する。||```|<?php|$template+=+'JAPANESE.html';|if+(+is_set(+$_COOKIE['TEMPLATE']+)+)|+++$template+=+$_COOKIE['TEMPLATE'];|include+(+"/var/www/templates/"+.+$template+);|?>|```||**このシステムに対する攻撃例**++|```|GET+/xxx.php+HTTP/1.0|Cookie:+TEMPLATE=../../../../../../../../../etc/passwd|```||**生成されるサーバのレスポンス**|```|HTTP/1.0+200+OK|Content-Type:+text/html|Server:+Apache||//+以下+/etc/passwd+が応答結果に出力される|root:x:0:0:root:/root:/bin/bash|bin:x:1:1:bin:/bin:/sbin/nologin|daemon:x:2:2:daemon:/sbin:/sbin/nologin|//+…|```
#####+対策|1.+外部からファイル名を要求する仕様にしない。|1.+避けられない場合は、パラメータからディレクトリ名を取り除きファイル名のみを抽出する仕様にする。|1.+ファイルをincludeする際は、許可してないディレクトリにアクセスしてないか、プログラム内でチェックする。|1.+アクセス権限は公開用と非公開で分け、公開ディレクトリ以外は必要なユーザのみアクセス権を付与する。
####+2.1.4.+HTTPレスポンス分割の防御||外部からの入力データを使用して動的にHTTPレスポンスヘッダーを出力するwebアプリケーションの脆弱性を利用し、正規のHTTPレスポンスを「CR+LF」で分割することにより悪意のHTTPレスポンスを生成する攻撃手法を指します。++|直接的には脆弱性のあるページが影響を受けますが、悪意のHTTPレスポンスがProxyにキャッシュされる事により、他ユーザが悪意のHTTPレスポンスを取得することになり、ページの偽装/XSS/Cookieの操作+などの攻撃が可能になります。||![HTTPレスポンス分割](./images/IPA_HTTP_Response_Splitting.png)
#####+例|-+ユーザーが入力した番号のページへリダイレクトする仕様のwebサイト|++++-+HTTPレスポンスヘッダーの「Location:」フィールドの値として、出力するURLのGETパラメータを入力フォームから受け付ける||**正常なHTTPレスポンスヘッダー(入力フォームから「1」を受け付けた場合)**|```|HTTP/1.1+302+Moved|Temporarily|Content-Type:+text/html|Location:+http://sample.com/page.php?id=1|```||**攻撃例：「1」の代わりに以下の内容を入力パラメータとして送信する**++|```|1%0d%0aContent-Length:%200%0d%0a%0d%0aHTTP/1.1%20%200%20OK%0d%0aContent-Type:%20text/html%0d%0aContent-Length:%209999%0d%0a%0d%0a<html>悪意のあるコンテンツ</html>|```||**生成されるレスポンス**|```|HTTP/1.1+302+Moved|Temporarily|Content-Type:+text/html|Location:+http://sample.com/page.php?id=1|Content-Length:0||HTTP/1.1+200+OK|Content-Type:+text/html|Content-Length:9999||<html>悪意のあるコンテンツ</html>|```|HTTPの仕様では、改行コード(「CR+LF」(%0d%0a))2つによってヘッダーの終了を表します。++|上の例では｢Content-Length:0｣の後で1つのレスポンスが終了し、｢HTTP/1.1+200+OK｣以降は別のレスポンスと解釈されます。++|2番目のレスポンスの内容は、完全に攻撃者の自由となってしまいます。
#####+対策||1.+HTTPヘッダとして出力する箇所には「CR/LF」(%0d%0a)」を入れない。|1.+ユーザー入力文字列をHTTPレスポンスヘッダー挿入する際には、同じく「CR/LF」(%0d%0a)」を削除する。
####+2.1.5.+メールヘッダインジェクションの防御||宛先（To）や件名（Subject）などのメールヘッダを外部から指定する際に、改行文字を使ってメールヘッダや本文を追加・変更する攻撃手法を指します。++|webサイト自体は直接影響を受けるページはありませんが、送信するメールについて、件名や送信元/本文が改変されたり、また迷惑メールやウイルスメールの送信に悪用されることになります。||![メールヘッダインジェクション](./images/IPA_Mail_Header_Injection.png)
#####+例|PHPのメール送信関数+mail+/+mb_send_mail+は同じシグネイチャを持っています。++|``|bool+mail+(+string+$to+,+string+$subject+,+string+$message+[,+string+$additional_headers+[,string+$additional_parameters+]]+)|``++|この第４引数+$additional_parameters(追加メールヘッダ)は、改行区切りでFrom/Cc/Bccを順に指定する仕様となっているため、ユーザーからの入力値を直接設定すると、管理者の意図しないCc,Bccが設定される可能性が発生します。
#####+対策|1.+ユーザーからの入力データはバリデーションしておき、改行を除く。|1.+PHP+7.2からは$additional_headerは配列で指定することが可能になったため、文字列ではなく配列を利用する。
####+2.1.6.+不正ファイルアップロードの防御||閲覧者からのファイルアップロードを受け付ける場合、アップロードされたファイルを利用して不正な操作をする攻撃を指します。++|アップロードされたファイルに対してはファイル名、保存場所、ファイル内容等に対しチェックを実施しましょう。
#####+例|**脆弱性のあるコード例(PHP)**++|```|<?php|//ファイルをアップロードして、公開フォルダ「images」直下にそのままのファイル名で置く。|if+(!empty($_FILES['uploadfile']['tmp_name']）)+{|++++move_uploaded_file($_FILES['uploadfile']['tmp_name'],+dirname(__FILE__).'/images/'.$_FILES['uploadfile']['name']);|++++header('Location:http://'.$_SERVER['HTTP_HOST'].$_SERVER['SCRIPT_NAME']);|++++exit;|}|header("Content-Type:+test/html;+charset=Shift_JIS");|echo+"|<html><body>|<form+action=''+method='post'+enctype='multipart/form-data'>|++++<input+type='file'+name='uploadfile'+/>|++++<input+type='submit'+value='upload'+/>|</form>|</body></html>|";|```||-+ファイルに対する入力チェックを行っていなため、画像以外のファイルを公開フォルダにアップロードされてしまいます。|-+悪意のあるスクリプトがwebサイト上に公開される可能性があります。
#####+対策|1.+アップロードファイルの保存先は公開フォルダは使用しない。++|公開フォルダの外が利用できない場合には、ファイル名を拡張子のないランダムなものに変更して保存し、アップロードファイルへのアクセスについては、別途機能を用意する。|1.+拡張子名に対してバリデーションをかけ、所定の拡張子以外はエラーとする。++|また、拡張子とファイルの中身が一致しているかを確認すること。(PHPの場合、getimagesize()関数など)
###+2.2.+クロスサイトスクリプト(XSS)||XSS欠陥は、アプリケーションが信頼されていないデータを受け取る時、適切な検証やエスケープをせずに、+ウェブブラウザに送信する際に発生します。XSSにより、攻撃者は被害者のブラウザでスクリプトを実行でき、ユーザセッションのハイジャックやウェブサイトの改竄、またユーザを悪意のあるサイトにリダイレクトすることが可能です。
##+3.+セッション管理と認証の不備||認証とセッション管理に関連するアプリケーション機能は、しばしば正しく実装されていません。そのため、+攻撃者はパスワード又は鍵、セッショントークンを漏洩させたり、他の実装の不備を悪用してなりすますことができます。
###+3.1.+セッションハイジャック||ログイン状態などをセッションにて保持する場合、クライアント側ではcookieにセッションIDを保存しますが、このセッションIDを他のユーザーのものに書き換える攻撃を指します。++|セッションIDを書き換える事により、なりすまし、権限の不正取得などができるようになります。
####+例||*+セッションIDの推測++|攻撃者は、セッションIDの生成規則を割り出し、有効なセッションIDを推測します。++||![セッションIDの推測](./images/SessionPresume.png)||*+セッションIDの盗用|攻撃者は、罠を仕掛けたり、ネットワークを盗聴したりし、利用者のセッションIDを盗みます。||![セッションIDの盗用](./images/SessionHacking.png)||*+セッションIDの固定化|攻撃者は、自分が取得したセッションIDを善意の利用者のセッションIDに送り込みます。||![セッションIDの固定化](./images/SessionFixation.png)
####+対策||なりすましや管理者権限の不正取得などができないよう、適切な措置を講ずること。||*+セッションIDは、生成アルゴリズムに安全な擬似乱数生成系を用いるなどして、予測困難なものにする|*+セッションIDをURLパラメータに格納しない|*+HTTPSでCookieにsecure属性を加える|*+ログイン成功後に、新しくセッションを開始するようする
##+4.+クロスサイトフォージェリー(CSRF)||CSRF攻撃は、脆弱性のあるWebアプリケーションに対し、ログオンしている被害者のブラウザから、偽造されたHTTPリクエストを送信させます。そのリクエストには、被害者のセッションクッキーや他の自動的に組み込まれた認証情報が含まれています。これにより、攻撃者は脆弱性のあるアプリケーションに、ユーザからの正当なリクエストとして認識されるリクエストを被害者のブラウザに生成させることができます。
##+5.+ファイルやディレクトリ、設定情報等のリソースへの直接参照||開発者がファイル又はディレクトリ、データベースのキーなど、内部に実装されていて、かつ権限が適切に設定されていないリソースへの参照を公開する際に発生する脆弱性です。|アクセス制御チェックや他の保護が無ければ、攻撃者はこれらの参照を用い、アクセス権限のないデータへアクセスすることができます。
##+6.+セキュリティ設定のミス||適切なセキュリティには、アプリケーション、フレームワーク、アプリケーションサーバ、Webサーバ、データベースサーバ、およびプラットフォームに対して、セキュアな設定を定義して反映させる事が必要です。製品のデフォルト設定は安全ではない場合が多いため、セキュアな設定が定義・実装・維持されないといけません。また、ソフトウェアを最新の状態に保つ必要があります。
##+7.+機密データの露出
###+7.1.+脆弱性概要||機密データを暗号化していないこと、また弱いアルゴリズムによるパスワードハッシュなどで発生する脆弱性となります。|攻撃者は通常暗号化を直接破ることはせず、サーバやユーザのブラウザから転送中の平文を盗みます。万一のデータ流出時にもデータ内容を解読、悪用されないよう対策を講じ、また、機密データの誤った公開や意図しないファイルの流出を抑止するための対策が必要となります。
###+7.2.+対策
####+7.2.1.+サイトのSSL化||ログインやお客様情報といった認証を必要とする画面は、SSLを使用すること
####+7.2.2.+機密データの暗号化||機密データを盗聴や盗難から守り、万一のデータ流出時にもデータ内容を解読、悪用されないよう以下の対策を実施します。|尚、本項でいう暗号化は一方向ハッシュも含みます。
#####+7.2.2.1+暗号化が必要なケース||以下に該当する情報を保持する場合は暗号化をすること|*+パスワード|*+クレジットカード番号|*+個人情報に該当し、特に機微な情報（医療情報、金銭的資産）|*+その他特に会社が暗号化が必要と認めたもの
#####+7.2.2.2.+推奨アルゴリズム||以下のケースでは推奨するアルゴリズムを適用すること|*+複合化が必要なケース|++*+AES一択。ECB（ivが別のものでも良い）かCBC（全く同一のivが求められる）は、機密性に応じて選択すること|++*+複合用のパスワードの保管に十分に注意すること|++++*+ソースコードにはハードコーディングは絶対禁止|++++*+環境変数または設定ファイルに個別に保管管理すること|*+パスワード|++*+bcrypt,+pbkdf2,+scryptのいずれかを用いること|++++*+システムのCPUリソースに余裕がある場合はpbkdf2,+scryptを推奨|++*+ストレッチングする場合は、最低10,000回ストレッチすること|*+パスワード以外で一方向ハッシュしたいケース|++*+sha2(sha256,+sha512)+以上|++*+saltはユニークなもので十分な長さのものを用意すること
###+7.2.3.+公開ディレクトリへの配置||ログファイル、バックアップファイル、設定ファイルなど公開を前提としたファイルは、公開ディレクトリ上に配置しないようにする。また、HTTPサーバーのディレクトリスティングは無効にして下さい。
###+7.2.4.+通信時のデータ保護||機密情報をクエリストリングに含めない。また、重要情報のURLは規則性を持たせず不規則な英数字や記号を交えた長い文字列にすることで推測しにくいようにして下さい。||クエリストリングに機微な情報が含まれる場合、以下の潜在リスクが考えられます。|*+httpサーバのログに残る|*+ブラウザのキャッシュに残ったり、Google等の検索履歴に引っかかってくるおそれがある||また、公開される情報がキー値を元に生成される場合は、UUIDモジュールなどを用いたキーの生成をして下さい。||*+例)+IDをキーにURLを生成していてそのURLが本来推測して欲しくない
##+8.+機能レベルアクセス制御の欠落
###+8.1.+脆弱性概要||ネットワークアクセス可能なシステムであれば誰でもリクエスト送信出来るため、適切な権限設定がされていない場合、URLやパラメータを改変し、本来保護されるべき機能やデータへアクセスされます。||![未検証のリダイレクト事故例](./images/NetworkAccessMissing.png)
##+8.2.+対策
###+8.2.1.+機能分離とユーザー権限||*+提供先に応じたネットワークレベルの公開設定を適切に行なうこと|*+一人一ユーザーとして、権限を明確に設定すること
###+8.2.2.+暗黙的拒否||*+デフォルトはアクセス拒否し、ユーザーに対して必要な権限設定を付与する運用にすること
##+9.+既知の脆弱性を持つコンポーネントの使用
###+9.1.+脆弱性概要||ライブラリ、フレームワーク、および他のソフトウェアモジュールなどのコンポーネントは、ほとんど常にフル権限で実行されます。脆弱なコンポーネントが悪用される場合、深刻なデータ損失やサーバ乗っ取りまでに至る攻撃ができます。既知の脆弱性を持つコンポーネントを使用するアプリケーションは、アプリケー+ションの防御を弱体化し、様々な攻撃と影響も可能になります。
###+9.2.+対策
####+9.2.1.+情報収集||下記から定期的に情報収集を行ない、深刻な脆弱性を早期発見して下さい|*+[JVN](http://jvndb.jvn.jp/index.html)などの公的機関|*+品質管理経由で周知されるKDDI脆弱性情報|*+利用しているOSSのアップデートやIssue
####+9.2.2.+利用技術の精査と限定化||*+不要のパッケージは使用せずに削除すること|*+OSSの利用には信頼性を確認すること
####+9.2.3.+最新バージョンの利用||*+初期構築時にOS、ライブラリなどバージョンを最新にすること|*+運用フェーズにおいて定期的にバージョンアップにすること
####+9.2.4.+テスト自動化の推進||深刻な脆弱性が発覚しても影響範囲を確認が必要なため即アップデートは出来ません。++|アップデートを迅速に行なうため下記の環境を用意する。|*+機能に対してテストコードを用意し機械的にテストが実行出来ること|*+CI(継続的インテグレーション)環境を導入し自動的に不具合検知が出来ること
##+10.+未検証のリダイレクトとフォワード
###+10.1.+脆弱性概要||Webアプリケーションは、頻繁にユーザを他の画面やウェブサイトへリダイレクト・フォーワードしますが、信頼されていないデータを用いて、転送先画面を決定しています。適切な検証がないと、攻撃者は被害者を+フィッシングサイトやマルウェアサイトへリダイレクトできたり、フォーワードで閲覧権限のない画面へアクセスできます。||![未検証のリダイレクト事故例](./images/UnverifiedRedirect.png)||※過去、medibaで未検証のリダイレクトを許容するリダイレクトサーバーの脆弱性がありました
##+10.2.+対策||*+単なるリダイレクトやフォワードの使用は行わない|*+遷移先をホワイトリスト化、もしくはルール化しチェックする
#+テストガイドライン
##+はじめに|このガイドラインでは、medibaにおける、テスト活動についてのガイドラインを下記の大項目に分け、それぞれ定めます。
##+1.+ガイドラインの基本的な考え方
###+1.1　目的|本ガイドラインは、システム開発におけるテスト活動を円滑に行い、不具合の混入を未然に防ぎ、安定した品質を提供する事を目的とするものです。
###+1.2.　適用範囲|システム開発におけるテスト活動に適用します。
###+1.3.　本ガイドラインの管理|+1.+本ガイドラインの管理は品質管理部とします。|+1.+本ガイドラインは、見直しが必要と判断された場合は、適宜見直しを行なうものとします。|+1.+本ガイドラインは、社内から閲覧できる箇所に掲載します。
##+2.+テスト計画
###+2.1+テスト計画とは||開発初期においてマスターテスト計画を作成しましょう。++|マスターテスト計画とは、ソフトウェア開発におけるテスト工程で作成されるべき文書の標準規格であるIEEE829-2008で規定されている文書で、対象プロジェクトでのテストがうまくいくようにテスト設計の方法（アプローチ）や考え方をまとめた内容を記載するものです。
###+2.2+テスト計画に定義すべき項目
####+2.2.1+テスト概要||*+対象サービス、対象システムにおいてどのようなテストを行うか全体概要を定義します。
####+2.2.2+テスト目的||*+テストの実行目的を定義します。|*+単体テスト、結合テスト、総合テストといったテストレベルに対して、機能テスト、性能テスト、負荷テスト、セキュリティテストといったテストタイプごとに定義します。
####+2.2.3+テストの対象システムとテストスコープ||*+テスト対象システムと、テストレベルごとのテストスコープを定義します。
####+2.2.4+テストスケジュール||*+テストの目的を達成できるよう、テストレベルごとにテストスケジュールを定義します。
####+2.2.5+テスト実行環境||*+テストを実行する環境と、デバイス・OS・ブラウザ・ネイティブアプリなどの環境条件を定義します。
####+2.2.6+コミュニケーションプラン、ステークホルダー||*+不具合レポート先ツールや実施結果、テスト報告を必要とするメンバーやバグ切り分けメンバー、プロジェクト責任者などを定義します。
####+2.2.7+テスト基準||*+開始条件、終了基準、中断基準、追加基準などを定義します。
####+2.2.8++テスト成果物||*+マスターテスト計画、レベルテスト計画、テスト設計書、テストケース、不具合レポート、テスト報告書などの成果物を定義します。
###+2.3+テスト計画に定義すべき項目||テスト実行において主に意識しておくべき項目を以下に述べます。
####+2.3.1+テストレベルについて||*+開発規模、重要度、難易度、サービスの目的などにより実施するテストレベルや各テストレベルで実施する詳細を定義します。++|*+テストレベルとは、単体テスト、結合テスト、総合テストのように、開発プロジェクトにおいて組織的に管理するためのテスト作業の段階を指します。|*+medibaでは以下の条件にあてはまる案件は、重要度や難易度の高い開発案件として取り扱います。+テストレベルも複数レベルで実施しましょう。||+++*+新規構築サービス、システム|+++*+大規模リニューアル|+++*+個人情報の取得/表示取り扱いがある案件|+++*+ポイント機能にかかわる新規開発、改修案件|+++*+課金機能にかかわる新規開発、改修がある案件|+++*+SLA基準が高い案件（ライフメディア、KDDIサービス等）|+++*+業務要件、運用要件が複雑で全体要件の難易度が高い案件|+++*+新規、既存の開発を伴う広告案件|+++*+フロントエンドで新規デザイン手法を使った案件|+++*+機種依存による表示懸念がある案件||*+下記にテストレベルと対応する実施担当、テスト環境の一覧を示します。|+++*+原則として実施担当が該当テストレベルの責務を担うこととします。|||+テストレベル+++|+実施担当++++++++++++++++++++++|+テスト環境++++++++++++++++|||+-------------++|-------------------------------|---------------------------|||+単体テスト+++++|+開発エンジニア++++++++++++++++|+開発環境++++++++++++++++++|||+結合テスト+++++|+開発エンジニア/品質管理担当者+|+開発環境/ステージング環境+|||+総合テスト+++++|+サービス担当/品質管理担当者+++|+ステージング環境/商用環境+|||*+各テストレベルを分割したテスト実施対象条件は下記の通りです。（下記イメージ　詳細条件検討中）|||+開発体制+++|+KDDIサービスグレード+++|+個人情報取扱有無+|+決済・課金・ポイント関連機能有無+|+開発範囲+++++++++++|+単体テスト実施+|+結合テスト実施+|+総合テスト実施+|||------------|------------------------|------------------|----------------------------------|--------------------|----------------|----------------|----------------|||+auサービス+++|+キャリアグレード+++++++|+有+++++++++++++++|+有+++++++++++++++++++++++++++++++|+新規+++++++++++++++|+○++++++++++++++|+○++++++++++++++|+○++++++++++++++|||+auサービス+++|+キャリアグレード+++++++|+有+++++++++++++++|+有+++++++++++++++++++++++++++++++|+追加・改修+++++++++|+○++++++++++++++|+○++++++++++++++|+○++++++++++++++|||+auサービス+++|+キャリアグレード+++++++|+有+++++++++++++++|+有+++++++++++++++++++++++++++++++|+大規模リニューアル+|+○++++++++++++++|+○++++++++++++++|+○++++++++++++++|||+auサービス+++|+キャリアグレード+++++++|+無+++++++++++++++|+有+++++++++++++++++++++++++++++++|+新規+++++++++++++++|+○++++++++++++++|+○++++++++++++++|+○++++++++++++++|||+auサービス+++|+キャリアグレード+++++++|+無+++++++++++++++|+有+++++++++++++++++++++++++++++++|+追加・改修+++++++++|+○++++++++++++++|+○++++++++++++++|+○++++++++++++++|||+auサービス+++|+キャリアグレード+++++++|+無+++++++++++++++|+有+++++++++++++++++++++++++++++++|+大規模リニューアル+|+○++++++++++++++|+○++++++++++++++|+○++++++++++++++|||+auサービス+++|+キャリアグレード+++++++|+有+++++++++++++++|+無+++++++++++++++++++++++++++++++|+新規+++++++++++++++|+○++++++++++++++|+○++++++++++++++|+○++++++++++++++|||+auサービス+++|+キャリアグレード+++++++|+有+++++++++++++++|+無+++++++++++++++++++++++++++++++|+追加・改修+++++++++|+○++++++++++++++|+○++++++++++++++|+○++++++++++++++|||+auサービス+++|+キャリアグレード+++++++|+有+++++++++++++++|+無+++++++++++++++++++++++++++++++|+大規模リニューアル+|+○++++++++++++++|+○++++++++++++++|+○++++++++++++++|||+auサービス+++|+キャリアグレード+++++++|+無+++++++++++++++|+無+++++++++++++++++++++++++++++++|+新規+++++++++++++++|+○++++++++++++++|+○++++++++++++++|+○++++++++++++++|||+auサービス+++|+キャリアグレード+++++++|+無+++++++++++++++|+無+++++++++++++++++++++++++++++++|+追加・改修+++++++++|+○++++++++++++++|+○++++++++++++++|+○++++++++++++++|||+auサービス+++|+キャリアグレード+++++++|+無+++++++++++++++|+無+++++++++++++++++++++++++++++++|+大規模リニューアル+|+○++++++++++++++|+○++++++++++++++|+○++++++++++++++|||+auサービス+++|+準キャリアグレード+++++|+有+++++++++++++++|+有+++++++++++++++++++++++++++++++|+新規+++++++++++++++|+○++++++++++++++|+○++++++++++++++|+○++++++++++++++|||+auサービス+++|+インターネットグレード+|+有+++++++++++++++|+有+++++++++++++++++++++++++++++++|+新規+++++++++++++++|+○++++++++++++++|+○++++++++++++++|+○++++++++++++++|||+mediba自社+|+-++++++++++++++++++++++|+有+++++++++++++++|+有+++++++++++++++++++++++++++++++|+新規・追加・改修+++++++++|+○++++++++++++++|+○++++++++++++++|+○
##+3.+単体テスト||単体テストではプログラム単体での仕様どおりの振る舞いであるかを検証します。++|単体テストを書くことは、対象のクラスやメソッドの仕様を動作するプログラムとして記述することで、仕様の明確化と保証をもたらします。++|テストの実施は各種フレームワークがサポートしているテスティングフレームワークを使用して行うことが一般的です。++|テストコードはプロダクトコードと同じリポジトリに管理し、CI環境に組み込んで継続的に自動実行できる状態が望ましいです。++|自動化されたテストが継続して実行できることは、機能拡張やリファクタリングを行ううえで大きな助けになります。++||また後続のテストレベルにおいて検出されるバグの修正コストと比較した場合に、単体テストでの修正コストの方が低いため、単体テスト中に軽微なバグをなくすことができれば、以降のテストでは仕様バグの対応のみに集中できる利点もあります。
###+3.1+単体テストのパターン||下記は単体テストを効果的に行うためのパターンになります。++|参考：[xUnit+Patterns.com](http://xunitpatterns.com/)||*+自動化されたテスト|++*+テストは繰り返しいつでも実行できる状態にする|*+不安定なテスト|++*+テストの実行ごとに結果が一定でない状態は望ましくなく、修正が必要|*+ドキュメントとしてのテスト|++*+テストケースは最も正確なドキュメントであり、仕様書として読める|*+問題の局所化|++*+テスト失敗時に問題を特定しやすいよう、テストが小さな単位で記述する|*+不明瞭なテスト|++*+可読性の低いテストコードはメンテナンス性も低く、テストの質にも影響を与えるため、シンプルで分かりやすく記述する|*+独立したテスト|++*+各テストの実行順序に依存しないこと|++++*+独立したテストは追加や変更が容易|++++*+独立したテストは分散実行が容易
###+3.2+単体テストの観点
####+3.2.1+ホワイトボックステストとブラックボックステストについて||*+ホワイトボックステストはコード観点のテスト|*+ブラックボックステストは振る舞い観点のテスト|+*+カバレッジ率が高くても、振る舞いに誤りがあればそれはバグである|+*+カバレッジを意識せず、不作為にテストしても、テストしていないコードは見つけ辛い|*+どちらか片方だけを行っても十分とはいえないことに注意する
####+3.2.2+ホワイトボックステスト||*+ホワイトボックステストとは|++*+コード中の分や分岐、条件などを実行してバグを見つけるテスト|++*+どの文、分岐、条件も1回は実行する必要がある|++*+カバレッジ率(網羅率)|+*++テストで実行した文、分岐、条件の割合のこと
####+3.2.2.1+ホワイトボックステストの指標の分類
#####+3.2.2.1.1+ステートメントカバレッジ（命令網羅）/+C0||*+ソースコード中にある全ステートメント（命令、文）のうち、1回でもテストが実行されたステートメントの割合
#####+3.2.2.1.2+ブランチカバレッジ（分岐網羅）/+C1||*+ソースコード中にある全ブランチ（分岐）のうち、1回でもテストが実行された分岐の割合|++*+分岐で条件が成立したときと不成立のときの両方が実行される必要がある
#####+3.2.2.1.3+コンディションカバレッジ（条件網羅）/+C2||*+分岐に設定されている条件につき、成立したときと不成立のときの両方が実行された割合|++*+分岐に複数の条件が設定されている場合、各条件毎の実行有無を確認する
####+3.2.2.2+各種カバレッジの考え方||```|public+function+myFunction($type)|{|+if+($type+===+'A'+||+$type+===+'B'+)+{|++echo+"処理1";|+}+else+{|++echo+"処理2";|+}||+if+($type+===+'C')+{|++echo+"処理3";|+}|}|```||*+ステートメントカバレッジ（命令網羅）/+C0|++*+テストケースは、以下の2つでカバレッジ率100%|++++*+$type+==+"A"+TRUE（処理1）|++++*+$type+==+"C"+TRUE（処理2）|*+ブランチカバレッジ（分岐網羅）/+C1|++*+テストケースは、以下の4つでカバレッジ率100%（2+*+2+=+4通り）|++++*+$type+==+"A"+or++$type+==+"B"+TRUE,+$type+==+"C"+TRUE（無効）|++++*+$type+==+"A"+or++$type+==+"B"+TRUE,+$type+==+"C"+FALSE|++++*+$type+==+"A"+or++$type+==+"B"+FALSE,+$type+==+"C"+TRUE|++++*+$type+==+"A"+or++$type+==+"B"+FALSE,+$type+==+"C"+FALSE|*+コンディションカバレッジ（条件網羅）/+C2|++*+テストケースは、以下の8つでカバレッジ率100%|++*+1つ目の条件を分解して3つの分岐として捉える（2+^+3+=+8通り）|++++*+$type+==+"A"+TRUE,+$type+==+"B"+TRUE,+$type+==+"C"+TRUE（無効）|++++*+$type+==+"A"+TRUE,+$type+==+"B"+TRUE,+$type+==+"C"+FALSE（無効）|++++*+$type+==+"A"+TRUE,+$type+==+"B"+FALSE,+$type+==+"C"+TRUE（無効）|++++*+$type+==+"A"+TRUE,+$type+==+"B"+FALSE,+$type+==+"C"+FALSE|++++*+$type+==+"A"+FALSE,+$type+==+"B"+TRUE,+$type+==+"C"+TRUE（無効）|++++*+$type+==+"A"+FALSE,+$type+==+"B"+TRUE,+$type+==+"C"+FALSE|++++*+$type+==+"A"+FALSE,+$type+==+"B"+FALSE,+$type+==+"C"+TRUE|++++*+$type+==+"A"+FALSE,+$type+==+"B"+FALSE,+$type+==+"C"+FALSE
####+3.2.3+ブラックボックステスト||*+ブラックボックステストとは|++*+ある入力に対し、仕様どおりの正しい結果が出力されるかを確認するテスト|++*+入力と結果に着目し、テストの合否を判断する
#####+3.2.3.1+同値分割法||*+プログラムが期待する入力値である「有効同値」とそれ以外の「無効同値」のそれぞれの代表値を用意し、それらを入力値としてて実行結果を確認する方法|++*+有効同値が0以上かつ1000未満の場合、無効同値は0未満かつ1000以上
#####+3.2.3.2+境界値分析法||*+有効同値と無効同値の境界となる値を入力値としてプログラムを実行し、実行結果を確認する方法|++*+有効同値が0以上かつ1000未満の場合、無効同値は0未満かつ1000以上の場合|++++*+境界値は、-1,0,999,1000
##+4.+性能試験||要件を満たす性能が出るか、パフォーマンスを確かめるものです。++|実際の業務を模した内容や量、密度のテストデータを処理させ単位時間あたりの処理能力や応答時間などを計測し、想定した範囲に収まっているかどうかを確かめます。
###+4.1+試験種別ごとの検証内容
####+4.1.1+目標性能
#####+検証内容|*+ピーク時での性能検証|*+同時アクセス数(瞬間風速)|++*+今後のアクセス数増加も考慮した値で性能要求値を満たしていること|++*+年末年始など、リリース後、特定の日・時間に集中アクセスが想定される場合、その予測アクセス数での性能試験の実施、もしくは、運用での回避策が決まっていること(一時的にサーバーの台数を増やすなど)|*+レスポンスタイム|++*+各条件下においてのレスポンスタイムがユーザーアクセスでの要件を満たしていること|++++*+ツール上ではE2Eを考慮したレスポンスタイムは測定されないため注意する|*+トランザクションデータボリューム|++*+向こう2年間のデータ増を考慮したボリュームで|++++*+ユーザーアクセスでのレスポンス要件を満たしていること|++++*+バッチ処理での要件を満たしていること(10分サイクルの処理であれば、10分以内に処理が終了するなど)
#####+確認方法|*+訴求時の想定もしくはピーク時間帯トラフィック(平均×集中率)
####+4.1.2+ストレス確認/限界性能
#####+検証内容|*+バーストラインの検証|++*+決められた性能要求を満たす検証だけではなく、どこまで耐えられるのか限界値を確認しておくこと
#####+確認方法|*+5req/sec程度あげていく
####+4.1.3+長時間運転
#####+検証内容|*+安定稼働検証
#####+確認方法|*+ピーク時間帯トラフィックを10分以上かけ続ける
###+4.2+検証時の確認事項|*+負荷ツールでのレポート　スループット、エラー数|*+webサーバのリソース（CPU、メモリ、loadaverages、DiskIO）|*+DBのリソース|*+Slowクエリ|++*+原則、100ms以上かかるクエリは、理由付きのもの以外はすべてチューニング対象|++*+参考:レスポンスに関するKDDIとのSLAは「平均レスポンスタイムが2秒、最遅4秒」"|*+キャッシュヒット率（キャッシュが効く状態と効かない状態で確認すること）|*+エラーログ
###+4.3+テストシナリオ作成のポイント||*+PV割合から算出した各ページへのリクエスト数|*+訴求などで集中するページ及び機能||実際の運用を想定し、以下のポイントがシナリオにてフォローできているかを確認すること||*+トランザクション種別|++*+read,write、複合、それぞれのトランザクション種別に応じたシナリオが用意されていること|++++*+Getによる特定のURLにアクセスしデータ取得|++++*+Post/Put/Patchによるデータ作成/更新など|++++*+Deleteによるデータ削除|++++*+利用頻度が低くても、ファイルDLや一覧表示など、特定の負荷が高く想定されるものは検討する|*+負荷のかかる箇所|++*+各リソース、モジュールにかかる負荷状況を想定したシナリオが用意され、以下が確認事項として含まれていること|++++*+キャッシュ設計|++++++*+キャッシュヒット率、キャッシュ種別（ページ、メモリ、クエリ、CDN）|++++*+並列リソースの考慮、DBコネクション数|++*+サーバ単体の試験になっておらず、一つのシナリオで計測すべき箇所が明確になっていること|++++*+キャッシュ機構|++++*+Webサーバ|++++*+DB|++++*+その他（KVSなど）|*+負荷の上昇状況などは想定できていること|++*+バーストトラフィックによる瞬間的な負荷の増大など|++*+負荷をかける時間|++*+負荷の上昇速度、傾向|*+イベントへの対応|++*+特定のイベント(スマパスの日など)では、UIや導線の変更が発生し、負荷のかかり方やかかる場所が平常時と大きく異なる場合がある。そのような場合は、以下を考慮したシナリオを別に作成し、試験すること|++++*+画像数、画像サイズなどページ容量の変動|++++*+イベント時のみ有効になる動的モジュール|++++*+参照されるデータ量、データ種別の違い
###+4.4+テスト環境の作成||実際の運用を想定した環境になっていること||*+サーバリソース|++*+CPU,メモリなど、試験用リソースと商用リソースの性能の違いは考慮できていること|*+キャッシュ機構|++*+HWに依存するキャッシュ機構について、商用と同じ構成となっていること|*+レプリケーション|++*+並列稼働するリソースの考慮はできていること|++++*+レプリケーション、書き込み遅延など|*+データベース|++*+テストデータ量は商用環境での運用が考慮されたものになっていること|++*+可能な限り商用環境に合わせた環境にすること。|++++*+データ種別（ファイル、textなど）|++++*+データ長|++++*+個数|++++*+1ファイルあたりの容量|++++*+全体の容量
##+5.+脆弱性試験||脆弱性試験については重要度に応じて行います。
###+5.1+アプリケーション脆弱性診断||*+KDDI社からの「システム構築事前問診票（SOC診断）」を受ける新規構築案件、大規模改修開発案件については、リリース前までに外部のセキュリティ診断専門の会社にて診断を受けること。|+++*+外部のセキュリティ診断専門の会社の選定基準は、以下の診断基準を元にツール、マニュアルでの診断を行っている会社とする。|++++++*+経済産業省基準　IPA基準　安全なウェブサイトの作り方++|++++++++https://www.ipa.go.jp/security/vuln/websecurity.html
##+6.+結合テスト||結合テストでは互いに関連し合う機能のインタフェースを確認し、結合したシステム全体として正しく動作するかを検証します。
###+6.1+テスト実施の準備||*+各機能の詳細設計仕様が明確となっており、不明点がないこと|*+すべてのプログラムの単体テストが完了していること|*+他システムとの連携がある場合、結合テストにて連携してテストを行うか確定していること|+++*+他システムと連携してテストする場合、疎通確認をしていること|+++*+他システムと連携してテストしない場合、代わりとなるスタブやドライバーが用意されていること
###+6.2+テスト設計、観点||*+結合テストで実施するケースは業務フローや画面仕様書、バッチ仕様書などの設計書をもとに下記に記載する観点で作成します。|*+ケースに記載する想定結果は、各設計書に記載されている内容と一致している必要があります。|*+作成したテストケースは、開発チームにてレビューされ、ケースの妥当性、不足がないことが確認されている必要があります。
###+6.3+確認観点||*+関連する機能を対象として管理画面、フロント、バッチ、APIなどの一連の機能の流れを確認すること++|++例)+管理画面で登録～登録内容をフロントにAPIで連携～フロントに表示～フロントから登録～登録内容をバッチで処理|*+業務フローから、フローの組み合わせパターンが網羅されていること|*+画面情報などとの内容の整合性、レイアウトや操作性の統一性などを確認すること++|++ただし、フロントのレイアウトの機種ごとの確認は総合テストの対象|*+各機能の入出力バリエーションやデータのバリエーションを洗い出し、すべて網羅されていること|*+一連の機能の流れの中でエラーが発生した場合（DBダウンやサーバ接続不可等）を考慮して、エラーハンドリングが正しいか確認すること|*+バッチについては、障害時を考慮してバッチ異常終了→リランの確認を行うこと|*+他システムとの連携がある場合、送受信データの正常、異常データパターンが網羅的に確認されていること|*+他システムとの連携が失敗した場合（ファイルを受け取れない、接続できない）の確認を行うこと
###+6.4+テスト実行||*+作成したテストケースに沿って実施する|*+障害内容、事象発生手順、想定する結果を開発担当者へ連携する
###+6.5+テスト終了条件||*+すべてのテストケースの消化が完了していること|*+発見された障害の修正が終了し、再テストまで完了していること|*+もし、消化できないケースが存在する場合や発見した障害の修正を対応しない場合、責任者に説明し承認が得られていること
##+7.+総合テスト
###+7.1+テスト実施の準備||*+開発内容または開発による影響を受ける範囲（以下：開発内容）がステークホルダーへ明らかにされており、合意を得ていること。|*+実施可能なスケジュールになっていること。|*+スケジュールが変更される場合の基準が定められていること。|*+開発内容が明らかになっていること。|*+テストを実施するスコープが明らかになっていること。|*+テストを実施する環境が明らかになっていること。|*+検出した障害をどのように報告されるのか明らかになっていること。|*+スケジュール変更となる場合の基準が定められていること。|*+改修した開発内容をステークホルダーに共有、承諾されていること。|*+終了となるための基準が制定されていること。|*+作成者が休んだ際、別の開発者が同様の内容を実施出来るようにしていること。|*+開発内容に個人情報が含まれている場合、
###+7.2+分析と設計||*+分析と設計作業はテストの目的、スコープを明らかにしその目的に合わせてテストの内容を決める。|*+仕様、動作、構造、構成などの条件に基づいてテストを実施する優先順位を決める。|*+計画したテストケースをレビューし、開発内容に沿っているか、過不足は無いか確認する。|*+テストを実施する上で必要なテストデータを確認する。|*+必要なツール、環境を確認する。|*+抽象的なテストスコープから具体的なテスト実行内容を計画を立てる。|*+テストが終了となる基準を策定|*+作成した、分析と設計の内容でステークホルダーの承諾を得る。|*+下記は決定しておくべき事項など|+++*+ステークホルダー：XXXサービス、担当者：YYY|+++*+対象端末を選定方法：全端末・利用シェア率の高い端末の80%程度・特定指定端末のみ、など|+++*+対応OS／非対応OS：Android|+++*+対応端末／非対応端末：Jr端末、特化端末、未対応|+++*+動作保障するバージョンの範囲：|+++*+ブラウザ種別：Chrome5X以上、Safari、Webview|+++*+環境：STGはwifiのみ接続可能|+++*+IP接続：制限有|+++*+不具合発見時の報告：バックログ
###+7.3+実装と実行||*+必要なテストケースに優先順位をつけて（実行順、テスト手順など）をスクリプトとして仕様化し、テスト環境を整えて実行する。|*+実行手順をベースにテスト環境や、テストデータを作成し、正しく準備されていることを確認する。|*+実行結果の記録をとり、期待する結果を比較する。|*+不具合が確認された場合、再現性が取れるかどうかを確認し、バグとしてチケットを作成して報告する。
###+7.4+終了作業||*+事前に定めた終了基準と比較し、実施したテスト内容で十分か追加テストが必要かを決める。|*+テスト結果を事前に定めた終了となる基準と比較し、問題ないことを確認すること。|*+次回のリリース、テスト実施、今後のプロジェクトのために、ナレッジをまとめて共有する。
##+8.+障害・監視試験||障害発生時において、システムが想定どおりに動作すること、意図しない動作が発生しないこと、などを検証します。++|既に障害復旧方法が定まっている場合、障害時の対応や復旧方法が正しいこと、漏れがないことも確認します。++|テストには障害発生時のエラー検知や、バックアップ／リカバリの確認までを含んでも良いです。++|テスト結果を評価して、障害復旧手順や運用設計に反映させます。
###+8.1+テスト内容について||テスト内容は、SLAや障害復旧マニュアルなどをテストベースとして作成します。++|障害発生時において、SLAに沿い、サービスが継続できることを確認します。++|システム構成において各サーバがダウン、性能劣化した状況下での、ユーザ影響を想定したうえで確認内容を検討することが望ましいです。++|そのため、エンドユーザや入稿作業等を行う業務ユーザなどへの影響を考慮したうえで、しかるべき表示や対応がされるかを確認します。++|また障害復旧時のリカバリを行った際におけるユーザ影響も考慮して確認内容を検討しましょう。++|障害発生起因のシステムに与える影響も考慮し、テスト内容を検討しましょう。++||以下、テスト内容の例を記述します。++||*+障害検知のためのテスト|++*+ハードウェア各種閾値|++*+ミドルウェア、サーバ各種閾値|*+サーバが落ちた場合の挙動のテスト|++*+KVSが落ちた場合|++*+APIサーバが落ちた場合|++*+DBサーバが落ちた場合|++*+バッチが落ちた場合|++*+対抗先が落ちた場合|*+サーバのパフォーマンスが劣化した場合の挙動のテスト|++*+KVSのパフォーマンスが劣化した場合|++*+APIサーバのパフォーマンスが劣化した場合|++*+DBサーバのパフォーマンスが劣化した場合|++*+バッチ処理のパフォーマンスが劣化した場合|++*+対抗先のパフォーマンスが劣化した場合|*+確認箇所（復旧時のユーザ行動も想定する）|++*+画面全体|++++*+エラーページ|++++*+Sorryページ|++++*+メンテナンスページ|++*+画面一部（枠内や画像など）|++++*+エラー|++++*+フィラー
#+ログガイドライン
##+はじめに|このガイドラインでは、medibaにおける、システムログについてのガイドラインを下記の大項目に分け、それぞれ定めます。
##+1+ガイドラインの基本的な考え方
###+1.1+目的||アプリケーションログを有効活用することでシステムの健全化を図るとともにサービス品質を向上させる。|システムログ出力を画一的にすることで、共通基盤でスムーズに分析しやすいようにする。||*+システムエラーを検知し改善する|*+アクセスやエラーの傾向を分析する|*+不正アクセスを検知し対策を行なう
###+1.2+適用範囲||システム開発及び運用業務に関与する業務に適用する。
##+2.+ログに関する定義
###+2.1+ログの種類||*+アクセスログ|++*+HTTPサーバが出力するサーバーへのアクセスログ|*+エラーログ|++*+HTTPサーバ及びアプリケーションがエラー発生の際に出力するログ|*+アプリケーションログ|++*+アプリケーション動作に関するユーザ操作及び機能レベルで出力するログ
###+2.2+出力項目(暫定案)||解析しやすいようにログフォーマットを統一する。||```|++{|++++"level":"ログレベル",|++++"status":"HTTPステータス",|++++"date":"YYYY/MM/DD+hh:mi:ss",|++++"referer":"リファラ",|++++"ip":"接続元IPアドレス",|++++"ua":"ユーザーエージェント",|++++"responsetime":"レスポンスタイム",|++++"url":"アクセス先URL",|++++"host":"ホスト名",|++++"message":"エラー詳細など",|++++"app":{+//アプリケーション毎に設定する任意の値(例)|++++++"code":"アプリケーション結果コード",|++++++"uid":"ユーザーID",+//OZで発行されたUID|++++}|++}|```
###+2.3+ログレベル|||+レベル+|+定義+|+備考+|||+-----+|+----|+----+|||+Debug+|+テスト時に出力するレベル+|+商用では出力しない+|||+Info+|+実行状態を把握するために出力するレベル。商用では極力出力しない+|+ミッションクリティカルなシステム(課金やポイント、入退会など)で、障害発生時やユーザからの申告で実行状況を調査する可能性のあるシステムは出力する+|||+Warn+|+致命的ではないが想定外の挙動をした時に出力するレベル+|+外部システムとの接続不可、キャッシュからのデータ取得不可など今後エラーレベルが上る可能性があるもの+|||+Error+|+予期しないエラーでサービス及びシステムに影響があり、調査及び復旧が必要な時に出力するレベル+|+発生したエラーによってユーザ、クライアントや運用者側に問題があるもの+|||+Fatal+|+アプリケーションの継続が困難な時に出力するレベルであり、至急復旧作業を要する+|+Fatalに伴う二次災害を注意する
###+2.4+ログ出力に関する留意点||*+必要な情報だけ出力する|++*+パフォーマンスへの影響も考慮すること|*+個人情報は出力しない|++*+ログが漏洩しても被害を最小限にする|++*+個人情報を参照出来るauIDなどはそのまま出力しない|*+監視と合わせて適切か定期的にログレベルを見直す|*+監視対象にならない情報はログを分けて出力する
##+3+ログ蓄積
###+3.1+アクセスログ蓄積について||サービス及びシステムの分析、可視化を行なうためにアクセスログの活用をして下さい。|medibaではログ収集する共通基盤を提供しているため、共通基盤を利用することを推奨しています。
####+3.1.1+アクセスログ収集について||[TreasueData+by+IDCF](https://console.ybi.idcfcloud.net/databases)にアクセスログを一元的に集約しています。|共通基盤では、ログ収集、共通UID発行機能を提供しています。利用については[こちら](https://creative-m.backlog.jp/wiki/COTTON_IRAI/Home)から申請をして下さい。
##+4.+管理ツールにおけるログの扱い||その操作がどう影響を与えたか調査が必要になった場合に、操作者とその内容を特定出来るようにする必要がある。|操作ログについては、サービス固有のストレージへの保管をお願いします。||*+出力しておくべき項目|++*+ユーザ|++*+日時|++*+操作内容|++*+IPアドレス|*+保持期限|++*+個人情報が含まないツールの場合：1年間|++*+個人情報が含むツールの場合：5年間|*+留意点|++*+個人情報を更新する場合、更新前後の記録が残るようにする|++*+管理ツールの実装に関してはアプリケーション開発ガイドライン「7.+個人情報を取り扱う社内アプリケーション」を参照
#+リリースガイドライン
##+はじめに|このガイドラインでは、medibaにおけるサービスリリースについてのガイドラインを下記の大項目に分け、|それぞれ定めます。||*+リリース体制|*+リリースの流れ|*+リリースコンポーネントごとに留意すべきこと|*+リリース完了後
##+1+ガイドラインの基本的な考え方
###+1.1+目的|本ガイドラインは、システムのリリース業務を安全かつ円滑に行なう事を目的とするものである。
###+1.2+適用範囲|システム主に商用環境へのリリース業務に関与する業務に適用する
###+1.3.　本ガイドラインの管理|+1.+本ガイドラインの管理はシステム開発部署とする。|+1.+本ガイドラインは、見直しが必要と判断された場合は、適宜見直しを行なうものとする。|+1.+本ガイドラインは、社内から閲覧できる箇所に掲載する。
##+2.リリース体制|リリース計画を立てる上で、決めておくべき体制を以下に述べます。
###+2.1.リリース担当者|-+リリース担当者を**コンポーネント単位で**明確にしておくこと。|+-+主担当メンバがリリース当日に作業に参加できない可能性を考慮し、かつサポートやダブルチェックの為に副担当も置いておく事が望ましい。
###+2.2.関係者|-+リリースにおける社内及び社外の関係者を整理し、連絡手段を決めて共有すること。|-+意識しておくべき主な関係者を以下に列挙する。|+-+プロジェクト責任者|+-+サービス編成担当|+-+外部ベンダ担当|+-+KDDI+サービス担当|+-+対向システム担当|+-+他、協業CP担当+etc...
###+2.3.問題発生時の連絡・対応フロー|-+問題発生した時の連絡方法およびエスカレーション先や対応フローを明確にし、関係者間で共有すること。　
###+2.4.大規模プロジェクトにおけるリリース体制|複数サービスにまたがるプロジェクトのリリースについては、前項までの内容に加え、更に考慮すべき事項を述べます。||-+特別体制の有無を確認する。|+-+有の場合は明確な期間と体制解除となる条件を整理する。|+-+24時間体制が必要な場合は、時間ごとの担当を明確にする。|++-+負荷が高いことが予想される時間帯は人員を多くするなど、状況に応じた割り振りする。||-+定時報告が必要な場合は、詳細を関係者間で認識合わせをしておく。|+-+誰に・いつ・どんな手段で・何を報告するかをはっきりさせる。||-+他サービスとの作業の前後関係を明確にしておく。|+-+システムやデータ連携がある場合は、タイムチャート等を作成し視覚的に関係性を把握できるようにする。
##+3.リリースの流れ|リリースを実施するにあたり、考慮すべき事項を以下に述べます。
###+3.1.リリースタイムスケジュール|タイムスケジュールはリリース作業流れを整理・把握する為だけのものではありません。||実施内容に見落としがないかの事前確認や、前項1.4でも触れたとおり連携している他サービスのリリースタイムスケジュール策定、作業におけるサービス影響範囲（期間）を把握する為の判断基準といった役割も持っています。||ですので、大規模なプロジェクトだけでなく、小規模リリースにおいても作成しておきましょう。||他に考慮すべき点を下記に何点か挙げます。||-+オンライン、ジョブ、他システム連携などを考慮し、リリーススケジュールを組み立てる。||-+フロント、バックエンド、DB等の各コンポーネントのリリース順序による影響範囲を整理し、一番リスクのないスケジュールを検討する。||-+リリースにおけるいずれの手順においても、作業所要時間に可能な限りバッファを持たせるようにする|++-+しかしメンテナンス切替がある場合、その期間はタイムスケジュールを元に検討されるので、必要以上にバッファをとらない。||-+アプリのリリースは、連携しているAPIやシステムの切り戻しが確実に発生しないタイミングで行う。
###+3.2.リリース手順書について|-+リリース手順書は、コンポーネント単位で可能な限りわかりやすく記述する。||-+個人の開発環境に依存する手順は見直すか、必須となる環境設定の構築手順を明確にする。|+-+手順書中の記述に個人のホームディレクトリ等の環境設定が入らないようにすること。||-+作業手順自体は可能な限りリスクの少ない方法を採用する。|+-+リスクが発生する場合は、その内容とリカバリプランも併せて事前にメンバに共有し、記述しておく。||-+コンポーネントの種類に限らず手順書に関してはテンプレート化しておき、運用できるように整備すること。||-+手順書を作成したメンバ以外も作業ができるよう、チームレビューを実施すること。|+-+コンポーネント単位で作業者が違う場合、それぞれのリリース作業タイミングの認識をあわせておくこと。||-+一部コンポーネントを先行リリースを行う場合、他コンポーネントに影響がない事の確認手順をいれること。||-+属人的な手順は可能な限り代替手段を検討すること。||-+コンポーネント単位で、切り戻し手順を確立しておく。|+-+リリースしたものを全てを対象とするか一部を対象にするだけで良いかを確定させておくこと。||-+リリース作業の間、サービスを一般ユーザーに公開して良いかを関係者に確認しておくこと。|+-+メンテナンスへの切り替えが必要な場合、開始と終了の手順も作成する。|+-+メンテナンス中、社内からサービスの動作検証を確認できる方法を確立しておく。||-+AWSにおいてはデプロイをAZ単位で実施するなど、可能な限りリスクが少ない手順を検討する。|+-+コンソールとCLIと両方で実施可能な手順は、両方を明記しておく。||-+監視設定の無効化の手順が含まれている事を確認する。||-+対向システムとの連携がある場合、初回稼働のタイミングを明確にしておく。|+-+バッチ連携の場合は、手動での初回連携が必要かどうかも確認しておくこと。||-+LBに関してサーバ（インスタンス）の切り離しが必要かを確認する。|+-+必要な場合は、その手順を盛り込むこと。||-+DB構造の変更および大量データ操作の際は、バックアップとロールバック手順を明確化し、必要となる作業時間を把握しておく。+|+-+可能であれば商用またはそれに近い状態のデータにてリハーサルを実施することを推奨する。||-+各種キャッシュの明示的な生成および削除が必要な場合は、その手順を明記する。||-+連携している外部システムやサービスにおいて、疎通やAPI利用に必要な申請手続きが完了してい|ることを確認し、可能であればそれらの検証を事前に実施する。|+-+申請～対向側の対応完了までの必要日数を把握し、窓口となる連絡先を記載しておくこと。
###+3.3.リリース作業実施の前に|事前に準備できるものに関しては作業前日には完了しておき、リリース直前に再度確認します。|準備内容のレビューも忘れないように。||事前準備段階でタイムスケジュールの変更や手順を変えるリスクや見落としが発生した場合は、速やかに責任者にエスカレーションをし、リリース計画の見直しを実施します。||他に考慮すべき点を下記に述べます。||-+停止するべきジョブやプロセス、バッチが適切に停止されていること。||-+メンテナンス切替を実施する場合は、社外ネットワークからサービスがメンテナンス状態になっている事を確認すること。|++-+確認は開発者だけはでなく、関係者複数人で実施すること。||-+アラート監視に影響するリリース作業時は、監視無効化の申請をしていること。|++-+監視を委託している場合は、監視会社の申請ルールを確認し、漏れなく申請を行なうこと。
###+3.4.メンテナンス切り替えがある場合|メンテナンスへの切り替えが発生する場合に考慮すべき点を以下に述べます。
####+3.4.1.メンテナンス中の検証について|-+メンテナンス中に検証できる環境および方法を確立しておく。|+-+許可IPを事前に整理すること。||-+メンテナンス用に一時的な設定やリンク先変更を実施する際は、その内容を作業前後に確認できるようにする。||-+メンテナンス中の検証における制限事項がないかを確認する。|++-+検証できない箇所に関して、メンテナンス解除後に速やかに検証ができる手順を整えておく。||-+連携している他サービスやシステムと同時リリースの際は、対向側におけるメンテナンス中の検証も考慮すること。
####+3.4.2.メンテナンス解除|-+メンテナンス解除時、検証用の文言や機能が解放されていないかを確認すること。|+-+連携システムの向き先等、一時的な設定変更を実施している場合は、特に注意。||-+メンテナンス解除のタイミングは、プロジェクト責任者やサービス関係者と認識を必ず合わせること。|+-+解除後に一般ユーザーのアクションによるデータの登録が発生しデータリカバリ等が困難となる等、大きなリスクになりかねない。
###+3.5.リリース失敗時の切り戻しについて|切り戻しを実施する際に考慮すべき点を以下に述べます。
####+3.5.1.切り戻しの実施判断|リリース手順・タイムスケジュール策定の段階で決めておくべき点を挙げます。||-+切り戻しとなる判断基準|+-+連携しているシステム側起因によるパターンも想定すること。|+-+判断基準と共にユーザー影響も予め整理しておく。|-+切り戻しの判断をする担当者|-+切り戻し可能な期間|+-+切り戻しの最終判断を実施するタイミングを決めておくこと。|-+切り戻し対象とするコンポーネントとその切り戻し先バージョン|+-+切り戻しの原因(判断基準)によって範囲が変わる場合は、パターン分けをしておくこと。|+-+複数コンポーネントを対象する場合、タイムラグによる影響を把握しておく。|-+切り戻し作業の手順、タイムスケジュール
####+3.5.2.切り戻し作業の実施||-+あせらないこと。|-+関係者へ経過報告の上、切り戻しを実施すること。|+-+可能な限り作業の所要時間ならびに完了目処となる日時を周知する。|-+データリカバリを実施する際は、可能であれば**リカバリ前**のデータのダンプを取得しておくこと。|+-+切り戻し原因の調査や、正常ではないシステム状態の際にユーザーによってデータ更新されてしまった際に必要となるかもしれない為。
####+3.5.3.切り戻し後の動き|-+切り戻しとなった原因を関係者間で共有し、次のアクションを協議する|-+切り戻し後、連携している他サービスや対向システム側の状況を確認すること。|+-+対向システム側のみの切り戻しが発生した場合等も、担当サービスの正常性と併せて確認すること。
##+4.リリースコンポーネントごとに留意すべきこと|リリース対象のコンポーネントによって留意するべきことを以下に述べます。
###+4.1.アプリケーションデプロイ|-+gitを利用してリリース資材を管理している場合、対象とするブランチおよび改修内容が確実に含まれていることを確認する。|-+各種キャッシュに関して、デプロイ前の状態が残っていないことを確認する。
####+4.1.2.デプロイ対象の確認|-+デプロイ操作の際は、対象となるサーバ（インスタンス）を確認すること。|+-+可能であればダブルチェックを実施する。|-+対象サーバ(インスタンス)をLBから切り離す場合、ログなどからユーザアクセスがないことを確認の上、実施する。
####+4.1.3.対向システムとの繋ぎこみ|-+初回の連携においては、ログなどを確認し確実に疎通およびレスポンスが受け取れていることを確認すること。|-+想定外のエラーが発生した場合、状況を対向システム担当に速やかに連絡をすること。|-+ファイルI/Fの場合、確認するべき事項を以下に挙げる。|++++-+送受信フォルダへの書き込み権限が想定通りとなっていること。|++++-+送受信フォルダの空き容量が充分であること。|++++-+可能であれば送信先受信先サーバにファイルが正常に送受信されたかを目視で確認すること。|++++-+送受信ファイルサイズが0バイトなどになっていないこと。|++++-+送受信ファイルの中身が正常であること。|++++++++-+文字コードなどは特に注意すること。
###+4.2.DB操作||-+構造/データの変更によりアプリケーションに影響を与える可能性を考慮し、資材のデプロイとの作業順序を決定すること。
#####+4.2.1DB構造変更|-+テーブル追加等、保持すべきデータ量の想定が増加する可能性がある場合、作成環境のDB領域の空き容量を確認する。|-+リリース当日の確認作業、および具体的な閾値とNGの場合の対応方法を手順化すること。|-+既存テーブルに変更を行う場合（カラム追加/カラム名称/データ型や項目長の変更）|-+IndexのステータスがInvalidになっているものがないかを確認し、InvalidになっているIndexについては、再作成を実施する手順が盛り込むこと。
#####+4.2.2データ操作|-+データの操作を行う必要がある場合も、原則として手動（コマンド、PHPMyAdmin等）での操作は行わない。|-+構成管理ツールを用いてDMLを実行する形式を用いること。|-+運用管理画面で操作が可能な項目については、極力そちらを利用すること。
#####+4.2.3.データ移行|-+環境間でのデータ移行を行う場合は、必ずリハーサルを行う。|-+具体的なチェック項目と切り戻し手順を準備すること。
###+4.3.キャッシュについて|-+リリースするシステムのキャッシュの種類・使い方について把握すること。|-+手動でのキャッシュ削除が可能な場合、手順に盛り込むこと。|-+削除できないキャッシュの場合、キャッシュが切れる時間を把握し関係者に共有すること。
##+5.リリース完了後の振り返り
###+5.1.リリース作業実施中、リリース直後に発生したヒヤリハット・障害について|-+チェックリスト化する項目の有無を検討し、品質管理担当に連携する。|++++-+Talknoteの「品質管理（システム系プロパー全部入り）」に投稿すること
#+システム運用ガイドライン
##+はじめに|このガイドラインでは、medibaにおける、システム運用についてのガイドラインを下記の大項目に分け、それぞれ定めます。
##+用語の定義|*+運用||+システム維持を行なう定常業務をいう。|*+保守||+システム復旧及びシステム更新作業|*+ユーザー||+サービス及びシステム利用者をいう。
##+1.+ガイドラインの基本的な考え方
###+1.1　目的|本ガイドラインは、システムにおける運用及び保守業務を円滑に行なうためを目的とするものである。
###+1.2.　適用範囲|システム運用及び保守業務に関与する業務に適用する。
###+1.3.　本ガイドラインの管理|+1.+本ガイドラインの管理は運用・保守部署とする。|+1.+本ガイドラインは、見直しが必要と判断された場合は、適宜見直しを行なうものとする。|+1.+本ガイドラインは、社内から閲覧できる箇所に掲載する。
##+2.+構成管理・保守に関する要件
###+2.1.+アカウント管理|セキュリティを考慮したサーバのアカウント管理を行なう、|*+1人1アカウントとし、アカウントの共有は行なわないこと|*+未使用アカウントは直ちに削除すること(退職者など)|*+定期的にパスワードを変更すること|*+必要な権限のみ付与すること|*+運用・保守部署でアカウント管理を行なうこと|*+発行アカウントは一元管理を行なうこと|*+バッチ処理の実行アカウント等はドキュメント化して残しておくこと
###+2.2.+サーバー保守
####+2.2.1.+監視|早期に障害発見を行ない、適切な障害対応を行えるようにすること|*+以下の監視を行ない障害の検知ができるようにすること|+-+サーバ、NW+機器システム状況(ping,ヘルスチェック,+リソース使用量など)|+-+プロセス稼動状況|+-+バッチ成功有無|+-+各種ログ|*+監視項目がダウンした場合、アラートを出すこと|*+障害に対するメッセージを決定すること
####+2.2.2.+バックアップ|障害時のシステム復旧及び調査に必要なデータのバックアップを行ないデータ消失を防ぐ。|*+障害及び調査に必要なバックアップ対象となるデータを精査すること|+*+障害復旧|+++*+データベース|+++*+情報ファイル|+++*+設定ファイル|+++*+ソースコード|+*+調査|+++*+アクセスログ|+++*+操作ログ|+*+その他|+++*+ドキュメントなど|*+データの特性によりバックアップ方式を決定すること|+*+時間|+++*+リアルタイム|+++*+定常(時、日、週など)|+*+方式|+++*+全データ、差分など|*+システムの特性によりデータの保存期間を決めること|*+システムの特性によりバックアップの有無を決めること|*+保管先は、バックアップ元と同居させないこと|*+保管先の障害対応性も検討すること|*+バックアップの方針についてレビューすること
####+2.2.3.+ログ|各種ログの管理を必ず行なう。[ガイドライン](https://github.com/mediba-system/system-guidelines/blob/master/AppLogGuideline.md)に準拠すること。
####+2.2.4.+SLA|受託サービスや、プレーヤーが多岐に渡る場合、運用及び保守業務の責任分担を明確にするため、サービスレベル契約（Service+Level+Agreement；ＳＬＡ）の導入を検討すること|*+SLA+を締結する場合、必要な項目が記載されているかを確認すること|+*+SLA+の項目が適切であること|+++*+サーバーの稼働率|+++*+アプリケーションの稼働率|+++*+基準応答時間達成率+など|+*+SLA+が守れたか月次ベースでチェックすること|+*+SLA+違反の改善を検討すること
###+2.3.+クライアント端末|運用及び保守業務にクライアント端末を用いる場合は、以下の観点で管理する。||*+メンテナンス要件によって決められた端末からのみ作業を実施すること++|*+各システムのメンテナンス要件は有識者のレビューを通して策定すること++|*+運用・保守部署は使用する端末がその要件を満たしていることを確認すること++|*+使用する端末の安全性を確保する為の情報について管理すること++|+++使用する端末は一元管理すること++|+++不要なソフトウェアをインストールしないこと++|+++アンチウィルスソフト等のマルウェア対策を実装すること++|+++規定の場所・方法以外でネットワークに接続しないこと
###+2.4.+媒体の管理++|原則として外部媒体の接続は禁止とする。|ただし、業務上必要な場合は必ず管理・責任者の許可を得た上で使用する。++|使用する媒体は以下に沿って管理する。++||*+使用する媒体は運用・保守部署にて一元管理し、使用履歴を記録すること++|*+接続の事前にウィルスなどが含まれていないことを確認すること++|*+利用時以外はデータを保存しないこと++|*+媒体は施錠可能な場所で保管すること++|*+媒体の廃棄の際はデータを完全に削除した上で廃棄すること
###+2.5.+LAN+接続|各システムは運用及び保守業務が可能な管理用接続の方法を有するものとする。|また、システム構成・接続方式を検討する際は以下の点を考慮する。||*+定められた場所・方法以外から管理用接続できないこと|*+運用・保守担当者以外が管理用接続できないこと|*+管理用接続の高負荷や障害等により、ユーザー通信に影響を与えないこと
##+3.+脆弱性への対応
###+3.1.+脆弱性管理|システムを構成するOS及びソフトウェアの脆弱性情報や、その他システムの脅威となりうる事象またはその要素|(以下、セキュリティインシデントと表記する）について運用・保守部署にて管理・対応する。
####+3.1.1.+セキュリティインシデントの定義|本ガイドラインでは、以下の被害が発生する事象やその「疑いのある要素」についても含め|セキュリティインシデントと定義する。||*+データの破壊、改ざん、流出（盗聴、情報の不正持ち出しなど）|*+コンピュータ資源の盗用（システムの不正利用など）|*+サービスの妨害（サーバーへの攻撃など）
####+3.1.2.+セキュリティインシデントの管理||*+セキュリティインシデントについての管理体制、対応体制及び連絡体制を明確にしておくこと|*+それぞれの体制について、インシデントの発覚状況に応じた体制を確立し、発覚した場合はそれぞれ|++あらかじめ決められた対応体制及び連絡体制に沿って速やかに対処できるよう準備すること|+*+新たな脆弱性情報について速やかに内容を確認し、各部門へ脆弱性対象の使用有無、パッチの適用状況を確認する|+*+脆弱性攻撃などの疑いが発覚した段階でインシデントと判断し、速やかに報告・調査を実施する|+*+利用ユーザー環境でのインシデント発生時は速やかに運用・保守部署及び関連部署に連絡する|*+各インシデント及びその対応内容について記録を残すこと|+-+発生日|+-+詳細内容|+-+対象機器|+-+対処方針|+-+判断理由|+-+判断責任者|+-+対処完了日
####+3.1.3.+サーバーの脆弱性対処||*+システム影響を考慮し原則として常時最新化はしない|*+パッチ適用が必要な場合は十分な検証の上実施する
####+3.1.4.+クライアントの脆弱性対処|*+パッチ配信サーバにて適用するセキュリティパッチを管理すること|*+アンチウィルスソフト等のマルウェア対策を実装すること
###+3.2.+リリース|保守業務において以下の理由でシステムへの変更が必要な場合は各システムの方針に基づいてリリース作業を実施する。||*+サービスへの機能追加が必要な場合|*+システムに脆弱性が見つかった場合|*+その他サービス改善の為に運用保守部署にて変更が必要と判断した場合||作業を行なう際はそのリスクに応じて以下に観点に基づいて実施する。|*+発生する作業影響を事前に明確にすること|*+作業フロー中の危険ポイントを整理しておくこと|*+異常が発生した場合の切り戻し手段を用意すること|*+リリース作業時は作業者と確認者の複数名で実施すること|*+作業証跡(作業ログ、画面キャプチャ等)を取得・保管すること|*+実施日時、実施者、変更履歴、実施結果を保管すること|*+リリース後には問題点や作業効率化を検討すること
###+3.3.+障害対応|障害が発生した場合は原則としてサービス復旧を最優先とし、迅速な対応を行なう。|また、迅速な対応を可能とするため、事前に以下について準備する。||*+対応体制及び連絡体制を明確にしておくこと++|*+各障害箇所に対し、影響範囲を把握しておくこと++|*+各障害箇所に対し、復旧作業手順を用意しておくこと++|*+障害復旧後、再発防止策を検討すること
###+3.4.+外部委託|作業品質や業務効率を考慮し、外部委託が望ましいと判断された場合は、|情報漏えいや不正な行為が発生しないよう情報の取り扱いを情報セキュリティ委員に相談し、|許諾を得た上で実施する。
####+3.4.1.+委託内容の明確化|業務を委託する際は以下について明確にし、社内の同意を得た上で、委託先と合意を結ぶ。|委託先との合意は書面として記録を残し、契約の曖昧化を防止する。||*+委託業務内容（責任分界点）|*+委託元、委託先の管理・責任者及び体制++|*+作業場所（接続方式）
####+3.4.2.+委託業務の管理|委託業務以外の行為を防止する為、以下について業務内容とそのリスクに応じて|必要最低限となるよう検討し、管理する。||*+入室可能範囲/入退室履歴|*+利用アカウント権限/作業履歴
#+外注開発ガイドライン
##+1.本書の目的|本書は、請負契約による外注システム開発を行う場合、外部会社（以下、開発ベンダー）の作業、成果物に対してmedibaのシステム担当（外注開発管理者）がチェックすべき観点を記す。
##+2.開発業務の流れ|請負開発による一般的な業務の流れを以下に記す。|>+図を作成
##+3.開発ベンダーの選定||既存案件を継続して改修する場合を除き、開発ベンダーに業務を依頼する際は||*+RFPの配布|*+相見積もりの取得||を行った上で選定を行う。その際の留意点は以下の通り。|*+選定基準を明確にすること|*+開発ベンダーにより見積条件に相違がある場合、その内容を明確にすること|*+責任分解点を明確にすること
##+4.成果物|開発ベンダーの各フェーズにおける成果物として以下が揃っていることを契約時に確認すること。||*+基本設計書|*+詳細設計書|*+ソースコード|*+テスト仕様書・計画書|*+テスト結果報告書|*+リリース計画書
###+4.1.成果物のチェック|各種成果物に対して、以下をチェックすること|*+日程、システム名などに間違いはないか|++++*+過去のドキュメントを再利用するにあたり、こういった基本的なミスがある場合、重要な記載を流用したまま確認が不足しているケースが多い
##+5.スケジュール管理||*+開発ベンダーの業務と、medibaを含む他社の業務を内包したタスク、マイルストーン、スケジュールの管理を行うこと|*+共通のツールで一元管理することが望ましいが、最低限プロジェクトのマスターとなるスケジュールを管理し共有すること
##+6.変更管理|プロジェクト進行中に仕様変更や開発スコープの変更を行う際の留意点は以下の通り|*+変更依頼から検討、各種ドキュメントやソースコードの変更までの履歴をBacklog/Redmine等のツールで管理すること|*+すべての成果物（設計書、ソースコード、テスト仕様書など）に変更が反映され、変更による影響が考慮されていることを確認すること
##+7.設計|開発ベンダーが作成した設計におけるチェック観点は以下の通り||*+要求仕様、要件定義で確定された機能が漏れなく設計されているか|++*+機能に不足はないか|++*+入出力項目の過不足、バリデーションやデータ型の定義は適切か|*+機能の流れはユースケース等のフロー図で定義されているか|++*+運用要件は考慮されているか|++*+大量データの処理時など、時間軸を考慮した設計になっているか|*+例外、異常系の考慮がされているか|++*+外部連携の例外は対向となるシステムと合意が取れているか|*+非機能要件に対する設計が行われているか|++*+適切なログ出力、監視設定も含めて設計されているか|++*+性能要件を考慮した設計になっているか|*+要求、要件などのインプットが不足、遅延している場合、以下がリストアップできているか|++*+未設計箇所、要変更箇所|++*+変更、追加のパターン|++*+インプットの期日と設計変更の期日
##+8.テスト|開発ベンダーが実施する各種テストにおけるチェック観点は以下の通り
###+8.1.必要なテストの種類|*+案件開始時に、以下のテストが実施されることを確認すること|*+各フェーズのスケジュールとマイルストーンを明確にすること|*+不要な場合はその理由を明確にすること。||++*+画面機能試験|++*+シナリオ試験|++*+外部連携試験|++*+性能試験|++*+脆弱性試験|++*+障害・監視試験
###+8.2.試験仕様書フォーマット||*+各種試験仕様書、結果報告書のフォーマットは基本的にmedibaが作成、提供する|++++*+開発ベンダー作成のフォーマットを利用したい場合各試験フェーズで必要な項目が記載されていることを確認する
###+8.3.各試験フェーズにおけるチェックリスト
####+8.3.1.画面機能試験||*+試験仕様はワイヤーフレーム等の画面仕様を元に作成されているか|*+出力項目が日付などの条件でコントロールされる要件がある場合、しきい値でのテストは行われているか|*+対応するデバイス、ブラウザは明確にされ、デバイス別の機能がある場合はテストされているか|*+各種エラー時の要件は明確にされ、エラー出力のテストは行われているか|*+実端末での試験は行われているか。不要な場合は理由が明確にされ合意されているか
####+8.3.2.シナリオ試験||*+試験仕様は運用フローを定義したユースケース等の設計を元に作成されているか|*+運用上同時に同一のデータを操作する可能性が考慮されているか|*+ドメイン、インフラ構成などの環境差異を考慮し試験が行われているか|*+アプリケーションログの確認が手順に含まれているか
####+8.3.3.外部連携試験||*+試験仕様は連携フローを定義したユースケース等の設計を元に作成されているか|*+外部システムとの連携がある場合、対向システムとの連携試験は行われているか|++++*+手動でのファイル配置等、実際のシステム連携をせず仮想的に行っていないか|*+試験する環境は明確にされ、商用環境と異なる場合は環境の相違点は認識されているか|*+IFのエラー定義は明確にされ、エラー時のテストは行われているか|*+ファイル連携を行う場合、容量の最大値は明確にされ、しきい値での試験を行っているか
####+8.3.4.性能試験||*+試験仕様は要件定義時の需要予測を元に作成されているか|++++*+需要予測を満たす性能に達しているかの試験を行っているか|++++*+性能上限を試す試験は行われているか|*+大量データ、ファイルを扱う画面や機能（管理機能含む）がある場合、画面表示や処理にかかる時間を計測しているか|++++*+サービス、運用に耐えうる画面表示時間は定義されているか|++++*+バッチの処理時間など、サービスや運用に影響がないことを確認しているか|*+性能試験を行うツールは明確にされ、シナリオ等の条件は明確にされているか|++++*+商用環境と同等の構成での試験が望ましいが、差異がある場合はそれらを考慮した上で試験を実施しているか|*+アプリケーションログの確認が手順に含まれているか
####+8.3.5.脆弱性試験||*+セキュリティガイドラインに準じた対策、試験が行われているか|*+試験を行うツールは明確にされ、シナリオ等の条件は明確にされているか
####+8.3.6.障害・監視試験||*+障害のケース網羅性は問題ないか|++*+DB/KVS等と通信ができない場合は考慮されているか|++*+外部システムとの連携で例外が発生した場合は考慮されているか+など|*+監視設定は明確に定義されており、その内容を元に試験シナリオが準備されているか
##+9.リリース|開発ベンダーが実施するリリース計画におけるチェック観点は以下の通り
###+9.1.リリース体制|-+リリース担当者、窓口、作業場所は明確になっているか|-+問題が発生した時の連絡方法およびエスカレーション先や対応フローは明確か。|-+報告タイミングや手段は明確か
###+9.2.リリースの流れ|*+タイムスケジュールは定義されているか|*+連携するシステムや外部作業は考慮されているか|*+切り戻し手順は記載されているか|+++*+切り戻しの判断基準が明確になっているか|*+監視設定の無効化が必要な場合は記載されているか|*+対向システムとの連携がある場合、初回稼働のタイミングは明確か|*+環境に依存した手順はないか|*+キャッシュのパージ等の必要性、手段は考慮され、手順に盛り込まれているか
###+9.3.リリース後の確認|*+リリース後の正常性確認が手順に含まれているか|+++*+画面表示系の機能は、ひととおりの動作、表示を行うこと|++++++*+動作確認項目は要点が絞られているか（過大になっていないか　過少になっていないか）|++++++*+商用アカウントでのログインや会員登録、申込等必要な場合、使用するアカウント等が準備されているか。|+++++++++*+その場合のデータクリーニングの必要可否は考慮されており、手段は明確になっているか|+++*+バッチ等のリリース時は、リリース後の初回起動に問題がないことを確認する|++++++*+継続的に経過観察が必要な場合、考慮されているか
