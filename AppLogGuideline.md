# ログガイドライン

<!-- START doctoc generated TOC please keep comment here to allow auto update -->
<!-- DON'T EDIT THIS SECTION, INSTEAD RE-RUN doctoc TO UPDATE -->


- [はじめに](#%E3%81%AF%E3%81%98%E3%82%81%E3%81%AB)
- [1 ガイドラインの基本的な考え方](#1-%E3%82%AC%E3%82%A4%E3%83%89%E3%83%A9%E3%82%A4%E3%83%B3%E3%81%AE%E5%9F%BA%E6%9C%AC%E7%9A%84%E3%81%AA%E8%80%83%E3%81%88%E6%96%B9)
  - [1.1 目的](#11-%E7%9B%AE%E7%9A%84)
  - [1.2 適用範囲](#12-%E9%81%A9%E7%94%A8%E7%AF%84%E5%9B%B2)
- [2. ログに関する定義](#2-%E3%83%AD%E3%82%B0%E3%81%AB%E9%96%A2%E3%81%99%E3%82%8B%E5%AE%9A%E7%BE%A9)
  - [2.1 ログの種類](#21-%E3%83%AD%E3%82%B0%E3%81%AE%E7%A8%AE%E9%A1%9E)
  - [2.2 出力項目(暫定案)](#22-%E5%87%BA%E5%8A%9B%E9%A0%85%E7%9B%AE%E6%9A%AB%E5%AE%9A%E6%A1%88)
  - [2.3 ログレベル](#23-%E3%83%AD%E3%82%B0%E3%83%AC%E3%83%99%E3%83%AB)
  - [2.4 ログ出力に関する留意点](#24-%E3%83%AD%E3%82%B0%E5%87%BA%E5%8A%9B%E3%81%AB%E9%96%A2%E3%81%99%E3%82%8B%E7%95%99%E6%84%8F%E7%82%B9)
- [3 ログ蓄積](#3-%E3%83%AD%E3%82%B0%E8%93%84%E7%A9%8D)
  - [3.1 アクセスログ蓄積について](#31-%E3%82%A2%E3%82%AF%E3%82%BB%E3%82%B9%E3%83%AD%E3%82%B0%E8%93%84%E7%A9%8D%E3%81%AB%E3%81%A4%E3%81%84%E3%81%A6)
    - [3.1.1 アクセスログ収集について](#311-%E3%82%A2%E3%82%AF%E3%82%BB%E3%82%B9%E3%83%AD%E3%82%B0%E5%8F%8E%E9%9B%86%E3%81%AB%E3%81%A4%E3%81%84%E3%81%A6)
- [4. 管理ツールにおけるログの扱い](#4-%E7%AE%A1%E7%90%86%E3%83%84%E3%83%BC%E3%83%AB%E3%81%AB%E3%81%8A%E3%81%91%E3%82%8B%E3%83%AD%E3%82%B0%E3%81%AE%E6%89%B1%E3%81%84)

<!-- END doctoc generated TOC please keep comment here to allow auto update -->

## はじめに
このガイドラインでは、medibaにおける、システムログについてのガイドラインを下記の大項目に分け、それぞれ定めます。

## 1 ガイドラインの基本的な考え方

### 1.1 目的

アプリケーションログを有効活用することでシステムの健全化を図るとともにサービス品質を向上させる。
システムログ出力を画一的にすることで、共通基盤でスムーズに分析しやすいようにする。

* システムエラーを検知し改善する
* アクセスやエラーの傾向を分析する
* 不正アクセスを検知し対策を行なう

### 1.2 適用範囲

システム開発及び運用業務に関与する業務に適用する。

## 2. ログに関する定義

### 2.1 ログの種類

* アクセスログ
  * HTTPサーバが出力するサーバーへのアクセスログ
* エラーログ
  * HTTPサーバ及びアプリケーションがエラー発生の際に出力するログ
* アプリケーションログ
  * アプリケーション動作に関するユーザ操作及び機能レベルで出力するログ

### 2.2 出力項目(暫定案)

解析しやすいようにログフォーマットを統一する。

```
  {
    "level":"ログレベル",
    "status":"HTTPステータス",
    "date":"YYYY/MM/DD hh:mi:ss",
    "referer":"リファラ",
    "ip":"接続元IPアドレス",
    "ua":"ユーザーエージェント",
    "responsetime":"レスポンスタイム",
    "url":"アクセス先URL",
    "host":"ホスト名",
    "message":"エラー詳細など",
    "app":{ //アプリケーション毎に設定する任意の値(例)
      "code":"アプリケーション結果コード",
      "uid":"ユーザーID", //OZで発行されたUID
    }
  }
```

### 2.3 ログレベル

| レベル | 定義 | 備考 |
| ----- | ----| ---- |
| Debug | テスト時に出力するレベル | 商用では出力しない |
| Info | 実行状態を把握するために出力するレベル。商用では極力出力しない | ミッションクリティカルなシステム(課金やポイント、入退会など)で、障害発生時やユーザからの申告で実行状況を調査する可能性のあるシステムは出力する |
| Warn | 致命的ではないが想定外の挙動をした時に出力するレベル | 外部システムとの接続不可、キャッシュからのデータ取得不可など今後エラーレベルが上る可能性があるもの |
| Error | 予期しないエラーでサービス及びシステムに影響があり、調査及び復旧が必要な時に出力するレベル | 発生したエラーによってユーザ、クライアントや運用者側に問題があるもの |
| Fatal | アプリケーションの継続が困難な時に出力するレベルであり、至急復旧作業を要する | Fatalに伴う二次災害を注意する |



### 2.4 ログ出力に関する留意点

* 必要な情報だけ出力する
  * パフォーマンスへの影響も考慮すること
* 個人情報は出力しない
  * ログが漏洩しても被害を最小限にする
  * 個人情報を参照出来るauIDなどはそのまま出力しない
* 監視と合わせて適切か定期的にログレベルを見直す
* 監視対象にならない情報はログを分けて出力する


## 3 ログ蓄積

### 3.1 アクセスログ蓄積について

サービス及びシステムの分析、可視化を行なうためにアクセスログの活用をして下さい。
medibaではログ収集する共通基盤を提供しているため、共通基盤を利用することを推奨しています。

#### 3.1.1 アクセスログ収集について

[TreasueData by IDCF](https://console.ybi.idcfcloud.net/databases)にアクセスログを一元的に集約しています。
共通基盤では、ログ収集、共通UID発行機能を提供しています。利用については[こちら](https://creative-m.backlog.jp/wiki/COTTON_IRAI/Home)から申請をして下さい。

## 4. 管理ツールにおけるログの扱い

その操作がどう影響を与えたか調査が必要になった場合に、操作者とその内容を特定出来るようにする必要がある。
操作ログについては、サービス固有のストレージへの保管をお願いします。

* 出力しておくべき項目
  * ユーザ
  * 日時
  * 操作内容
  * IPアドレス
* 保持期限
  * 個人情報が含まないツールの場合：1年間
  * 個人情報が含むツールの場合：5年間
* 留意点
  * 個人情報を更新する場合、更新前後の記録が残るようにする
  * 管理ツールの実装に関してはアプリケーション開発ガイドライン「7. 個人情報を取り扱う社内アプリケーション」を参照
