# ログガイドライン

## はじめに
このガイドラインでは、medibaにおける、システムログについてのガイドラインを下記の大項目に分け、それぞれ定めます。

## 目的

アプリケーションログを有効活用することでシステムの健全化を図るとともにサービス品質を向上させる。
システムログ出力を画一的にすることで、共通基盤でスムーズに分析しやすいようにする。

* システムエラーを検知し改善する
* アクセスやエラーの傾向を分析する
* 不正アクセスを検知し対策を行なう

## ログレベル

| レベル | 定義 | 備考 |
| ----- | ----| ---- |
| Debug | テスト時に出力するレベル | 商用では出力しない |
| Info | 実行状態を把握するために出力するレベル。商用では極力出力しない | ミッションクリティカルなシステム(課金やポイント、入退会など)で、障害発生時やユーザからの申告で実行状況を調査する可能性のあるシステムは出力する |
| Warn | 致命的ではないが想定外の挙動をした時に出力するレベル | 外部システムとの接続不可、キャッシュからのデータ取得不可など今後エラーレベルが上る可能性があるもの |
| Error | 予期しないエラーでサービス及びシステムに影響があり、調査及び復旧が必要な時に出力するレベル | 発生したエラーによってユーザ、クライアントや運用者側に問題があるもの |
| Fatal | アプリケーションの継続が困難な時に出力するレベルであり、至急復旧作業を要する | Fatalに伴う二次災害を注意する |

## 出力項目

```
{
  "level":"ログレベル",
  "status":"HTTPステータス",
  "date":"YYYY/MM/DD hh:mi:ss",
  "referer":"リファラ",
  "ip":"接続元IPアドレス",
  "ua":"ユーザーエージェント",
  "responsetime":"レスポンスタイム",
  "url":"アクセス先URL",
  "host":"ホスト名",
  "app":{ //アプリケーション毎に設定する任意の値(例)
    "code":"アプリケーション結果コード",
    "uid":"ユーザーID", //OZで発行されたUID
  }
}
```

## ログ出力に関する留意点

* 必要な情報だけ出力する
  * パフォーマンスへの影響も考慮すること
* 個人情報は出力しない
  * ログが漏洩しても被害を最小限にする
  * 個人情報を参照出来るauIDなどはそのまま出力しない
* 監視と合わせて適切か定期的にログレベルを見直す
* 監視対象にならない情報はログを分けて出力する


## ログ収集

flentd, logstash, embalkで定期的に収集
リアルタイム性は求めない

## 管理ツールにおけるログの扱い

その操作がどう影響を与えたか調査が必要になった場合に、操作者とその内容を特定出来るようにする必要がある。

* 出力しておくべき項目
  * ユーザ
  * 日時
  * 操作内容
  * IPアドレス
* 保持期限
  * 個人情報が含まないツールの場合：1年間
  * 個人情報が含むツールの場合：5年間
* 留意点
  * 個人情報を更新する場合、更新前後の記録が残るようにする
  * 管理ツールの実装に関してはアプリケーション開発ガイドライン「7. 個人情報を取り扱う社内アプリケーション」を参照
