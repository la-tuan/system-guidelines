# AWSインフラストラクチャーガイドライン

<!-- START doctoc generated TOC please keep comment here to allow auto update -->
<!-- DON'T EDIT THIS SECTION, INSTEAD RE-RUN doctoc TO UPDATE -->


- [1. はじめに](#1-%E3%81%AF%E3%81%98%E3%82%81%E3%81%AB)
- [2. 主管部署](#2-%E4%B8%BB%E7%AE%A1%E9%83%A8%E7%BD%B2)
- [3. アカウント制限](#3-%E3%82%A2%E3%82%AB%E3%82%A6%E3%83%B3%E3%83%88%E5%88%B6%E9%99%90)
  - [3.1. IAMアカウントの制限](#31-iam%E3%82%A2%E3%82%AB%E3%82%A6%E3%83%B3%E3%83%88%E3%81%AE%E5%88%B6%E9%99%90)
  - [3.2. OSアカウントの制限](#32-os%E3%82%A2%E3%82%AB%E3%82%A6%E3%83%B3%E3%83%88%E3%81%AE%E5%88%B6%E9%99%90)
- [4. アクセス制限](#4-%E3%82%A2%E3%82%AF%E3%82%BB%E3%82%B9%E5%88%B6%E9%99%90)
  - [4.1. セキュリティグループの作成ポリシー](#41-%E3%82%BB%E3%82%AD%E3%83%A5%E3%83%AA%E3%83%86%E3%82%A3%E3%82%B0%E3%83%AB%E3%83%BC%E3%83%97%E3%81%AE%E4%BD%9C%E6%88%90%E3%83%9D%E3%83%AA%E3%82%B7%E3%83%BC)
  - [4.2. SSHログイン](#42-ssh%E3%83%AD%E3%82%B0%E3%82%A4%E3%83%B3)
- [5. OSの選定](#5-os%E3%81%AE%E9%81%B8%E5%AE%9A)
  - [5.1. 使用できるOS](#51-%E4%BD%BF%E7%94%A8%E3%81%A7%E3%81%8D%E3%82%8Bos)
- [6. インフラストラクチャーの構成レビュー](#6-%E3%82%A4%E3%83%B3%E3%83%95%E3%83%A9%E3%82%B9%E3%83%88%E3%83%A9%E3%82%AF%E3%83%81%E3%83%A3%E3%83%BC%E3%81%AE%E6%A7%8B%E6%88%90%E3%83%AC%E3%83%93%E3%83%A5%E3%83%BC)
  - [6.1. レビューの内容](#61-%E3%83%AC%E3%83%93%E3%83%A5%E3%83%BC%E3%81%AE%E5%86%85%E5%AE%B9)
  - [6.2. 構成レビュー実施のタイミング](#62-%E6%A7%8B%E6%88%90%E3%83%AC%E3%83%93%E3%83%A5%E3%83%BC%E5%AE%9F%E6%96%BD%E3%81%AE%E3%82%BF%E3%82%A4%E3%83%9F%E3%83%B3%E3%82%B0)
- [7. サービスにおいて必要な監視項目とロギング](#7-%E3%82%B5%E3%83%BC%E3%83%93%E3%82%B9%E3%81%AB%E3%81%8A%E3%81%84%E3%81%A6%E5%BF%85%E8%A6%81%E3%81%AA%E7%9B%A3%E8%A6%96%E9%A0%85%E7%9B%AE%E3%81%A8%E3%83%AD%E3%82%AE%E3%83%B3%E3%82%B0)
  - [7.1. 最低限監視すべき項目](#71-%E6%9C%80%E4%BD%8E%E9%99%90%E7%9B%A3%E8%A6%96%E3%81%99%E3%81%B9%E3%81%8D%E9%A0%85%E7%9B%AE)
  - [7.2. AWSインフラにおけるロギング](#72-aws%E3%82%A4%E3%83%B3%E3%83%95%E3%83%A9%E3%81%AB%E3%81%8A%E3%81%91%E3%82%8B%E3%83%AD%E3%82%AE%E3%83%B3%E3%82%B0)
- [8. 需要予測と拡張性の担保](#8-%E9%9C%80%E8%A6%81%E4%BA%88%E6%B8%AC%E3%81%A8%E6%8B%A1%E5%BC%B5%E6%80%A7%E3%81%AE%E6%8B%85%E4%BF%9D)
  - [8.1. 需要予測](#81-%E9%9C%80%E8%A6%81%E4%BA%88%E6%B8%AC)
  - [8.2. 拡張性の担保](#82-%E6%8B%A1%E5%BC%B5%E6%80%A7%E3%81%AE%E6%8B%85%E4%BF%9D)
- [9. 可用性の担保](#9-%E5%8F%AF%E7%94%A8%E6%80%A7%E3%81%AE%E6%8B%85%E4%BF%9D)
  - [9.1. 冗長化の方針](#91-%E5%86%97%E9%95%B7%E5%8C%96%E3%81%AE%E6%96%B9%E9%87%9D)
- [10. コスト計画](#10-%E3%82%B3%E3%82%B9%E3%83%88%E8%A8%88%E7%94%BB)
- [11. ドメイン管理、運用](#11-%E3%83%89%E3%83%A1%E3%82%A4%E3%83%B3%E7%AE%A1%E7%90%86%E9%81%8B%E7%94%A8)
- [12. SSL証明書の管理、運用](#12-ssl%E8%A8%BC%E6%98%8E%E6%9B%B8%E3%81%AE%E7%AE%A1%E7%90%86%E9%81%8B%E7%94%A8)

<!-- END doctoc generated TOC please keep comment here to allow auto update -->

## 1. はじめに
このガイドラインでは、medibaにおける、AWSを使用したサービス向けクラウドインフラストラクチャーを構築する際のガイドラインを下記の大項目に分け、それぞれ定めます。

- 主管部署
- アカウント制限
- アクセス制限
- OSの選定
- インフラストラクチャーの構成レビュー
- サービスにおいて必要な監視項目
- 需要予測と拡張性の担保
- 可用性の担保
- コスト計画
- ドメインの管理、運用
- SSL証明書の管理、運用

## 2. 主管部署

クラウドインフラストラクチャの主管部署は、システム本部インフラストラクチャー部とします。

## 3. アカウント制限
### 3.1. IAMアカウントの制限

- IAMアカウントは各個人ごとに発行し、共通ユーザは原則として作成しません。
- アプリケーションの仕様上、専用のユーザが必要な場合は必要に応じて発行しますが、操作出来る権限は適切な権限にするものとします。
- 各IAMアカウントにはMFA(多要素認証デバイス)を必ず紐付け、MFAを使用してログインすることとします。
- IAMアカウントの新規作成/削除/権限変更は、依頼の元インフラストラクチャー部が実施します。
- 派遣/業務委託者に対する商用環境の操作権限付与は、システム本部長とインフラストラクチャー部部長の承認を得るものとします。
- AWS踏み台アカウント上の個人IAMのアクセスキーは、3ヶ月ごとにローテーションすることを推奨します。
  - 上記は個人アカウントのIAMを対象とし、システムやアプリケーションで使用しているIAMではないものとしています。

### 3.2. OSアカウントの制限

- OSアカウントの新規作成/削除は、依頼の元インフラストラクチャー部が実施します。
- OSアカウントは各個人ごとに発行し、共通ユーザは原則として作成しません。
- デプロイやプロビジョニング用のユーザに関しては、個別に検討の上作成する場合があります。
- 各ユーザにはパスワードを設定することとします。
- サーバへのログインは鍵認証を使用し、パスワード認証のみの認証は禁止とします。
- sudo権限に関しては、インフラストラクチャー部へ依頼された際、必要なユーザにのみ権限を付与します。
- インフラストラクチャー部以外のアカウントに関しては、ユーザ削除/更新/追加のコマンドは実行できません。

### 3.3. AWSアカウントの制限

- AWSアカウントは各システムと環境ごとに取得するものとします。
- AWSアカウントの命名規則は `システム名-環境名3文字` とします。
  - 開発環境は`dev`、検証環境は`stg`、商用環境は`prd`
  - 例として、372おすすめプロジェクトの商用環境であれば`osusume-prd`とします。
- AWSアカウントの取得は、特別な事情がない限りインフラストラクチャー部が申請し管理を行います。

## 4. アクセス制限
### 4.1. セキュリティグループの作成ポリシー

- 原則全てのトラフィックを拒否し、必要なものだけ許可をするホワイトリスト方式とします。
- コンシューマ向けに開放する場合などを除いて、0.0.0.0/0(IP制限なし)のセキュリティグループとすることは禁止とします。
- RDSやElasticacheなど、インターネットから直接アクセスされるべきでないものに関しては、インターネットからアクセス出来ないよう適切に設定するものとします。

### 4.2. SSHログイン

- 各環境にゲートウェイインスタンス(踏み台インスタンス)を構築し、各EC2へのログインはゲートウェイインスタンスを経由した場合のみSSH接続を行える設計とします。
- ゲートウェイインスタンスへのSSHは、多要素認証を使用することを推奨します。

## 5. OSの選定
### 5.1. 使用できるOS

- 原則的にAmazonLinuxを使用することとします。
- **必要な場合に限り**、個別に検討の上他のOSを使用する場合があります。
- OSや同梱されているパッケージなどは適宜アップデートすることとし、古いバージョンを使用し続けないようにするものとします。

## 6. インフラストラクチャーの構成レビュー
### 6.1. レビューの内容

レビューでは以下の内容を重点的にレビューします。

- 需要予測に沿ったインスタンスタイプ、台数か
- 冗長化は考慮されているか
- 障害時の影響は最小限に抑えられているか
- 適切にマネージドサービスを使用しているか
    - EC2にMySQLやRedisをインストールしていないかなど
- CloudFormationやAnsibleなどの構成管理ツールを使用して構築を行う前提か

### 6.2. 構成レビュー実施のタイミング

- インフラの構築開始前にレビューを行うこととします。
- 上記レビューは、インフラストラクチャー部にて構築を行うことが前提とします。

## 7. サービスにおいて必要な監視項目とロギング
### 7.1. 最低限監視すべき項目

CloudWatchやKCCSのZabbix監視において、以下の項目を監視することとします。

- CPU, LoadAverage,メモリ使用率, Disk使用率, KVSのキャッシュヒット率の監視は必須とします。
- ELBのUnhealthyHostCountやLatencyの監視も必須とします。
- Webサイトの表示速度やレスポンス監視も、監視することを推奨します。
- アプリケーションのログやプロセスに関しても監視することを推奨します。

### 7.2. AWSインフラにおけるロギング

- CloudFront, ELBなどのログは必ず出力し、最低6ヶ月は保持を行うよう設定することとします。

## 8. 需要予測と拡張性の担保
### 8.1. 需要予測

- 想定される秒間リクエスト数や月間PV/UU数を元に、インフラの設計を行います。
- 急激なアクセス増(スパイクアクセス)が発生しうることが想定される場合についても、サービス特性にあわせてアクセス増を考慮して設計することとします。

### 8.2. 拡張性の担保

- IPアドレスやサブネットなど、構築後の構成変更に柔軟に対応できるよう余裕を持った設計を行うこととします。
    - VPCを /16 で設定し、各サブネットは /24 でCIDRを切るなど
- インスタンス数の増加に備え、必要であれば予め上限緩和申請を行うこととします。
- インスタンスを構築する際、IAM Roleは空のPolicyであってもアタッチすることとします。

## 9. 可用性の担保
### 9.1. 冗長化の方針

- 商用環境に関しては、必ずマルチAZを使用することとします。
- 想定されるリクエストが厳密に想定できない場合、または負荷が想定より増える可能性がある場合は、AutoScalingの使用を推奨します。

## 10. コスト計画

- 設計時に必ずランニングコストを試算し、プロジェクトの規模にあっているかを確認することとします。
- 構築後、最低でも週1回は金額を確認し、コストバーストしていないかを確認します。
- 初期構築時において、必要であればリザーブドインスタンスの導入を検討することとします。
    - 1年以上続くことが想定されるサービスなどは、明確な理由がない限り導入することとします。

## 11. ドメイン管理、運用

- ドメインを新規取得した場合、ドメイン管理担当に伝え、ドメインの管理を引き継ぎます。
- 新規事業などでドメインを取得する際、特に理由がない場合はAmazon Route53でドメインを取得することを推奨します。

## 12. SSL証明書の管理、運用

- SSL証明書を購入した場合、SSL証明書管理担当者に伝えて期限の管理を引き継ぎます。
- CSR,秘密鍵は開発担当エンジニアが厳重に保管することとします。
- 新規事業等の場合、特に理由がない場合はACMによる証明書を利用することを推奨します。
