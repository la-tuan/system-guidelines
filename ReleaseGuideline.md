# リリースガイドライン

## はじめに
このガイドラインでは、medibaにおけるサービスリリースについてのガイドラインを下記の大項目に分け、
それぞれ定めます。

* 1.リリース体制
* 2.リリースの流れ
* 3.リリースコンポーネントごとに留意すべきこと
* 4.リリース完了後

## 1.リリース体制
リリース計画を立てる上で、決めておくべき体制を以下に述べます。

### 1.1.リリース担当者
- リリース担当者を**コンポーネント単位で**明確にしておくこと。
 - 主担当メンバがリリース当日に作業に参加できない可能性を考慮し、かつサポートやダブルチェックの為に副担当も置いておく事が望ましい。


### 1.2.関係者
- リリースにおける社内及び社外の関係者を整理し、連絡手段を決めて共有すること。
- 意識しておくべき主な関係者を以下に列挙する。
 - プロジェクト責任者
 - サービス編成担当
 - 外部ベンダ担当
 - KDDI サービス担当
 - 対向システム担当
 - 他、協業CP担当 etc...


### 1.3.問題発生時の連絡・対応フロー
- 問題発生した時の連絡方法およびエスカレーション先や対応フローを明確にし、関係者間で共有すること。　

>ここに図を差し込みたい<

### 1.4.大規模プロジェクトにおけるリリース体制
複数サービスにまたがるプロジェクトのリリースについては、前項までの内容に加え、更に考慮すべき事項を述べます。

- 特別体制の有無を確認する。
 - 有の場合は明確な期間と体制解除となる条件を整理する。
 - 24時間体制が必要な場合は、時間ごとの担当を明確にする。
  - 負荷が高いことが予想される時間帯は人員を多くするなど、状況に応じた割り振りする。

- 定時報告が必要な場合は、詳細を関係者間で認識合わせをしておく。
 - 誰に・いつ・どんな手段で・何を報告するかをはっきりさせる。

- 他サービスとの作業の前後関係を明確にしておく。
 - システムやデータ連携がある場合は、タイムチャート等を作成し視覚的に関係性を把握できるようにする。


## 2.リリースの流れ
リリースを実施するにあたり、考慮すべき事項を以下に述べます。

### 2.1.リリースタイムスケジュール
タイムスケジュールはリリース作業流れを整理・把握する為だけのものではありません。

実施内容に見落としがないかの事前確認や、前項1.4でも触れたとおり連携している他サービスのリリースタイムスケジュール策定、作業におけるサービス影響範囲（期間）を把握する為の判断基準といった役割も持っています。

ですので、大規模なプロジェクトだけでなく、小規模リリースにおいても作成しておきましょう。

他に考慮すべき点を下記に何点か挙げます。

- オンライン、ジョブ、他システム連携などを考慮し、リリーススケジュールを組み立てる。

- フロント、バックエンド、DB等の各コンポーネントのリリース順序による影響範囲を整理し、一番リスクのないスケジュールを検討する。

- リリースにおけるいずれの手順においても、作業所要時間に可能な限りバッファを持たせるようにする
  - しかしメンテナンス切替がある場合、その期間はタイムスケジュールを元に検討されるので、必要以上にバッファをとらない。

- アプリのリリースは、連携しているAPIやシステムの切り戻しが確実に発生しないタイミングで行う。

### 2.2.リリース手順書について
- リリース手順書は、コンポーネント単位で可能な限りわかりやすく記述する。

- 個人の開発環境に依存する手順は見直すか、必須となる環境設定の構築手順を明確にする。
 - 手順書中の記述に個人のホームディレクトリ等の環境設定が入らないようにすること。

- 作業手順自体は可能な限りリスクの少ない方法を採用する。
 - リスクが発生する場合は、その内容とリカバリプランも併せて事前にメンバに共有し、記述しておく。

- コンポーネントの種類に限らず手順書に関してはテンプレート化しておき、運用できるように整備すること。

- 手順書を作成したメンバ以外も作業ができるよう、チームレビューを実施すること。
 - コンポーネント単位で作業者が違う場合、それぞれのリリース作業タイミングの認識をあわせておくこと。

- 一部コンポーネントを先行リリースを行う場合、他コンポーネントに影響がない事の確認手順をいれること。

- 属人的な手順は可能な限り代替手段を検討すること。

- コンポーネント単位で、切り戻し手順を確立しておく。
 - リリースしたものを全てを対象とするか一部を対象にするだけで良いかを確定させておくこと。

- リリース作業の間、サービスを一般ユーザーに公開して良いかを関係者に確認しておくこと。
 - メンテナンスへの切り替えが必要な場合、開始と終了の手順も作成する。
 - メンテナンス中、社内からサービスの動作検証を確認できる方法を確立しておく。

- AWSにおいてはデプロイをAZ単位で実施するなど、可能な限りリスクが少ない手順を検討する。
 - コンソールとCLIと両方で実施可能な手順は、両方を明記しておく。

- 監視設定の無効化の手順が含まれている事を確認する。

- 対向システムとの連携がある場合、初回稼働のタイミングを明確にしておく。
 - バッチ連携の場合は、手動での初回連携が必要かどうかも確認しておくこと。

- LBに関してサーバ（インスタンス）の切り離しが必要かを確認する。
 - 必要な場合は、その手順を盛り込むこと。

- DB構造の変更および大量データ操作の際は、バックアップとロールバック手順を明確化し、必要となる作業時間を把握しておく。 
 - 可能であれば商用またはそれに近い状態のデータにてリハーサルを実施することを推奨する。

- 各種キャッシュの明示的な生成および削除が必要な場合は、その手順を明記する。

- 連携している外部システムやサービスにおいて、疎通やAPI利用に必要な申請手続きが完了してい
ることを確認し、可能であればそれらの検証を事前に実施する。
 - 申請～対向側の対応完了までの必要日数を把握し、窓口となる連絡先を記載しておくこと。

### 2.3.リリース作業実施の前に
事前に準備できるものに関しては作業前日には完了しておき、リリース直前に再度確認します。
準備内容のレビューも忘れないように。

事前準備段階でタイムスケジュールの変更や手順を変えるリスクや見落としが発生した場合は、速やかに責任者にエスカレーションをし、リリース計画の見直しを実施します。

他に考慮すべき点を下記に述べます。

- 停止するべきジョブやプロセス、バッチが適切に停止されていること。

- メンテナンス切替を実施する場合は、社外ネットワークからサービスがメンテナンス状態になっている事を確認すること。
  - 確認は開発者だけはでなく、関係者複数人で実施すること。

- アラート監視に影響するリリース作業時は、監視無効化の申請をしていること。
  - 監視を委託している場合は、監視会社の申請ルールを確認し、漏れなく申請を行なうこと。

### 2.4.メンテナンス切り替えがある場合
メンテナンスへの切り替えが発生する場合に考慮すべき点を以下に述べます。

#### 2.4.1.メンテナンス中の検証について
- メンテナンス中に検証できる環境および方法を確立しておく。
 - 許可IPを事前に整理すること。

- メンテナンス用に一時的な設定やリンク先変更を実施する際は、その内容を作業前後に確認できるようにする。

- メンテナンス中の検証における制限事項がないかを確認する。
  - 検証できない箇所に関して、メンテナンス解除後に速やかに検証ができる手順を整えておく。

- 連携している他サービスやシステムと同時リリースの際は、対向側におけるメンテナンス中の検証も考慮すること。

#### 2.4.2.メンテナンス解除
- メンテナンス解除時、検証用の文言や機能が解放されていないかを確認すること。
 - 連携システムの向き先等、一時的な設定変更を実施している場合は、特に注意。

- メンテナンス解除のタイミングは、プロジェクト責任者やサービス関係者と認識を必ず合わせること。
 - 解除後に一般ユーザーのアクションによるデータの登録が発生しデータリカバリ等が困難となる等、大きなリスクになりかねない。

### 2.5.リリース失敗時の切り戻しについて
切り戻しを実施する際に考慮すべき点を以下に述べます。

#### 2.5.1.切り戻しの実施判断
リリース手順・タイムスケジュール策定の段階で決めておくべき点を挙げます。

- 切り戻しとなる判断基準
 - 連携しているシステム側起因によるパターンも想定すること。
 - 判断基準と共にユーザー影響も予め整理しておく。
- 切り戻しの判断をする担当者
- 切り戻し可能な期間
 - 切り戻しの最終判断を実施するタイミングを決めておくこと。
- 切り戻し対象とするコンポーネントとその切り戻し先バージョン
 - 切り戻しの原因(判断基準)によって範囲が変わる場合は、パターン分けをしておくこと。
 - 複数コンポーネントを対象する場合、タイムラグによる影響を把握しておく。
- 切り戻し作業の手順、タイムスケジュール

#### 2.5.2.切り戻し作業の実施

- あせらないこと。
- 関係者へ経過報告の上、切り戻しを実施すること。
 - 可能な限り作業の所要時間ならびに完了目処となる日時を周知する。
- データリカバリを実施する際は、可能であれば**リカバリ前**のデータのダンプを取得しておくこと。
 - 切り戻し原因の調査や、正常ではないシステム状態の際にユーザーによってデータ更新されてしまった際に必要となるかもしれない為。

#### 2.5.3.切り戻し後の動き
- 切り戻しとなった原因を関係者間で共有し、次のアクションを協議する
- 切り戻し後、連携している他サービスや対向システム側の状況を確認すること。
 - 対向システム側のみの切り戻しが発生した場合等も、担当サービスの正常性と併せて確認すること。


## 3.リリースコンポーネントごとに留意すべきこと
リリース対象のコンポーネントによって留意するべきことを以下に述べます。

### 3.1.アプリケーションデプロイ
- gitを利用してリリース資材を管理している場合、対象とするブランチおよび改修内容が確実に含まれていることを確認する。
- 各種キャッシュに関して、デプロイ前の状態が残っていないことを確認する。


#### 3.1.2.デプロイ対象の確認
- デプロイ操作の際は、対象となるサーバ（インスタンス）を確認すること。
 - 可能であればダブルチェックを実施する。
- 対象サーバ(インスタンス)をLBから切り離す場合、ログなどからユーザアクセスがないことを確認の上、実施する。

#### 3.1.3.リリース漏れ資材・サーバーのチェック
- TODO:リリース資材の確認フロー
    - リリースすべき資材が環境にきちんと反映されているか、サーバ上ファイルのタイムスタンプをチェックする。
    - 対象となるサーバが複数ある場合、資材に差分がないか確認すること。

#### 3.1.4.対向システムとの繋ぎこみ
- 初回の連携においては、ログなどを確認し確実に疎通およびレスポンスが受け取れていることを確認すること。
- 想定外のエラーが発生した場合、状況を対向システム担当に速やかに連絡をすること。
- ファイルI/Fの場合、確認するべき事項を以下に挙げる。
    - 送受信フォルダへの書き込み権限が想定通りとなっていること。
    - 送受信フォルダの空き容量が充分であること。
    - 可能であれば送信先受信先サーバにファイルが正常に送受信されたかを目視で確認すること。
    - 送受信ファイルサイズが0バイトなどになっていないこと。
    - 送受信ファイルの中身が正常であること。
        - 文字コードなどは特に注意すること。

### 3.2.DB操作

- 構造/データの変更によりアプリケーションに影響を与える可能性を考慮し、資材のデプロイとの作業順序を決定すること。

##### 3.2.1DB構造変更
- テーブル追加等、保持すべきデータ量の想定が増加する可能性がある場合、作成環境のDB領域の空き容量を確認する。
- リリース当日の確認作業、および具体的な閾値とNGの場合の対応方法を手順化すること。
- 既存テーブルに変更を行う場合（カラム追加/カラム名称/データ型や項目長の変更）
- IndexのステータスがInvalidになっているものがないかを確認し、InvalidになっているIndexについては、再作成を実施する手順が盛り込むこと。

##### 3.2.2データ操作
- データの操作を行う必要がある場合も、原則として手動（コマンド、PHPMyAdmin等）での操作は行わない。
- 構成管理ツールを用いてDMLを実行する形式を用いること。
- 運用管理画面で操作が可能な項目については、極力そちらを利用すること。

##### 3.2.3.データ移行
- 環境間でのデータ移行を行う場合は、必ずリハーサルを行う。
- 具体的なチェック項目と切り戻し手順を準備すること。

### 3.3.キャッシュについて
- リリースするシステムのキャッシュの種類・使い方について把握すること。
- 手動でのキャッシュ削除が可能な場合、手順に盛り込むこと。
- 削除できないキャッシュの場合、キャッシュが切れる時間を把握し関係者に共有すること。

## 4.リリース完了後の振り返り

### 4.1.リリース作業実施中、リリース直後に発生したヒヤリハット・障害について
- チェックリスト化する項目の有無を検討し、品質管理担当に連携する。
    - Talknoteの「品質管理（システム系プロパー全部入り）」に投稿すること
