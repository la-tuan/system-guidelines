# リリースガイドライン

## はじめに
このガイドラインでは、medibaにおけるサービスリリースについてのガイドラインを下記の大項目に分け、
それぞれ定めます。

* 1.リリース体制
* 2.リリースの流れ
* 3.リリースコンポーネントごとに留意すべきこと
* 4.リリース完了後

## 1.リリース体制
リリース計画を立てる上で、決めておくべき体制を以下に述べます。

### 1.1.リリース担当者
リリース担当者を**コンポーネント単位に**明確にしておきましょう。
主担当メンバがリリース当日に作業に参加できない可能性を考慮し、かつサポートやダブルチェックの為に副担当も置いておく事が望ましいです。


### 1.2.関係者
リリースにおける社内及び社外の関係者を整理しておき、
連絡手段を決めて共有できるようにしましょう。

意識しておくべき主な関係者を以下に列挙します。
- プロジェクト責任者
- サービス編成担当
- 外部ベンダ担当
- KDDI サービス担当
- 対向システム担当
他、協業CP担当 etc...


### 1.3.問題発生時の連絡・対応フロー
問題発生した時の連絡方法およびエスカレーション先や対応フローを明確にし、
関係者間でフローを共有しておきましょう。　

>ここに図を差し込みたい<

### 1.4.大規模プロジェクトにおけるリリース体制
複数サービスにまたがるプロジェクトのリリースについては、
前項までの内容に加え以下に挙げる事項についても考慮しておきましょう。

- 特別体制の有無を確認する事
-- 有の場合は明確な期間と体制解除となる条件を整理する
-- 24時間体制が必要な場合は、時間ごとの担当を明確する
--- 負荷が高いことが予想される時間帯は人員を多くするなど、状況に応じた割り振りを意識する事
- 定時報告が必要な場合は、詳細を関係者間で認識合わせをしておく
-- 誰に・いつ・どんな手段で・何を報告するかをはっきりさせる
- 他サービスとの作業の前後関係を明確にしておく
-- システムやデータの連携がある場合は、タイムチャート等を作成し視覚的に関係性を把握できるようにしておくことが望ましい


## 2.リリースの流れ
リリースを実施するにあたり、意識すべき主要な事項を以下に述べます。

### 2.1.リリースタイムスケジュール
タイムスケジュールはリリース作業流れを整理・把握する為だけのものではありません。
実施内容に見落としがないかの事前確認や、前項1.4でも触れたとおり連携している他サービスのリリースタイムスケジュール策定、作業におけるサービス影響範囲（期間）を把握する為の判断基準といった重要な役割を持っています。
ですので、大規模なプロジェクトは元より小規模なリリースにおいても作成しましょう。

他に意識すべき点を下記に何点か挙げます。

- オンライン、ジョブ、他システム連携などを考慮した上でリリース実施するようにしましょう
- フロント・バックエンド・DB操作など、リリースの順序による影響を整理し、一番リスクのないリリース順序を検討する
- 切り戻し判断の時期を決めておく。切り戻し時のタイムスケジュールも検討する
- リリースにおけるいずれの手順においても、作業所要時間に可能な限りバッファを持たせるようにする
  - しかしメンテナンス切替がある場合、その期間はタイムスケジュールを元に検討されるので、必要以上にバッファを持たすぎないようにする
- アプリのリリースに関しては、連携しているAPIやシステムの切り戻しが確実に発生しないタイミングで行うこと

### 2.2.リリース手順書について
リリース手順書は、コンポーネント単位で可能な限りわかりやすく記述するようにしましょう。
個人の開発環境に依存する手順は見直すか、必須となる環境設定の構築手順を明確にしましょう。
※手順書中の記述に個人のホームディレクトリ等の環境設定が入らないよう注意。

また、作業手順自体は可能な限りリスクの少ない方法を採用するようにします。
リスクが発生しうる場合は、そのリスクの内容とリカバリプランも併せて事前にメンバに共有し、記述しておくようにしましょう。

コンポーネントの種類に限らず手順書に関してはテンプレート化しておき、
運用できるように整備することが効率的です。

他に意識すべき点を下記に何点か挙げます。

- 手順書を作成したメンバ以外も作業ができるよう事前にチームレビューを実施すること
    - コンポーネント単位で作業者が違う場合、それぞれのリリース作業の実施タイミングの認識をあわせておくこと
- 一部コンポーネントを先行リリースを行う場合、他コンポーネントに影響がない事の確認手順をいれる
- 属人的な手順は可能な限り代替手段を検討する
- 切り戻し手順が確立しておく
    - リリースしたものを全てを対象とするか一部を対象にするだけで良いかを意識する
- リリース作業の間、サービスを一般ユーザーに公開して良いかを関係者に確認しておく
    - メンテナンスへの切り替えが必要な場合、開始と終了の手順も作成する
    - メンテナンスの間に、社内よりサービスの動作検証を確認できる方法を確立しておく
- AWSにおいてはデプロイをAZ単位で実施するなど、可能な限りリスクが少ない手順を検討する
　　- コンソールとCLIと両方で実施可能な手順は両方を明記しておく
- 監視設定の無効化の手順が含まれている事を確認する
- 対向システムとの連携がある場合は、初回稼働のタイミングを明確にしておく
　　- バッチ連携の場合は、手動での初回連携が必要かどうかも確認しておく
- LBに関して、サーバ（インスタンス）の切り離しが必要かを確認する
　　- 必要な場合は、その手順を盛り込む
- DB構造の変更および大量データ操作の際は、バックアップとロールバック手順を明確化するとともに、作業にかかる正確な時間を把握しておく
    - 可能であれば商用またはそれに近い状態のデータにてリハーサルを実施することを推奨
- 各種キャッシュにおいて、明示的な生成および削除が必要な場合は、その手順を明記する
- 作業ではないが、連携している外部システムやサービスにおいて、疎通やＡＰＩ利用に必要な申請手続きが完了していることを確認し、可能であればそれらの検証を事前に実施しておく
  - 申請～対向側の対応完了までの必要日数を把握しておくとともに、窓口となる連絡先を記載しておくこと

### 2.3.リリース作業実施の前に
事前に準備できるものに関しては作業前日には完了しておき、リリース直前に再度確認するようにしましょう。
準備内容は、副担当等の作業者本人以外にも確認してもらう事も忘れずに。
もし、準備段階でタイムスケジュールの変更や手順を変えるリスクや見落としが発生した場合、速やかに責任者にエスカレーションをし、リリース計画の見直しを考えましょう。

他に意識すべき点を下記に何点か挙げます。

- 停止するべきジョブやプロセス、バッチが適切に停止されているか
- メンテナンス切替を実施する場合は、社外ネットワークからサービスがメンテナンス状態になっている事を確実に確認する
  - 確認は開発者だけでなく、関係者複数人で実施すること
- アラート監視に影響するリリース作業の際は、監視無効化されているか
  - KCCS監視の場合は、redmineの作業申請の更新を忘れずに
- 切り戻しの為に必須となる資材のバックアップが適切に行われているか
  - ダブルチェックする事を推奨

### 2.4.メンテナンス切り替えがある場合
メンテナンスへの切り替えが発生する場合に留意すべき点を以下に述べます。

#### 2.4.1.メンテナンス中の検証について
メンテナンス中に検証できる環境および方法を確立しておきましょう。
メンテナンス中、一般ユーザーがサービスを参照できない事を必ず確認しましょう。

他に意識すべき点を下記に何点か挙げます。

- メンテナンス用に一時的な設定やリンク先変更を実施する場合は、その項目と内容を作業前後に確認できるようにしておく
- メンテナンス中の検証において、発生する制限事項があるか
  - 検証できない箇所に関して、メンテナンス解除後に速やかに検証ができる手順を整えておく
- 連携している他サービスやシステムと同時リリースの際は、対向側におけるメンテナンス中の検証も考慮する

#### 2.4.2.メンテナンス解除
メンテナンス解除の際は、検証用の文言や機能が解放されていないかを気を付けるようにしましょう。
また、連携システムの向き先等、一時的な設定変更を実施している場合は、特に注意しましょう。

メンテナンス解除のタイミングは、プロジェクト責任者やサービス関係者と認識を確実に合わせるようにしましょう。
解除後に一般ユーザーのアクションによるデータの登録などが発生した場合、もしもの時のデータリカバリなどが困難になりかねません。


## 3.リリースコンポーネントごとに留意すべきこと
リリース対象のコンポーネントによって留意するべきことを以下に述べます。

### 3.1.アプリケーションデプロイ
- gitを利用してリリース資材を管理している場合は、対象とするブランチの確認および改修内容が確実に含まれていることを確認しましょう。
- 各種キャッシュに関して、デプロイ前の状態が残っていないことを確認しましょう。


#### 3.1.2.デプロイ対象の確認
- デプロイ操作の際は、対象となるサーバ（インスタンス）を確認しましょう。ダブルチェックを実施することを推奨します。
- 対象サーバ(インスタンス)をLBから切り離す必要のある場合は、ログなどからユーザアクセスがないことを確認の上、実施しましょう。

#### 3.1.3.リリース漏れ資材・サーバーのチェック
- TODO:リリース資材の確認フロー
    - 例）リリースすべき資材が環境にきちんと反映されているか、サーバ上ファイルのタイムスタンプを確認しましょう。
    - 例）対象となるサーバが複数ある場合、資材に差分がないか確認しましょう。

#### 3.1.4.対向システムとの繋ぎこみ
- 初回の連携においては、ログなどを確認し確実に疎通およびレスポンスが受け取れていることを確認しましょう。
- 想定外のエラーが発生した場合、状況を対向システム担当にすぐ連絡しましょう。
- ファイルI/Fの場合、確認するべき事項を以下に述べます。
    - 送受信フォルダへの書き込み権限が想定通りとなっていること
    - 送受信フォルダの空き容量が充分であること
    - 可能であれば送信先受信先サーバにファイルが正常に送受信されたかを目視で確認すること
    - 送受信ファイルサイズが0バイトなどになっていないこと
    - 送受信ファイルの中身が正常であること
        - 文字コードなどは特に注意すること

### 3.2.DB操作

- 構造/データの変更によりアプリケーションに影響を与える可能性を考慮し、資材のデプロイとの作業順序を決定しましょう。

##### 3.2.1DB構造変更
- テーブル追加等、保持すべきデータ量の想定が増加する可能性がある場合、作成環境のDB領域の空き容量を確認しましょう。
    - また、リリース当日の確認作業、および具体的な閾値とNGの場合の対応方法を手順化しましょう。
- 既存テーブルに変更を行う場合（カラム追加/カラム名称/データ型や項目長の変更）
    - IndexのステータスがInvalidになっているものがないかを確認し、InvalidになっているIndexについては、再作成を実施する手順が盛り込みましょう。

##### 3.2.2データ操作
- データの操作を行う必要がある場合も、極力手動（コマンド、PHPMyAdmin等）での操作は行わないようにしましょう。
    - 構成管理ツールを用いてDMLを実行する形式を用いましょう。
    - 運用管理画面で操作が可能な項目については、極力そちらを利用するようにしましょう。

##### 3.2.3.データ移行
- 環境間でのデータ移行を行う場合は、必ずリハーサルを行いましょう。
- 具体的なチェック項目と切り戻し手順を準備しましょう。

### 3.3.キャッシュについて
- リリースするシステムのキャッシュの種類・使い方について把握しましょう
- 手動でのキャッシュ削除が可能な場合、手順に盛り込みましょう。
- 削除できないキャッシュの場合、キャッシュが切れる時間を把握し関係者に共有しましょう。

## 4.リリース完了後の振り返り

### 4.1.リリース作業実施中、リリース直後に発生したヒヤリハット・障害について
- チェックリスト化する項目の有無を検討し、品質管理テクニカルチームに連携しましょう。
    - Talknoteの「品質管理（システム系プロパー全部入り）」に投稿すること
