# リリースガイドライン

## はじめに
このガイドラインでは、medibaにおける、サービスリリースについてのガイドラインを下記の大項目に分け、それぞれ定めます。

* 1.リリース体制
* 2.リリースの流れ
* 3.リリースコンポーネントごとに留意すべきこと
* 4.リリース完了後

## 1.リリース体制
リリース計画を立てる上で、決めておくべき体制を以下に述べます。

### 1.1.リリース担当者
リリース担当者を明確にしておきましょう。また、リリース後の特別体制による監視を実施する場合はシフトを考慮するようにしましょう。

### 1.2.関係者
社内および社外において、連携が必要な関係者を整理しておきしましょう。その際、連絡手段を決めておきましょう。
意識しておくべき主な関係者を以下に列挙します。
- プロジェクト責任者
- サービス編成担当
- 外部ベンダ担当
- KDDI サービス担当
- 対向システム担当
他、協業CP担当 etc...


### 1.1.3問題発生時の連絡・対応フロー
- リリース作業において問題が発生した場合の連絡およびエスカレーション先や、対応フローを明確にしておきましょう。
- 事前準備が必要なタスクが残っていないか確認しましょう。


## 2.リリースの流れ
リリース作業を実施するにあたり、意識すべき代表的な事項を以下に述べます。

### 2.1.リリースタイムスケジュール
- オンライン、ジョブ、他システム連携などを考慮した上でリリース実施するようにしましょう。
- フロント・バックエンド・DB操作など、リリースの順序による影響を整理し、一番リスクのないリリース順序を検討しましょう。

### 2.2.手順書について
- 手順書を作成したメンバ以外も作業を実施できるよう事前にレビューをしましょう。
    - コンポーネント単位で作業者が違い場合、それぞれのリリース作業の実施タイミングの認識合わせをしましょう。
- 一部コンポーネントを先行リリースを行う場合、他コンポーネントに影響がないことの確認手順をいれましょう。
- 属人的な手順は可能な限り代替手段を検討しましょう。
- 切り戻し手順は準備されていることを確認しましょう。
    - リリースしたものを全てを対象とするか一部を対象にするだけで良いかを意識しましょう。
- リリース作業の間、サービスを一般ユーザーに公開して良いかを確認しましょう。
    - メンテナンスへの切り替えが必要な場合、開始と終了の手順も作成しましょう。
    - メンテナンスの間に、社内よりサービスの動作検証を確認できる方法を用意しておきましょう。
- AWSにおいてはデプロイをAZ単位で実施するなど、可能な限りリスクが少ない手順を検討しましょう。
- 監視設定の無効化の手順が含まれている事を確認しましょう。
- 対向システムとの連携がある場合は、初回稼働のタイミングを明確にしておきましょう。バッチ連携の場合は、手動での初回連携が必要かどうかも意識しましょう。
- LBに関して、サーバ（インスタンス）の切り離しが必要かを確認しましょう。必要な場合は、その手順を盛り込みましょう。
- DB構造の変更および大量データ操作の際は、バックアップとロールバック手順も明確にするとともに作業にかかる正確な時間を把握しておきましょう。
    - 可能であれば正式な手続きを行い、商用またはそれに近い状態のデータにてリハーサルを実施することを推奨します。
- 各種キャッシュに関して、明示的な削除および作成が必要な場合は、その手順を明記しましょう。

### 2.3.作業実施の前に
- 停止するべきジョブやプロセス、プロセスが適切に停止されていることを確認しましょう。
- メンテナンス切替を実施する場合は、社外ネットワークからサービスがメンテナンス状態になっている事を確実に確認しましょう。複数人で確認を取る事を推奨します。
- アラート監視に影響するリリース作業の際は、監視無効化されていることを確認しましょう。
- KCCSの場合は、作業申請の更新を行いましょう。
- 切り戻しの為に必須となる資材のバックアップが適切に行われている事を確認しましょう。ダブルチェックを実施する事を推奨します。

### 2.4.メンテナンス切り替えがある場合

#### 2.4.1.メンテナンス中の検証について

#### 2.4.2.メンテナンス解除

### 2.5.作業経過の報告について


## 3.リリースコンポーネントごとに留意すべきこと
リリース対象のコンポーネントによって留意するべきことを以下に述べます。

### 3.1.アプリケーションデプロイ
- gitを利用してリリース資材を管理している場合は、対象とするブランチの確認および改修内容が確実に含まれていることを確認しましょう。
- 各種キャッシュに関して、デプロイ前の状態が残っていないことを確認しましょう。


#### 3.1.2.デプロイ対象の確認
- デプロイ操作の際は、対象となるサーバ（インスタンス）を確認しましょう。ダブルチェックを実施することを推奨します。
- 対象サーバ(インスタンス)をLBから切り離す必要のある場合は、ログなどからユーザアクセスがないことを確認の上、実施しましょう。

#### 3.1.3.リリース漏れ資材・サーバーのチェック
- TODO:リリース資材の確認フロー
    - 例）リリースすべき資材が環境にきちんと反映されているか、サーバ上ファイルのタイムスタンプを確認しましょう。
    - 例）対象となるサーバが複数ある場合、資材に差分がないか確認しましょう。
    
#### 3.1.4.対向システムとの繋ぎこみ
- 初回の連携においては、ログなどを確認し確実に疎通およびレスポンスが受け取れていることを確認しましょう。
- 想定外のエラーが発生した場合、状況を対向システム担当にすぐ連絡しましょう。
- ファイルI/Fの場合、確認するべき事項を以下に述べます。
    - 送受信フォルダへの書き込み権限が想定通りとなっていること
    - 送受信フォルダの空き容量が充分であること
    - 可能であれば送信先受信先サーバにファイルが正常に送受信されたかを目視で確認すること
    - 送受信ファイルサイズが0バイトなどになっていないこと
    - 送受信ファイルの中身が正常であること
        - 文字コードなどは特に注意すること

### 3.2.DB操作

- 構造/データの変更によりアプリケーションに影響を与える可能性を考慮し、資材のデプロイとの作業順序を決定しましょう。

##### 3.2.1DB構造変更
- テーブル追加等、保持すべきデータ量の想定が増加する可能性がある場合、作成環境のDB領域の空き容量を確認しましょう。
    - また、リリース当日の確認作業、および具体的な閾値とNGの場合の対応方法を手順化しましょう。
- 既存テーブルに変更を行う場合（カラム追加/カラム名称/データ型や項目長の変更）
    - IndexのステータスがInvalidになっているものがないかを確認し、InvalidになっているIndexについては、再作成を実施する手順が盛り込みましょう。

##### 3.2.2データ操作
- データの操作を行う必要がある場合も、極力手動（コマンド、PHPMyAdmin等）での操作は行わないようにしましょう。
    - 構成管理ツールを用いてDMLを実行する形式を用いましょう。
    - 運用管理画面で操作が可能な項目については、極力そちらを利用するようにしましょう。

##### 3.2.3.データ移行
- 環境間でのデータ移行を行う場合は、必ずリハーサルを行いましょう。
- 具体的なチェック項目と切り戻し手順を準備しましょう。

### 3.3.キャッシュについて
- リリースするシステムのキャッシュの種類・使い方について把握しましょう
- 手動でのキャッシュ削除が可能な場合、手順に盛り込みましょう。
- 削除できないキャッシュの場合、キャッシュが切れる時間を把握し関係者に共有しましょう。

## 4.リリース完了後の振り返り

### 4.1.リリース作業実施中、リリース直後に発生したヒヤリハット・障害について

