# アプリケーション開発ガイドライン

## はじめに
このガイドラインでは、medibaにおける、アプリケーション開発についてのガイドラインを下記の大項目に分け、それぞれ定めます。

* 一般的なアプリケーションの作り方
* サーバサイドアプリケーション（API）
* フロントエンドアプリケーション
* スマートフォンアプリケーション

##### 参考にするべきドキュメント
このガイドラインで述べることの一部、特にセキュリティに関連する事項については、以下のドキュメントを参考に作られています。
非常に有用な情報が記載されているので、開発者は自分の領域にかかわらず、必ず目を通しておいてください。

* [OWASP Top 10: Ja](https://www.owasp.org/images/7/79/OWASP_Top_10_2013_JPN.pdf)
* [OWASP Mobile Security Project: En](https://www.owasp.org/index.php/OWASP_Mobile_Security_Project)


## プログラム時の共通注意事項
- 変数の初期化漏れ、初期化タイミング不備はないか。
> 1つ前のリクエスト内容が、変数が初期化されず、引きずられたままになっているなど
- ループ処理で1件ずつ処理するような機能は要注意。メール送信機能での宛先、件名、本文など
- 環境依存となるハードコーディングがされていないこと
> 環境依存となるものはconfigで定義する作りにすること
- 本来の目的と違う目的で、データ項目や変数を流用していないか。
- auIDのログイン済み判定を行う場合、cookieにVTKTが存在することで判断するのではなく、cookieのVTKTの値を使ってcoDeisyに認証確認を行っていること。
- ソースコードとセットでテストコードも準備できているか。
- 既存ロジックの改修や削除を実施する場合、今回の改修箇所以外の部分のデグレに注意すること。
> ロジックが複雑で机上検証での担保が困難な場合は、既存機能の正常ケースをテストケースとして折り込むこと
- ネストが深くなる場合は、関数化を検討すること。
- 変数名には極力意味を持たせ、無意味な一時的な変数は極力使用しないこと。
- 空文字判定処理に注意すること。
> PHPの場合はemptyを使用するなど
- グローバル変数は極力使用しないこと。


## 一般的なアプリケーションの作り方

### SSL
- 個人情報・決済を行う場合は、必ずSSLで通信すること
- SSLを利用する場合、アプリケーション上にHTTPとHTTPS両方でリソースを取得することをしないようにする

### 個人に属する情報の取扱い

### ポイントの取扱い

### クレジットカードの取扱い

### エラーハンドリング

### セッションの取扱い（Cookieの使い方）

### ユーザ管理
#### 登録
#### 削除
#### ログイン

## サーバサイドアプリケーション（API）開発
API（主にRESTFul）を開発する上で留意していただきたい項目を、以下に述べます。

### APIをコールするときの認証方法

### リクエストを正しくハンドリングする方法

### データベースとの連携
- DBの接続パスワードはソースコードにハードコーディングしない
- 環境変数からコールする

#### RMDBを利用する場合
- EXPLAINを利用し、パフォーマンス最適化を実施する

#### KVSを利用する場合
- EXPIRE値が適切に設定されていること。
- 振り分け先設定の指定とweightの設定がなされていること。
  - yiiのcacheのservers設定で、weightの設定が適切になされていること
- 原則、Key値はhash化による自動生成ではなく、Prefix指定とすること。
~~~
 hashKey : false
 keyPrefix : プロジェクト固定(最大文字列長の制約などhash化が必要な場合を除く(hash化のメリットとのトレードオフ))
~~~


### 安全なデバッグの方法
前提として：
- 商用環境でデバッグコードが動作しないこと。
- 不要なデバック用のコードやコメントなど商用環境に相応しくないコメントは削除されていること。

という約束事があります。

安全にデバッグするためには、
- プログラム標準のログレベルを利用するか、デバッグログ専用の関数を用意し、ログレベル同様のフラグ判定関数を設ける
- ログレベルに応じて、出力するログの内容を選択する
- ログレベル自体は、httpdの環境変数に依存するようにする

としてください

### 可用性の維持

### APIが出力するログについて

### リダイレクタ機能

## フロントエンドアプリケーション開発
HTML、Ajax、Single Page Applicationなどのフロントエンドを開発する上で留意していただきたい項目を、以下に述べます。

### ユーザの入力値、DBからのレスポンス値の取扱い

### リクエスト偽造を防ぐ

### ....

## スマートフォンアプリケーション開発

### リバースエンジニアリング対策

### ....
