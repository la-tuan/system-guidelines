# アプリケーション開発ガイドライン

<!-- START doctoc generated TOC please keep comment here to allow auto update -->
<!-- DON'T EDIT THIS SECTION, INSTEAD RE-RUN doctoc TO UPDATE -->


- [1. はじめに](#1-%E3%81%AF%E3%81%98%E3%82%81%E3%81%AB)
      - [参考にするべきドキュメント](#%E5%8F%82%E8%80%83%E3%81%AB%E3%81%99%E3%82%8B%E3%81%B9%E3%81%8D%E3%83%89%E3%82%AD%E3%83%A5%E3%83%A1%E3%83%B3%E3%83%88)
- [2. プログラム時の共通注意事項](#2-%E3%83%97%E3%83%AD%E3%82%B0%E3%83%A9%E3%83%A0%E6%99%82%E3%81%AE%E5%85%B1%E9%80%9A%E6%B3%A8%E6%84%8F%E4%BA%8B%E9%A0%85)
- [3. 一般的なアプリケーションの作り方](#3-%E4%B8%80%E8%88%AC%E7%9A%84%E3%81%AA%E3%82%A2%E3%83%97%E3%83%AA%E3%82%B1%E3%83%BC%E3%82%B7%E3%83%A7%E3%83%B3%E3%81%AE%E4%BD%9C%E3%82%8A%E6%96%B9)
  - [3.1 ユーザ管理](#31-%E3%83%A6%E3%83%BC%E3%82%B6%E7%AE%A1%E7%90%86)
    - [3.1.1 登録](#311-%E7%99%BB%E9%8C%B2)
    - [3.1.2 削除](#312-%E5%89%8A%E9%99%A4)
    - [3.1.3 ログイン](#313-%E3%83%AD%E3%82%B0%E3%82%A4%E3%83%B3)
  - [3.2 個人に属する情報の取扱い](#32-%E5%80%8B%E4%BA%BA%E3%81%AB%E5%B1%9E%E3%81%99%E3%82%8B%E6%83%85%E5%A0%B1%E3%81%AE%E5%8F%96%E6%89%B1%E3%81%84)
  - [3.3 課金に関する取扱](#33-%E8%AA%B2%E9%87%91%E3%81%AB%E9%96%A2%E3%81%99%E3%82%8B%E5%8F%96%E6%89%B1)
    - [3.3.1 決済](#331-%E6%B1%BA%E6%B8%88)
    - [3.3.2 クレジットカード](#332-%E3%82%AF%E3%83%AC%E3%82%B8%E3%83%83%E3%83%88%E3%82%AB%E3%83%BC%E3%83%89)
    - [3.3.3 セキュリティ](#333-%E3%82%BB%E3%82%AD%E3%83%A5%E3%83%AA%E3%83%86%E3%82%A3)
  - [3.4 ポイントの取扱い](#34-%E3%83%9D%E3%82%A4%E3%83%B3%E3%83%88%E3%81%AE%E5%8F%96%E6%89%B1%E3%81%84)
  - [3.5 エラーハンドリング](#35-%E3%82%A8%E3%83%A9%E3%83%BC%E3%83%8F%E3%83%B3%E3%83%89%E3%83%AA%E3%83%B3%E3%82%B0)
  - [3.6 セッションの取扱い](#36-%E3%82%BB%E3%83%83%E3%82%B7%E3%83%A7%E3%83%B3%E3%81%AE%E5%8F%96%E6%89%B1%E3%81%84)
  - [3.7 キャッシュの扱い](#37-%E3%82%AD%E3%83%A3%E3%83%83%E3%82%B7%E3%83%A5%E3%81%AE%E6%89%B1%E3%81%84)
  - [3.8 Cookieの取扱い](#38-cookie%E3%81%AE%E5%8F%96%E6%89%B1%E3%81%84)
  - [3.9 タグの扱い](#39-%E3%82%BF%E3%82%B0%E3%81%AE%E6%89%B1%E3%81%84)
- [4. サーバサイドアプリケーション（API）開発](#4-%E3%82%B5%E3%83%BC%E3%83%90%E3%82%B5%E3%82%A4%E3%83%89%E3%82%A2%E3%83%97%E3%83%AA%E3%82%B1%E3%83%BC%E3%82%B7%E3%83%A7%E3%83%B3api%E9%96%8B%E7%99%BA)
  - [4.1 APIをコールするときの認証方法](#41-api%E3%82%92%E3%82%B3%E3%83%BC%E3%83%AB%E3%81%99%E3%82%8B%E3%81%A8%E3%81%8D%E3%81%AE%E8%AA%8D%E8%A8%BC%E6%96%B9%E6%B3%95)
  - [4.2 リクエストを正しくハンドリングする方法](#42-%E3%83%AA%E3%82%AF%E3%82%A8%E3%82%B9%E3%83%88%E3%82%92%E6%AD%A3%E3%81%97%E3%81%8F%E3%83%8F%E3%83%B3%E3%83%89%E3%83%AA%E3%83%B3%E3%82%B0%E3%81%99%E3%82%8B%E6%96%B9%E6%B3%95)
  - [4.3 データベースとの連携](#43-%E3%83%87%E3%83%BC%E3%82%BF%E3%83%99%E3%83%BC%E3%82%B9%E3%81%A8%E3%81%AE%E9%80%A3%E6%90%BA)
    - [4.3.1 RMDBを利用する場合](#431-rmdb%E3%82%92%E5%88%A9%E7%94%A8%E3%81%99%E3%82%8B%E5%A0%B4%E5%90%88)
    - [4.3.2 KVSを利用する場合](#432-kvs%E3%82%92%E5%88%A9%E7%94%A8%E3%81%99%E3%82%8B%E5%A0%B4%E5%90%88)
  - [4.4 安全なデバッグの方法](#44-%E5%AE%89%E5%85%A8%E3%81%AA%E3%83%87%E3%83%90%E3%83%83%E3%82%B0%E3%81%AE%E6%96%B9%E6%B3%95)
  - [4.5 可用性の維持](#45-%E5%8F%AF%E7%94%A8%E6%80%A7%E3%81%AE%E7%B6%AD%E6%8C%81)
  - [4.6 APIが出力するログについて](#46-api%E3%81%8C%E5%87%BA%E5%8A%9B%E3%81%99%E3%82%8B%E3%83%AD%E3%82%B0%E3%81%AB%E3%81%A4%E3%81%84%E3%81%A6)
  - [4.7 リダイレクタ機能](#47-%E3%83%AA%E3%83%80%E3%82%A4%E3%83%AC%E3%82%AF%E3%82%BF%E6%A9%9F%E8%83%BD)
  - [4.8 バージョン管理](#48-%E3%83%90%E3%83%BC%E3%82%B8%E3%83%A7%E3%83%B3%E7%AE%A1%E7%90%86)
- [5. フロントエンドアプリケーション開発](#5-%E3%83%95%E3%83%AD%E3%83%B3%E3%83%88%E3%82%A8%E3%83%B3%E3%83%89%E3%82%A2%E3%83%97%E3%83%AA%E3%82%B1%E3%83%BC%E3%82%B7%E3%83%A7%E3%83%B3%E9%96%8B%E7%99%BA)
  - [5.1 ユーザの入力値、DBからのレスポンス値の取扱い](#51-%E3%83%A6%E3%83%BC%E3%82%B6%E3%81%AE%E5%85%A5%E5%8A%9B%E5%80%A4db%E3%81%8B%E3%82%89%E3%81%AE%E3%83%AC%E3%82%B9%E3%83%9D%E3%83%B3%E3%82%B9%E5%80%A4%E3%81%AE%E5%8F%96%E6%89%B1%E3%81%84)
  - [5.2 リクエスト偽造を防ぐ](#52-%E3%83%AA%E3%82%AF%E3%82%A8%E3%82%B9%E3%83%88%E5%81%BD%E9%80%A0%E3%82%92%E9%98%B2%E3%81%90)
  - [5.3 JSONPの利用について](#53-jsonp%E3%81%AE%E5%88%A9%E7%94%A8%E3%81%AB%E3%81%A4%E3%81%84%E3%81%A6)
  - [5.4 他者の作成したJavascript](#54-%E4%BB%96%E8%80%85%E3%81%AE%E4%BD%9C%E6%88%90%E3%81%97%E3%81%9Fjavascript)
- [6. スマートフォンアプリケーション開発](#6-%E3%82%B9%E3%83%9E%E3%83%BC%E3%83%88%E3%83%95%E3%82%A9%E3%83%B3%E3%82%A2%E3%83%97%E3%83%AA%E3%82%B1%E3%83%BC%E3%82%B7%E3%83%A7%E3%83%B3%E9%96%8B%E7%99%BA)
  - [6.1 認証とパスワードマネジメント](#61-%E8%AA%8D%E8%A8%BC%E3%81%A8%E3%83%91%E3%82%B9%E3%83%AF%E3%83%BC%E3%83%89%E3%83%9E%E3%83%8D%E3%82%B8%E3%83%A1%E3%83%B3%E3%83%88)
  - [6.2 リバースエンジニアリング対策](#62-%E3%83%AA%E3%83%90%E3%83%BC%E3%82%B9%E3%82%A8%E3%83%B3%E3%82%B8%E3%83%8B%E3%82%A2%E3%83%AA%E3%83%B3%E3%82%B0%E5%AF%BE%E7%AD%96)
  - [6.3 通信](#63-%E9%80%9A%E4%BF%A1)
  - [6.4 データの安全な保管方法](#64-%E3%83%87%E3%83%BC%E3%82%BF%E3%81%AE%E5%AE%89%E5%85%A8%E3%81%AA%E4%BF%9D%E7%AE%A1%E6%96%B9%E6%B3%95)
  - [6.5 セッションマネジメント](#65-%E3%82%BB%E3%83%83%E3%82%B7%E3%83%A7%E3%83%B3%E3%83%9E%E3%83%8D%E3%82%B8%E3%83%A1%E3%83%B3%E3%83%88)
  - [6.6 サードパーティのライブラリやコードの使用について](#66-%E3%82%B5%E3%83%BC%E3%83%89%E3%83%91%E3%83%BC%E3%83%86%E3%82%A3%E3%81%AE%E3%83%A9%E3%82%A4%E3%83%96%E3%83%A9%E3%83%AA%E3%82%84%E3%82%B3%E3%83%BC%E3%83%89%E3%81%AE%E4%BD%BF%E7%94%A8%E3%81%AB%E3%81%A4%E3%81%84%E3%81%A6)
  - [6.7 プロビジョニング・配布・テストについて](#67-%E3%83%97%E3%83%AD%E3%83%93%E3%82%B8%E3%83%A7%E3%83%8B%E3%83%B3%E3%82%B0%E3%83%BB%E9%85%8D%E5%B8%83%E3%83%BB%E3%83%86%E3%82%B9%E3%83%88%E3%81%AB%E3%81%A4%E3%81%84%E3%81%A6)
- [7. 個人情報を取り扱う社内アプリケーション](#7-%E5%80%8B%E4%BA%BA%E6%83%85%E5%A0%B1%E3%82%92%E5%8F%96%E3%82%8A%E6%89%B1%E3%81%86%E7%A4%BE%E5%86%85%E3%82%A2%E3%83%97%E3%83%AA%E3%82%B1%E3%83%BC%E3%82%B7%E3%83%A7%E3%83%B3)

<!-- END doctoc generated TOC please keep comment here to allow auto update -->

## 1. はじめに
このガイドラインでは、medibaにおける、アプリケーション開発についてのガイドラインを下記の大項目に分け、それぞれ定めます。

* 一般的なアプリケーションの作り方
* サーバサイドアプリケーション（API）
* フロントエンドアプリケーション
* スマートフォンアプリケーション
* 個人情報を取り扱う社内アプリケーション

##### 参考にするべきドキュメント
このガイドラインで述べることの一部、特にセキュリティに関連する事項については、以下のドキュメントを参考に作られています。
非常に有用な情報が記載されているので、開発者は自分の領域にかかわらず、必ず目を通しておいてください。

* [OWASP Top 10: Ja](https://www.owasp.org/images/7/79/OWASP_Top_10_2013_JPN.pdf)
* [OWASP Mobile Security Project: En](https://www.owasp.org/index.php/OWASP_Mobile_Security_Project)


## 2. プログラム時の共通注意事項
- 変数の初期化漏れ、初期化タイミングの不備はないか
  > 1つ前のリクエスト内容が、変数が初期化されず、引きずられたままになっているなど

- ループ処理で1件ずつ処理するような機能は要注意
  > メール送信機能での宛先、件名、本文など
- 環境依存となるハードコーディングがされていないこと
  > 環境依存となるものはconfigで定義する作りにすること

- 本来の目的と違う目的で、データ項目や変数を流用していないか
- auIDのログイン済み判定を行う場合、cookieにVTKTが存在することで判断するのではなく、cookieのVTKTの値を使ってcoDeisyに認証確認を行っていること
- ソースコードとセットでテストコードも準備できているか
- 既存ロジックの改修や削除を実施する場合、今回の改修箇所以外の部分のデグレに注意すること
  > ロジックが複雑で机上検証での担保が困難な場合は、既存機能の正常ケースをテストケースとして折り込むこと

- ネストが深くなる場合は、関数化を検討すること
- 変数名には極力意味を持たせ、無意味な名称の一時的な変数は極力使用しないこと
- 空文字判定処理に注意すること
  > PHPの場合はemptyを使用するなど

- グローバル変数は極力使用しないこと


## 3. 一般的なアプリケーションの作り方

### 3.1 ユーザ管理

- 個人情報の取扱い、決済処理を行う場合は、必ずSSLで通信すること
- SSLを利用する場合、アプリケーションにおけるリソースの取得に、HTTPとHTTPS両方を用いないように実装すること

#### 3.1.1 登録
- プライバシーポリシーに同意させる画面遷移を作成すること
- DB上でユーザを一意に特定できるIDを必ず用意すること
- パスワードは一方向ハッシュを利用する
 > ハッシュの計算においてSaltを使用し、同一のパスワードであっても別の値になるよう実装すること
- パスワード作成のためのハッシュ関数は、*bcrypt* を推奨する
- ボットなどによる、機械的なアカウント作成やアクセスに対しては、サービスの性質に応じてCAPTCHAなどによる対策を実装すること

#### 3.1.2 削除
- 論理削除の場合は、プライバシーポリシーにのっとり、適切に削除すること（不要な情報のマスキング、属性情報の削除など）

#### 3.1.3 ログイン
- 同一IDに対しての複数回ログイン試行に対し、原則としてアカウントロックするなどの対策を実装することを推奨する(5回以上を目安）
  > ロック後は一定期間ロックアウトするか、システムの重要度によってパスワード再発行の処理を組み込むこと

### 3.2 個人に属する情報の取扱い
- Geoデータ、顔写真は個人情報と同等の管理を要する


### 3.3 課金に関する取扱

#### 3.3.1 決済
- auサービスは、auかんたん決済を原則利用すること
  > *auかんたん決済以外は必要に応じて定義していきます*

#### 3.3.2 クレジットカード
- 原則としてmedibaではカード番号を保管しない
- カード番号を平文のまま保管しないこと
- アクセスログに記録されないよう、POSTメソッドで送信すること
- カード番号の先頭6桁および末尾4桁については保存可とする

#### 3.3.3 セキュリティ
- セキュリティルームからのみ商用環境へ接続可能とする
  > もしくは、許可された者が特定の端末を用いてのみ接続可能とする
- 品質管理部による承認を得てのみリリース可能とする
  > 開発に関わるすべてのレビューで承認を得ること
- 個人情報及び決済情報は、コンテンツなどと別のデータベースで管理すること

### 3.4 ポイントの取扱い
- ポイントには仮付与、確定付与、取り消しと複数の状態があるため、状態に応じたポイント処理が実行されるよう考慮して設計を行うこと
- ポイントには通貨価値があるため課金システムと同等のセキュリティを担保すること

### 3.5 エラーハンドリング
* 画面表示
  - 予期せぬ例外（接続エラー、データ不整合など）が起こった際にも適切なエラー画面の表示が行われるよう配慮すること
  - 条件分岐においてdefaultやelseの値を定義すること
  - PHPの場合、try/catchを利用すること
* タイムアウトの設定
  * 対向システムとの接続や、バッチ等のデータ処理にはタイムアウトを設定し、超えた場合はエラー処理を行うこと
  * タイムアウト設定値は、対向システムやミドルウェアとの整合性が取れた値で設定すること
* ログの出力
  *  ERROR/WARNING時にログが出力されるよう設定すること
  * ログの出力項目についてはログガイドラインを参照
* 監視設定
  * 全てのサービスは原則として監視システムと連携を行うこと
  * 監視の設定には、アラートレベルを適切に設定すること

### 3.6 セッションの取扱い
- セッション管理は原則としてDBを利用すること
- セッションIDはフレームワークに付随している生成ロジックを利用するか、独自に実装する場合は、容易に推測できないよう実装し、利用すること

### 3.7 キャッシュの扱い
- すべてのリクエストに対してキャッシュ有無を明確にし影響範囲を把握すること
  > cache-controlを設定していない場合、ブラウザに依存するため意図しない挙動が起きうる
- 必ずexpireを設定すること
- どのレイヤーで何がいつまでキャッシュされるか明確化し設計すること

### 3.8 Cookieの取扱い
サービス毎(もしくはドメイン毎)にCookie管理を行ない、下記の通り取扱いを注意する。

- 保存に関する注意
  - 個人情報や、個人に属する情報は保存しないこと
  - 同一Cookieに、4KB以上のデータは保管しないこと
  - ExpireもしくはMax-ageを必ず設定し永続的な期間設定はしない(Max-ageが優先される)
- 発行に関する注意
  - Cookie名は同じものを流用すると思わぬ弊害が出るため必ず確認すること
  - auone.jp及びauone.jpサブドメインにおけるCookieの使用については、必要に応じてKDDIにも確認すること
  - ExpireとMax-ageを省略することで現在セッション終了までが有効期間となります

### 3.9 タグの扱い

以下のようなタグは意図しない動作を引き起こす可能性があるため、管理し影響範囲を把握しておく必要があります。

- 広告タグ
- 計測タグ
- ワンタグ

## 4. サーバサイドアプリケーション（API）開発
API（主にRESTFul）を開発する上で留意していただきたい項目を、以下に述べます。

### 4.1 APIをコールするときの認証方法
- APIが特定のサーバからのみリクエストを受け付けたい場合は、トークンベースでの認証を用いる
- 発行されるトークンは、サービスごとに異なるようにすること
- トークンは、HTTPヘッダに載せ、HTTPSで通信すること

### 4.2 リクエストを正しくハンドリングする方法
- ユーザからのリクエストは想定外なものが来る、という想定でいること
- バリデーションは処理の前段階で行うこと
- リクエストされたものを、そのままDBに格納せず、（加工しない）格納したくないものはエラーとして拒否すること

### 4.3 データベースとの連携
- DBの接続パスワードはソースコードにハードコーディングしないこと
- 環境変数からコールすること
- 特別な要件がない限り、ローカルのネットワークを利用すること

#### 4.3.1 RMDBを利用する場合
- EXPLAINを利用し、パフォーマンス最適化を実施すること
- 必ずprepareステートメントを利用し、直接DBに値を渡さないこと

#### 4.3.2 KVSを利用する場合
- EXPIRE値が適切に設定されていること
- 振り分け先設定の指定とweightの設定がなされていること
  - yiiのcacheにおけるservers設定で、weightの設定が適切になされていること
- 原則、Key値はhash化による自動生成ではなく、Prefix指定とすること
  - hashKey : false
  - keyPrefix : プロジェクト固定(最大文字列長の制約などhash化が必要な場合を除く(hash化のメリットとのトレードオフ))

### 4.4 安全なデバッグの方法
前提として：
- 商用環境でデバッグコードが動作しないこと
- 不要なデバック用のコードやコメントなど商用環境に相応しくないコメントは削除されていること

という約束事があります。

安全にデバッグするためには、
- プログラム標準のログレベルを利用するか、デバッグログ専用の関数を用意し、ログレベル同様のフラグ判定関数を設ける
- ログレベルに応じて、出力するログの内容を選択する
- ログレベル自体は、httpdの環境変数に依存するようにする

としてください。

### 4.5 可用性の維持
- 複数台でAPIを運用することを想定した設計にすること
  - ローカルディスクに共有データを書き込まないこと

### 4.6 APIが出力するログについて
- AWSを想定し、ログはサーバ名、タイムスタンプなどを明記すること
- ログレベルを運用フェーズで切り分け、デバッグログは本番環境では出力しないようにすること

### 4.7 リダイレクタ機能
- リダイレクト先はDBで管理する、またはシグネチャを用い許可されたURLに対してのみリダイレクトすること

### 4.8 バージョン管理
- バージョンを管理し、各バージョンへのアクセス状態を把握出来るようにしておくこと
- バージョンによって処理を制御し、健全な状態を維持すること

## 5. フロントエンドアプリケーション開発
HTML、Ajax、Single Page Applicationなどのフロントエンドを開発する上で留意していただきたい項目を、以下に述べます。

### 5.1 ユーザの入力値、DBからのレスポンス値の取扱い
- DOM経由での値の操作は、不正な文字列が含まれることを前提に、かならずtext関数等を用いてサニタイズすること
- APIやDBからの返り値を出力する際は、XSS対策としてかならずエスケープしサニタイズすること

### 5.2 リクエスト偽造を防ぐ
- フロントエンドからAPIにリクエストを送信する際は、リクエストの偽造を防ぐため（CSRF対策）に、以下のいずれかの値を利用すること
  - サーバ側で生成したトークン
  - セッションID（最近はフレームワークが対応しているものが多い）

### 5.3 JSONPの利用について
- 原則としてJSONPは利用しないこと
  - どうしても利用が必要な場合は、プログラムソースの安全性をレビューし確認した上で、JSONP経由でアクセスさせるファイルの中の情報に機微なものが含まれないように実装すること

### 5.4 他者の作成したJavascript
- 広告などの表示のため、他者が作成したJavascriptを読み込む必要がある場合は、信頼のおける配信元からのみJavascriptを許可すること
- StaticなJavascriptのソース・ファイルが好ましいが、そうでない場合は当該Javascriptが把握していないサイトから読み込まれないようHTTPのトランザクション等を利用して検査すること
- 難読化された外部Javascriptはセキュリティ上の理由として拒否すること

## 6. スマートフォンアプリケーション開発

### 6.1 認証とパスワードマネジメント
- 認証を必要とするコンテンツ（プレミアムコンテンツなど）は、PINは利用せず、パスワード（ポリシーに基づく）を認証に用いること
  - まれにデバイス自体がパスワード生成機能を持っている場合があるが、エントロピーが怪しいので利用しないこと
  - iOSが提供している指紋認証以外の生体認証は、まだ確かな技術となっていないので利用しないこと
- メモリ上にパスワードを保持する場合は、利用が終わったあとに、必ずメモリ上から消去すること
- 提供するサービスが、課金に関するものなど非常に機微な情報を扱う場合は、多要素認証を導入すること
- デバイス認証が必要な場合は、UIDやMACアドレスは利用せず、インストールやアカウント登録時にデバイストークンを生成すること
  - 生成方法は、hash(ランダムキー＋OSバージョン＋現在の日時＋パッケージファイル名）などとし、別デバイスで同様のハッシュ値が計算されないよう完全ユニーク化する
  - このデバイストークンは、セッションIDや暗号化のキーとして利用が可能となる
- パスワードを間違えた場合は、2秒ほどのDelayを意図して発生させ、10回程度の試行を目安にロックアウトさせること
- ハッシュの生成は、SHA-2を用いること
- ユーザがパスワードを作成する際に、強度を知らせることを推奨する

### 6.2 リバースエンジニアリング対策
- 静的なCのライブラリとして抽象化すること
- 有料またはオープンソースのツールを使い、コード全体を難読化すること
- デバッガをプロセスにアタッチされないようにすること
  - 例）android:debuggable="false"
- 特にAndroidにおいてはリブート前に書き出されたログがどのアプリケーションでも読める状態なので、ロギングはオフにすること
- iOS4.3, Android4.0未満は、メモリの中身がダンプできるため対象外とすること

### 6.3 通信
- ISPから提供されている回線やWiFiは安全ではないという前提のもとでアプリケーションを設計すること
- SSL証明書が有効であることをかならずチェックすること
- アプリケーションと通信する先のドメインをチェックすること（特にアプリケーションを内部でアップデートする場合は、トークンを確認し合い、許可されたシステムからの通信においてのみアップデートを許可すること）
- SSLStripなどを用いてHTTPSの通信を改ざんするツールなどの対策として、HTTPの通信を拒否するような仕組みを導入すること
- 可能ならば、UI上でSSL通信していることがわかるようにすること
- 信頼されたCAで署名された証明書を利用すること

### 6.4 データの安全な保管方法
- どのようなデータをデバイスに保存するか、区別し、そのレベルに応じてデータの保管・使用方法を分けるようにすること
- 機微な情報はデバイスに保存せず、サーバサイドに保存するように実装すること
- キャッシュデータや一時データを共有ストレージに保存しない
- 機微な情報を保存する場合は、AESなどを利用して暗号化してから保存する（キャッシュやログに表示されないよう注意すること）
- 暗号鍵を生成する場合は、PBKDF2を利用し、ハッシュ値をストレッチする（システムのキャパシティにもよるが、1000回程度）
- 暗号鍵はメモリ上でも最低限の時間だけ保存し、利用が終わったら即時消去する
- パスワードは絶対に平文で保存しない！
- iOSにおいてパスワードやその他のデータサイズの小さい機密性の高いデータ片(鍵やログイントークンなど)を保存する際は、iOSキーチェーンを利用する。
- 機微な情報をUI上で表示する場合、表示が終わったら、すぐにメモリ上から消去すること
- 一般的なstringの変数に機微な情報は保存せず、配列などを利用する（メモリ上で新しい値が代入されてもまだ参照できるケースがある）
- SDカードなどの外付けのストレージに機微な情報を保存しないこと
- リモートワイプなどを利用して機微な情報を削除できる仕組みを取り入れておくこと
- アカウント番号など、ユーザに直接表示する必要のないデータはトークンなどで代用し、デバイス上に不必要な機微な情報は保管にしないようにすること

### 6.5 セッションマネジメント
- ユーザのログインステータスを、アプリケーションがアクティベートし、画面遷移時にチェックすること
- ユーザのセッションが切れた場合は、メモリを開放すること
- サーバサイド側でセッションIDを無効化できるよう設計すること
- 期限が切れたセッションを無効化するために、タイムアウト値は少なめに取っておくことを推奨する

### 6.6 サードパーティのライブラリやコードの使用について
- 信頼できるライブラリかどうか、利用前にチェックを行うこと
  - 社内で共有し、承認を取るように仕組み化しておくこと
- 利用するフレームワークの名称、バージョンを管理し、パッチや脆弱性情報を把握しておくこと
- アドネットワークなど、外部からのリソース提供（Javascript等）がある場合は、特に注意をはらい安全かどうかを事前に確認すること

### 6.7 プロビジョニング・配布・テストについて
- 提供側でアプリバージョンのコントールが出来るように強制アップデートを実装しておくこと
- セキュリティに関する問題がある古いバージョンのアプリケーションは、AppStoreなどから削除しておくこと
- 定期的にAPIの脆弱性テストを実施しておくこと
- リリース前に、難読化処理が行われているか確認しておくこと
- 信頼されたCAから発行された証明書を利用し、アプリケーションに対して署名を行うこと


## 7. 個人情報を取り扱う社内アプリケーション

個人情報を取り扱う社内アプリケーションを開発する場合は、以下の点に注意してください。

- 全件を一括でダウンロードできる機能は原則として設けない
- 閲覧、編集、削除などはNeed-to-knowをベースに、必要な職務に対して権限を分割して付与できるアーキテクチャとして設計すること
- 操作履歴を取得できる設計としておくこと
  - 操作履歴は最低1年間は保存すること
- アクセス元を制限すること
- メールアドレス、住所や電話番号は、本当に必要な画面以外ではアスタリスクで一部マスキングする
- GETリクエストに個人情報を含ませないこと
