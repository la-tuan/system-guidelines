# アプリケーション開発ガイドライン

## 1. はじめに
このガイドラインでは、medibaにおける、アプリケーション開発についてのガイドラインを下記の大項目に分け、それぞれ定めます。

* 一般的なアプリケーションの作り方
* サーバサイドアプリケーション（API）
* フロントエンドアプリケーション
* スマートフォンアプリケーション

##### 参考にするべきドキュメント
このガイドラインで述べることの一部、特にセキュリティに関連する事項については、以下のドキュメントを参考に作られています。
非常に有用な情報が記載されているので、開発者は自分の領域にかかわらず、必ず目を通しておいてください。

* [OWASP Top 10: Ja](https://www.owasp.org/images/7/79/OWASP_Top_10_2013_JPN.pdf)
* [OWASP Mobile Security Project: En](https://www.owasp.org/index.php/OWASP_Mobile_Security_Project)


## 2. プログラム時の共通注意事項
- 変数の初期化漏れ、初期化タイミング不備はないか。
  > 1つ前のリクエスト内容が、変数が初期化されず、引きずられたままになっているなど

- ループ処理で1件ずつ処理するような機能は要注意。メール送信機能での宛先、件名、本文など
- 環境依存となるハードコーディングがされていないこと
  > 環境依存となるものはconfigで定義する作りにすること

- 本来の目的と違う目的で、データ項目や変数を流用していないか。
- auIDのログイン済み判定を行う場合、cookieにVTKTが存在することで判断するのではなく、cookieのVTKTの値を使ってcoDeisyに認証確認を行っていること。
- ソースコードとセットでテストコードも準備できているか。
- 既存ロジックの改修や削除を実施する場合、今回の改修箇所以外の部分のデグレに注意すること。
  > ロジックが複雑で机上検証での担保が困難な場合は、既存機能の正常ケースをテストケースとして折り込むこと

- ネストが深くなる場合は、関数化を検討すること。
- 変数名には極力意味を持たせ、無意味な一時的な変数は極力使用しないこと。
- 空文字判定処理に注意すること。
  > PHPの場合はemptyを使用するなど

- グローバル変数は極力使用しないこと。


## 3. 一般的なアプリケーションの作り方

### 3.1 SSL
- 個人情報・決済を行う場合は、必ずSSLで通信すること
- SSLを利用する場合、アプリケーション上にHTTPとHTTPS両方でリソースを取得することをしないようにする

### 3.2 個人に属する情報の取扱い
- Geoデータ、顔写真は個人情報と同等の管理を要する

### 3.3 ポイントの取扱い
- // 何書こう…

### 3.4 クレジットカードの取扱い
- 原則的にmedibaではカード番号を保管しない
- カード番号はPlainのまま保管しない。ログにも落ちないよう、POSTで管理する
- カード番号の先頭６桁、末尾４桁は保存しても可

### 3.5 エラーハンドリング
* 画面表示を適切に行う
  * 予期せぬ例外（接続エラー、データ不整合など）が起こった際にも適切なエラー画面の表示が行われるよう配慮すること
    * 条件分岐でdefaultやelseの値を定義すること
    * PHPの場合、try/catchを利用すること
* タイムアウトの設定
  * 対向システムとの接続や、バッチ等のデータ処理にはタイムアウトを設定し、超えた場合はエラー処理を行うこと
* ログの出力
 * ERROR/WARNING時にログが出力されるよう設定すること
 * ログの出力項目についてはログガイドラインを参照
* 監視設定
 * 全てのサービスは原則的に監視システムと連携を行うこと
 * 監視の設定により、アラートレベルを適切に設定すること
 
### 3.6 セッションの取扱い
- セッション管理は原則的にDBを利用する
- セッションIDはフレームワークに付随しているものを利用するか、独自に実装する場合は、安易に推測できるものを利用してはならない。

### 3.7 セッションの取扱い
- Cookieには個人情報や、個人に属する情報はrawデータで保存しない
- 同一Cookieに、4KB以上のデータは保管しない
- 新しいCookieを発行する場合は、CTOの許可を取る

### 3.8 ユーザ管理
ユーザ情報を取り扱う場合は、必ずSSLを利用のこと

#### 3.8.1 登録
- プライバシーポリシーに同意させる画面遷移を作成する
- DB上でユーザを一位に特定できるIDを必ず用意すること
- パスワードは一方向ハッシュを利用する。Saltも用意し、同一のパスワードであっても別の値になるよう工夫すること
- パスワード作成のためのハッシュ関数は、bcryptを推奨
- ボットを利用され、無制限にアカウントが作成されては困るサービスは、CAPTCHAなどを利用すること。

#### 3.8.2 削除
- 論理削除の場合は、プライバシーポリシーにのっとり、適切に削除する（不要な情報のマスキング、属性情報の削除など）

#### 3.8.3 ログイン
- 同一IDに対しての複数回ログイン試行は、原則的にアカウントロックなどを設けて制御するべき。(１０回以上）

## 4. サーバサイドアプリケーション（API）開発
API（主にRESTFul）を開発する上で留意していただきたい項目を、以下に述べます。

### 4.1 APIをコールするときの認証方法
- APIが特定のサーバからのみリクエストを受け付けたい場合は、トークンベースでの認証を用いる。
- 発行されるトークンは、サービスごとに異なるようにする
- トークンは、HTTPヘッダに載せ、HTTPSで通信する

### 4.2 リクエストを正しくハンドリングする方法
- ユーザからのリクエストは想定外なものが来る、という想定でいる
- バリデーションは処理の前段階で行うこと
- リクエストされたものを、そのままDBに格納するようにする（加工しない）。格納したくないものはエラーとして拒否すること。

### 4.3 データベースとの連携
- DBの接続パスワードはソースコードにハードコーディングしない
- 環境変数からコールする
- 特別な要件がない限り、ローカルのネットワークを利用すること

#### 4.3.1 RMDBを利用する場合
- EXPLAINを利用し、パフォーマンス最適化を実施する
- かならずprepareステートメントを利用し、直接DBに値を渡さないこと

#### 4.3.2 KVSを利用する場合
- EXPIRE値が適切に設定されていること。
- 振り分け先設定の指定とweightの設定がなされていること。
  - yiiのcacheのservers設定で、weightの設定が適切になされていること
- 原則、Key値はhash化による自動生成ではなく、Prefix指定とすること。
~~~
 hashKey : false
 keyPrefix : プロジェクト固定(最大文字列長の制約などhash化が必要な場合を除く(hash化のメリットとのトレードオフ))
~~~

### 4.4 安全なデバッグの方法
前提として：
- 商用環境でデバッグコードが動作しないこと。
- 不要なデバック用のコードやコメントなど商用環境に相応しくないコメントは削除されていること。

という約束事があります。

安全にデバッグするためには、
- プログラム標準のログレベルを利用するか、デバッグログ専用の関数を用意し、ログレベル同様のフラグ判定関数を設ける
- ログレベルに応じて、出力するログの内容を選択する
- ログレベル自体は、httpdの環境変数に依存するようにする

としてください

### 4.5 可用性の維持
- 複数台でAPIを運用することを想定した設計にすること
  - ディスクに共有データを書き込まない

### 4.6 APIが出力するログについて
- AWSを想定し、ログはサーバ名、タイムスタンプなどを明記すること。
- ログレベルを運用フェーズで切り分け、デバッグログは本番環境では出力しないようにすること

### 4.7 リダイレクタ機能
- リダイレクト先はDBで管理する、またはシグネチャを用い許可されたURLに対してのみリダイレクトすること

## 5. フロントエンドアプリケーション開発
HTML、Ajax、Single Page Applicationなどのフロントエンドを開発する上で留意していただきたい項目を、以下に述べます。

### 5.1 ユーザの入力値、DBからのレスポンス値の取扱い
- DOM経由での値の操作は、不正な文字列が含まれることを前提に、かならずtext関数等を用いてサニタイズすること
- APIやDBからの返り値を出力する際は、XSS対策としてかならずエスケープしサニタイズすること

### 5.2 リクエスト偽造を防ぐ
- フロントエンドからAPIにリクエストを送信する際は、リクエストの偽造を防ぐため（CSRF対策）に、以下のいずれかの値を利用すること
  - サーバ側で生成したトークン
  - セッションID
（最近はフレームワークが対応しているものが多い）

## 6. スマートフォンアプリケーション開発

### 6.1 認証とパスワードマネジメント
- 認証を必要とするコンテンツ（プレミアムコンテンツなど）は、PINは利用せず、パスワード（ポリシーに基づく）を用いること
  - まれにデバイス自体がパスワード生成機能を持っている場合があるが、エントロピーが怪しいので利用しない。
  - iOSが提供している指紋認証以外の生体認証は、まだ確かな技術となっていないので利用しない。
- メモリ上にパスワードを保持する場合は、利用が終わったあとに、必ずメモリ上から消去する
- 提供するサービスが、課金に関するものなど非常ニキビな情報を扱う場合は、多要素認証を導入すること。
- デバイス認証が必要な場合は、UIDやMACアドレスは利用せず、インストールやアカウント登録時にデバイストークンを生成する。
  - 生成方法としては、hash(ランダムキー＋OSバージョン＋現在の日時＋パッケージファイル名）などとし、別デバイスで同様のハッシュ値が計算されないよう完全ユニーク化する。
  - このデバイストークンは、セッションIDや暗号化のキーとして利用が可能となる。
- パスワードを間違えた場合は、2秒ほどDelayをわざと起こさせ、10回程度でロックアウトさせる
- ハッシュの生成は、SHA-2を用いること
- パスワードはソルトを利用して生成すること。ソルトは十分な長さを持つ必要あり（生成されるハッシュ値の長さと同等かそれ以上）で、かつユニークである必要がある。MACアドレスや上述のデバイストークンを使うと良い。
- ユーザがパスワードを作成する際に、強度を知らせると良い

### 6.2 リバースエンジニアリング対策
- 静的なCのライブラリとして抽象化する
- 有料またはオープンソースのツールを使い、コード全体を難読化する
- デバッガをプロセスにアタッチされないようにする。例）android:debuggable="false"
- 特にAndroidではリブート前に書き出されたログはどのアプリケーションでも読める状態なので、ロギングはオフにする
- iOS4.3, Android4.0未満は、メモリの中身がダンプできるので利用しない

### 6.3 通信
- ISPから提供されている回線やWiFiは安全でないという推定でアプリケーションを設計すること。
- SSL証明書が有効であることをかならずチェックする。
- アプリケーションと通信する先のドメインをチェックする。特にアプリケーションを内部でアップデートする場合は、トークンを確認し合い、許可されたシステムからの通信のみ許可するようにする。
- SSLStripなどを用いてHTTPSの通信を改ざんするツールなどの対策として、HTTPの通信を拒否するような仕組みを導入する。
- 可能ならば、UI上でSSL通信していることがわかるようにする。
- 信頼されたCAで署名された証明書を利用する

### 6.4 データの安全な保管方法
- どのようなデータをデバイスに保存するか、区別し、そのレベルに応じてデータの保管・使用方法を分けるようにする
- 機微な情報はサーバサイドに保存するようにする。
- キャッシュデータや一時データを共有ストレージに保存しない。
- 機微な情報を保存する場合は、AESなどを利用して暗号化してから保存する。キャッシュやログに表示されないよう注意すること。
- 暗号鍵を生成する場合は、PBKDF2を利用し、ハッシュ値をストレッチする。（システムのキャパシティにもよるが、1000回程度）
- 暗号鍵はメモリ上でも最低限の時間だけ保存し、利用が終わったら即時消去する。
- パスワードは絶対に平文で保存しない！
- iOSのキーチェインの中に、平文で機微な情報を保存しない（iOSのキーチェインは怪しい）
- 機微な情報をUI上で表示する場合、表示が終わったら、すぐにメモリ上から消去すること。
- 一般的なstringの変数に機微な情報は保存せず、配列などを利用する。（メモリ上で新しい値が代入されてもまだ参照できるケースがある）
- SDカードなどの外付けのストレージに機微な情報は保存しない
- リモートワイプなどを利用して機微な情報を削除できる仕組みを取り入れておくこと
- iOSの場合、アプリケーションスナップショットを取らないようにしておくこと。
- アカウント番号など、ユーザに直接表示する必要のないデータはトークンなどで代用し、デバイス上に不必要な機微な情報は保管にしないようにすること。

### 6.5 有料コンテンツの保護（設計ガイドライン）
- ユーザが利用を否認しないよう、ログを保存しておくこと。（署名済みの利用申請など）
- アプリケーションの利用如何によって、課金が発生する旨をユーザに告知する
- 購入に関するデータは、改ざんされない仕組みを構築すること
- ホワイトリスト方式で、有料コンテンツを提供するようにする
- 例えば利用場所が突然全く異なる場所になったり、言語が明らかに変わった場合は再認証させるなどの仕組みを導入する

### 6.6 セッションマネジメント
- ユーザのログインステータスを、アプリケーションがアクティベート・画面遷移時でチェックする
- ユーザのセッションが切れた場合は、メモリを開放すること。
- サーバサイド側でセッションIDを無効化できるよう設計すること。
- 期限が切れたセッションを無効化するために、タイムアウト値は少なめに取っておいたほうが良い

### 6.7 サードパーティのライブラリやコードの使用について
- 信頼できるライブラリかどうか、事前にチェックを行うこと。社内で共有し、承認を取るように仕組み化しておくこと。
- 利用するフレームワークを、きちんと管理しておき、パッチや脆弱性情報を把握しておくこと
- アドネットワークなど、外部からのリソース提供（Javascript等）がある場合は、特に注意をはらい安全かどうかを事前に確認すること

### 6.8 プロビジョニング・配布・テストについて
- セキュリティパッチを提供できるよう仕組み化しておくこと
- セキュリティに関する問題がある古いバージョンのアプリケーションは、AppStoreなどから削除しておくこと
- 定期的にAPIの脆弱性テストを実施しておくこと。
- リリース前に、難読化処理が行われているか確認しておくこと
- 信頼されたCAから発行された証明書を利用し、アプリケーションに対して署名を行うこと
